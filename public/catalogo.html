<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catalogo Abbigliamento</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gradient-to-br from-blue-50 to-purple-100 min-h-screen py-8">
    <div class="container mx-auto px-4 max-w-6xl">
        <!-- Header -->
        <div class="bg-white rounded-xl shadow-lg p-8 mb-8 text-center">
            <img id="catalogLogo" src="" alt="Logo" class="h-20 mx-auto mb-4" style="display: none;">
            <h1 id="catalogTitle" class="text-4xl font-bold text-blue-700 mb-2">Catalogo</h1>
            <p id="catalogSubtitle" class="text-gray-600">Scopri la nostra collezione</p>
            
            <!-- Link catalogo completo (se presente) -->
            <div id="fullCatalogLink" style="display: none;" class="mt-4">
                <a href="" target="_blank" class="inline-flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-bold transition">
                    <i class="fas fa-file-pdf"></i>
                    Scarica Catalogo Completo PDF
                </a>
            </div>
            
            <!-- QR Code per ordini (se presente) -->
            <div id="qrCodeSection" style="display: none;" class="mt-6">
                <p class="text-sm text-gray-600 mb-2">Scansiona per ordinare:</p>
                <img id="qrCodeImage" src="" alt="QR Code Ordini" class="w-32 h-32 mx-auto border-2 border-gray-300 rounded">
            </div>
        </div>
        
        <!-- Placeholder (mostrato durante il caricamento) -->
        <div id="catalogPlaceholder" class="bg-white rounded-xl shadow-lg p-12 text-center">
            <div class="animate-pulse">
                <div class="h-24 w-24 bg-gray-200 rounded-full mx-auto mb-4"></div>
                <div class="h-4 bg-gray-200 rounded w-48 mx-auto mb-2"></div>
                <div class="h-4 bg-gray-200 rounded w-32 mx-auto"></div>
                <p class="text-gray-600 mt-4">Caricamento catalogo in corso...</p>
            </div>
        </div>
        
        <!-- Articoli -->
        <div id="catalogItems" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" style="display: none;">
            <!-- Gli articoli verranno inseriti qui da JavaScript -->
        </div>
        
        <!-- Messaggio nessun articolo -->
        <div id="noItemsMessage" class="bg-white rounded-xl shadow-lg p-12 text-center" style="display: none;">
            <div class="text-gray-400 mb-4">
                <i class="fas fa-box-open text-6xl"></i>
            </div>
            <p class="text-gray-600 font-bold text-lg">Nessun articolo disponibile</p>
            <p class="text-gray-500 text-sm mt-2">Il catalogo è attualmente vuoto</p>
        </div>
    </div>

    <script>
        // Carica i dati del catalogo da Redis
        async function loadCatalog() {
            try {
                const response = await fetch('/api/config');
                if (!response.ok) {
                    throw new Error(`Errore HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                if (!data.success || !data.data) {
                    throw new Error('Risposta API non valida');
                }
                
                const catalog = data.data.catalog || {};
                
                // Nascondi placeholder
                document.getElementById('catalogPlaceholder').style.display = 'none';
                
                // Aggiorna titolo e sottotitolo
                if (catalog.title) {
                    document.getElementById('catalogTitle').textContent = catalog.title;
                }
                
                // Mostra logo (se presente)
                if (catalog.logo && catalog.logo.trim() !== '') {
                    const logoImg = document.getElementById('catalogLogo');
                    logoImg.src = catalog.logo;
                    logoImg.style.display = 'block';
                }
                
                // Mostra link catalogo completo (se presente)
                if (catalog.fullCatalogUrl && catalog.fullCatalogUrl.trim() !== '') {
                    const linkSection = document.getElementById('fullCatalogLink');
                    const link = linkSection.querySelector('a');
                    link.href = catalog.fullCatalogUrl;
                    linkSection.style.display = 'block';
                }
                
                // Mostra QR Code (se presente)
                if (catalog.qrUrl && catalog.qrUrl.trim() !== '') {
                    const qrSection = document.getElementById('qrCodeSection');
                    const qrImg = document.getElementById('qrCodeImage');
                    qrImg.src = catalog.qrUrl;
                    qrSection.style.display = 'block';
                }
                
                // Renderizza articoli
                const container = document.getElementById('catalogItems');
                const noItemsMsg = document.getElementById('noItemsMessage');
                
                if (catalog.items && catalog.items.length > 0) {
                    container.style.display = 'grid';
                    container.innerHTML = '';
                    
                    catalog.items.forEach(item => {
                        const card = document.createElement('div');
                        card.className = 'bg-white rounded-lg shadow hover:shadow-xl transition transform hover:-translate-y-1 overflow-hidden';
                        
                        card.innerHTML = `
                            <div class="aspect-square bg-gradient-to-br from-blue-50 to-purple-50 flex items-center justify-center p-8">
                                ${item.image ? 
                                    `<img src="${item.image}" alt="${item.name}" class="w-full h-full object-contain">` :
                                    `<svg class="w-20 h-20 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M3 1a1 1 0 000 2h1.22l.305 1.222a.997.997 0 00.01.042l1.358 5.43-.893.892C3.74 11.846 4.632 14 6.414 14H15a1 1 0 000-2H6.414l1-1H14a1 1 0 00.894-.553l3-6A1 1 0 0017 3H6.28l-.31-1.243A1 1 0 005 1H3zM16 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM6.5 18a1.5 1.5 0 100-3 1.5 1.5 0 000 3z"/>
                                    </svg>`
                                }
                            </div>
                            <div class="p-4">
                                <h3 class="font-bold text-gray-900 text-lg mb-2 line-clamp-2">${escapeHtml(item.name)}</h3>
                                ${item.description ? 
                                    `<p class="text-sm text-gray-600 mb-3 line-clamp-3">${escapeHtml(item.description)}</p>` : 
                                    ''
                                }
                                <div class="flex items-center justify-between">
                                    ${item.price ? 
                                        `<p class="text-xl font-bold text-blue-600">€ ${item.price}</p>` : 
                                        '<span></span>'
                                    }
                                    ${item.link ? 
                                        `<a href="${escapeHtml(item.link)}" target="_blank" rel="noopener noreferrer" class="text-blue-500 hover:text-blue-700 text-sm font-medium flex items-center gap-1">
                                            Dettagli <i class="fas fa-arrow-right"></i>
                                        </a>` : 
                                        ''
                                    }
                                </div>
                            </div>
                        `;
                        
                        container.appendChild(card);
                    });
                } else {
                    // Nessun articolo
                    noItemsMsg.style.display = 'block';
                }
                
            } catch (error) {
                console.error('❌ Errore caricamento catalogo:', error);
                document.getElementById('catalogPlaceholder').innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-red-500 mb-4">
                            <i class="fas fa-exclamation-triangle text-6xl"></i>
                        </div>
                        <p class="text-red-600 font-bold text-lg mb-2">Errore nel caricamento del catalogo</p>
                        <p class="text-gray-600 text-sm">${error.message}</p>
                        <button onclick="loadCatalog()" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-bold transition">
                            <i class="fas fa-redo mr-2"></i>Riprova
                        </button>
                    </div>
                `;
            }
        }
        
        // Funzione helper per escape HTML (prevenzione XSS)
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Carica il catalogo all'avvio
        window.addEventListener('DOMContentLoaded', loadCatalog);
    </script>
    
    <!-- Utility CSS per limitare righe di testo -->
    <style>
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .line-clamp-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
</body>
</html>