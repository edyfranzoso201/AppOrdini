<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OrderFlow Pro - Sistema Gestione Ordini</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { font-family: Arial, 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
        body { overflow: hidden; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); } 
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideIn { from { transform: translateX(-20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .tab-content { display: none; height: calc(100vh - 100px); overflow-y: auto; animation: fadeIn 0.3s ease-out; }
        .tab-content.active { display: block; }
        .glass-effect { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); }
        .btn-gradient { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); transition: all 0.3s ease; }
        .btn-gradient:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4); }
        .card-shadow { box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07); transition: all 0.3s ease; }
        .card-shadow:hover { box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15); transform: translateY(-2px); }
        .sticky-header th { position: sticky; top: 0; z-index: 20; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
        .sticky-col { position: sticky; left: 0; z-index: 30; background-color: #fff; border-right: 2px solid #e5e7eb; padding: 2px 0 !important; text-align: center !important; vertical-align: middle !important; width: 55px !important; min-width: 55px !important; max-width: 55px !important; font-size: 0.7rem !important; line-height: 1.2 !important; }
        .vertical-header { writing-mode: vertical-rl; transform: rotate(180deg); white-space: pre-wrap; height: 110px; padding: 0px !important; font-size: 0.65rem; line-height: 1.1; font-weight: 700; display: flex; align-items: center; justify-content: center; text-align: center; max-height: 110px; overflow: hidden; }
        .total-col { background-color: #1e3a8a; color: white; font-weight: bold; }
        .total-row td { background-color: #e5e7eb; font-weight: 800; border-top: 2px solid #6b7280; color: #111827; }
        
        /* FORZA padding zero su tutte le celle delle tabelle */
        #grossTable td, #invClothingTable td, #netTable td,
        #invSocksTable td, #netSocksTable td {
            padding: 0 !important;
        }
        
        /* FORZA centratura TAGLIA */
        #grossTable th:first-child, #invClothingTable th:first-child, #netTable th:first-child {
            padding: 0 !important;
            text-align: center !important;
            vertical-align: middle !important;
        }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(4px); animation: fadeIn 0.2s ease-out; }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        .inv-input { width: 100%; text-align: center; border: 1px solid #fcd34d; background-color: #fffbeb; border-radius: 4px; font-weight: bold; }
        .net-val { font-weight: 800; font-size: 1.1rem; }
        .buy-alert { color: #dc2626; } 
        .buy-ok { color: #d1d5db; font-weight: normal; font-size: 0.8rem; }
        
        /* Note colors */
        .note-default { background-color: white !important; }
        .note-yellow { background-color: #fef3c7 !important; border-color: #fbbf24 !important; }
        .note-green { background-color: #d1fae5 !important; border-color: #10b981 !important; }
        .note-blue { background-color: #dbeafe !important; border-color: #3b82f6 !important; }
        .note-red { background-color: #fee2e2 !important; border-color: #ef4444 !important; }
        .note-orange { background-color: #fed7aa !important; border-color: #f97316 !important; }
        .note-purple { background-color: #e9d5ff !important; border-color: #a855f7 !important; }
        .note-pink { background-color: #fce7f3 !important; border-color: #ec4899 !important; }
        
        .note-color-btn { cursor: pointer; }
        .note-color-btn.selected { border-color: #2563eb !important; border-width: 3px; box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2); }
        
        .note-cell { position: relative; cursor: pointer; }
        .note-cell:hover { transform: scale(1.02); transition: all 0.2s; }
        .section-title { font-size: 1rem; font-weight: bold; padding-bottom: 0.5rem; margin-bottom: 0.5rem; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; }
        .discount-input { width: 50px; font-size: 0.7rem; border: 1px solid #ccc; text-align: right; padding-right: 2px; color: #dc2626; }
        .price-display { font-weight: bold; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .gradient-text { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        table tbody tr { transition: all 0.2s ease; }
        table tbody tr:hover { background-color: #f9fafb !important; transform: scale(1.001); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); transition: all 0.2s ease; }
        button { transition: all 0.2s ease; }
        button:active { transform: scale(0.98); }
        .live-clock { font-family: 'Courier New', Courier, monospace; font-weight: bold; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; padding: 6px 12px; border: 2px solid; border-image: linear-gradient(135deg, #667eea 0%, #764ba2 100%) 1; border-radius: 8px; font-size: 0.9rem; }
        .supplier-info { font-size: 0.75rem; font-weight: normal; margin-left: 10px; background-color: #dbeafe; color: #1e40af; padding: 2px 6px; border-radius: 4px; border: 1px solid #93c5fd; }
        .duplicate-highlight { background-color: #fdf4ff; color: #86198f; font-weight: 800; border: 2px solid #f0abfc; border-radius: 4px; padding: 2px 4px; }
        .size-section-row { padding: 2px 0 !important; line-height: 1.2 !important; font-size: 0.7rem !important; height: auto !important; }
        
        /* Stili per celle taglia evidenziabili */
        .size-cell-clickable { cursor: pointer; transition: all 0.2s ease; user-select: none; }
        .size-cell-clickable:hover { background-color: #d1fae5 !important; opacity: 0.7; }
        .size-cell-highlighted { background-color: #10b981 !important; color: white !important; font-weight: bold; }
        
        /* Stili Catalogo */
        .catalog-item-card { background: white; border: 2px solid #e5e7eb; border-radius: 12px; overflow: hidden; transition: all 0.3s ease; }
        .catalog-item-card:hover { border-color: #3b82f6; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15); }
        .catalog-item-images { display: flex; gap: 4px; background: #f3f4f6; min-height: 120px; align-items: center; justify-content: center; }
        .catalog-item-images img { max-height: 120px; object-fit: contain; cursor: pointer; transition: transform 0.2s; }
        .catalog-item-images img:hover { transform: scale(1.05); }
        .catalog-item-placeholder { color: #9ca3af; text-align: center; padding: 20px; font-size: 0.9rem; }
        .catalog-image-lightbox { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; display: flex; align-items: center; justify-content: center; cursor: zoom-out; }
        .catalog-image-lightbox img { max-width: 90%; max-height: 90%; object-fit: contain; }
        
        /* Colonne fisse tabella ordini */
        .tabella-ordini-sticky-col-1 { 
            position: sticky !important; 
            left: 0 !important; 
            z-index: 10 !important; 
            background-color: #fff !important;
            box-shadow: 2px 0 4px rgba(0,0,0,0.1);
        }
        .tabella-ordini-sticky-col-2 { 
            position: sticky !important; 
            left: 60px !important; 
            z-index: 10 !important; 
            background-color: #fff !important;
            box-shadow: 2px 0 4px rgba(0,0,0,0.1);
        }
        .tabella-ordini-sticky-header-1 {
            position: sticky !important;
            left: 0 !important;
            z-index: 30 !important;
            background-color: #e5e7eb !important;
        }
        .tabella-ordini-sticky-header-2 {
            position: sticky !important;
            left: 60px !important;
            z-index: 30 !important;
            background-color: #e5e7eb !important;
        }
        
        /* Stili tabella ordini stampabile */
        #tabellaOrdiniStampabile { font-size: 10px; border: 1px solid #000; table-layout: auto; }
        #tabellaOrdiniStampabile th { font-weight: bold; text-align: center; white-space: normal; padding: 4px; border: 1px solid #333; }
        #tabellaOrdiniStampabile td { padding: 4px 2px; text-align: center; border: 1px solid #ddd; }
        #tabellaOrdiniStampabile thead tr:first-child th { vertical-align: middle; }
        
        /* Header fisso per tabella ordini - TUTTO GRIGIO */
        #tabellaOrdiniStampabile thead th {
            position: sticky !important;
            background-color: #e5e7eb !important;
            color: #000 !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        /* Prima riga (nomi articoli) - sticky top */
        #tabellaOrdiniStampabile thead tr:first-child th {
            top: 0 !important;
            z-index: 103 !important;
        }
        
        /* Seconda riga (totali) - sticky sotto la prima - TUTTE LE CELLE */
        #tabellaOrdiniStampabile thead tr:nth-child(2) th {
            top: 70px !important; /* Perfetto equilibrio */
            z-index: 102 !important;
            position: sticky !important;
            background-color: #e5e7eb !important;
        }
        
        /* Colonne sticky: ID Ordine (prima colonna) - CORPO */
        #tabellaOrdiniStampabile tbody td:first-child,
        #tabellaOrdiniStampabile .tabella-ordini-sticky-col-1 {
            position: sticky !important;
            left: 0 !important;
            z-index: 50 !important;
            background-color: #f3f4f6 !important;
            box-shadow: 2px 0 4px rgba(0, 0, 0, 0.1);
            min-width: 140px !important;
            max-width: 140px !important;
            width: 140px !important;
            white-space: nowrap !important;
        }
        
        /* Colonne sticky: Cliente (seconda colonna) - CORPO */
        #tabellaOrdiniStampabile tbody td:nth-child(2),
        #tabellaOrdiniStampabile .tabella-ordini-sticky-col-2 {
            position: sticky !important;
            left: 140px !important;
            z-index: 50 !important;
            background-color: #f3f4f6 !important;
            box-shadow: 2px 0 4px rgba(0, 0, 0, 0.1);
        }
        
        /* HEADER sticky per colonna ID - PRIMA RIGA (rowspan=2, copre anche seconda riga) */
        #tabellaOrdiniStampabile thead tr:first-child th:first-child,
        #tabellaOrdiniStampabile .tabella-ordini-sticky-header-1 {
            position: sticky !important;
            left: 0 !important;
            top: 0 !important;
            z-index: 110 !important;
        }
        
        /* HEADER sticky per colonna Cliente - PRIMA RIGA (rowspan=2, copre anche seconda riga) */
        #tabellaOrdiniStampabile thead tr:first-child th:nth-child(2),
        #tabellaOrdiniStampabile .tabella-ordini-sticky-header-2 {
            position: sticky !important;
            left: 140px !important;
            top: 0 !important;
            z-index: 110 !important;
        }
        
        /* Assicura che il contenitore abbia overflow */
        #tab-tabella-ordini .overflow-auto {
            position: relative;
        }
        @media print {
            @page { size: A3 landscape; margin: 2mm !important; }
            .no-print { display: none !important; }
            .hide-in-print { display: none !important; }
            html, body { 
                margin: 0 !important; 
                padding: 0 !important;
                width: 100% !important;
                height: auto !important;
                overflow: visible !important;
            }
            #tab-tabella-ordini {
                overflow: visible !important;
                height: auto !important;
            }
            #tab-tabella-ordini > div {
                overflow: visible !important;
                height: auto !important;
            }
            #tab-tabella-ordini > div > div:last-child {
                overflow: visible !important;
                height: auto !important;
            }
            #tabellaOrdiniStampabile { 
                font-size: 4px !important; 
                width: 100% !important; 
                border: 0.3px solid #000 !important;
                page-break-inside: auto !important;
                overflow: visible !important;
                table-layout: fixed !important;
                border-collapse: collapse !important;
            }
            #tabellaOrdiniStampabile th, #tabellaOrdiniStampabile td { 
                padding: 0px !important; 
                border: 0.2px solid #666 !important;
                font-size: 4px !important;
                overflow: hidden !important;
                text-overflow: clip !important;
                line-height: 1 !important;
                max-width: 40px !important;
                word-break: break-all !important;
            }
            
            /* PARTE 1: Nascondi articoli della seconda met√† */
            #tabellaOrdiniStampabile.print-part-1 .print-show-part-2 {
                display: none !important;
                visibility: hidden !important;
            }
            
            /* PARTE 2: Nascondi colonne fisse 4-8 e articoli della prima met√† */
            #tabellaOrdiniStampabile.print-part-2 th:nth-child(4),
            #tabellaOrdiniStampabile.print-part-2 td:nth-child(4),
            #tabellaOrdiniStampabile.print-part-2 th:nth-child(5),
            #tabellaOrdiniStampabile.print-part-2 td:nth-child(5),
            #tabellaOrdiniStampabile.print-part-2 th:nth-child(6),
            #tabellaOrdiniStampabile.print-part-2 td:nth-child(6),
            #tabellaOrdiniStampabile.print-part-2 th:nth-child(7),
            #tabellaOrdiniStampabile.print-part-2 td:nth-child(7),
            #tabellaOrdiniStampabile.print-part-2 th:nth-child(8),
            #tabellaOrdiniStampabile.print-part-2 td:nth-child(8) {
                display: none !important;
                visibility: hidden !important;
            }
            
            #tabellaOrdiniStampabile.print-part-2 .print-show-part-1 {
                display: none !important;
                visibility: hidden !important;
            }
            
            #tabellaOrdiniStampabile thead { 
                display: table-header-group !important;
            }
            #tabellaOrdiniStampabile thead tr:first-child th { 
                font-size: 4px !important; 
                font-weight: bold !important; 
                background-color: #e8e8e8 !important; 
                color: #000 !important; 
                -webkit-print-color-adjust: exact !important; 
                print-color-adjust: exact !important;
                page-break-inside: avoid !important;
                page-break-after: avoid !important;
                padding: 0px !important;
                overflow: hidden !important;
                line-height: 1 !important;
            }
            #tabellaOrdiniStampabile thead tr:nth-child(2) th { 
                font-size: 4px !important; 
                background-color: #f0f0f0 !important; 
                color: #000 !important; 
                -webkit-print-color-adjust: exact !important; 
                print-color-adjust: exact !important;
                page-break-inside: avoid !important;
                page-break-after: avoid !important;
                padding: 0px !important;
                line-height: 1 !important;
            }
            #tabellaOrdiniStampabile tbody { 
                display: table-row-group !important;
            }
            #tabellaOrdiniStampabile tbody tr { 
                page-break-inside: avoid !important;
                page-break-after: auto !important;
            }
            #tabellaOrdiniStampabile tbody tr:nth-child(even) { 
                background-color: #fafafa !important; 
                -webkit-print-color-adjust: exact !important; 
                print-color-adjust: exact !important; 
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans h-screen flex flex-col">

    <!-- SCHERMATA LOGIN -->
    <div id="loginScreen" class="fixed inset-0 bg-gradient-to-br from-blue-900 to-blue-700 flex items-center justify-center z-[9999]">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-6">
                <div class="bg-blue-900 text-white p-4 rounded-full inline-block mb-4">
                    <i class="fas fa-boxes text-4xl"></i>
                </div>
                <h1 class="text-3xl font-bold text-blue-900 mb-2">OrderFlow</h1>
                <p class="text-gray-600">Inventory & Filters System</p>
            </div>
            
            <div id="loginForm">
                <div class="mb-4">
                    <label class="block text-sm font-bold text-gray-700 mb-2">Username</label>
                    <input type="text" id="loginUsername" class="w-full border rounded px-3 py-2" placeholder="Inserisci username">
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-bold text-gray-700 mb-2">Password</label>
                    <input type="password" id="loginPassword" class="w-full border rounded px-3 py-2" placeholder="Inserisci password">
                </div>
                <button id="loginButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-lg font-bold transition">
                    <i class="fas fa-sign-in-alt mr-2"></i>Accedi
                </button>
                <div id="loginError" class="mt-4 text-red-600 text-sm text-center hidden"></div>
            </div>
        </div>
    </div>

    <header class="bg-white shadow-md h-16 flex-none z-50 relative flex justify-between items-center px-6">
        <div class="flex items-center gap-3">
            <div class="bg-blue-900 text-white p-2 rounded-lg"><i class="fas fa-boxes text-xl"></i></div>
            <h1 class="text-xl font-bold text-blue-900">OrderFlow <span class="text-sm font-normal text-gray-500">R68</span></h1>
            <span id="userBadge" class="hidden ml-2 bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full text-[10px] font-bold"></span>
        </div>

        <nav class="flex bg-gray-100 p-1 rounded-lg">
            <button onclick="showTab('ordini')" id="nav-ordini" class="px-3 py-1.5 rounded-md text-xs font-medium transition bg-blue-900 text-white shadow">Gestione</button>
            <button onclick="showTab('matrix')" id="nav-matrix" class="px-3 py-1.5 rounded-md text-xs font-medium transition text-gray-600 hover:bg-gray-200">Distinta</button>
            <button onclick="showTab('tabella-ordini')" id="nav-tabella-ordini" class="px-3 py-1.5 rounded-md text-xs font-medium transition text-gray-600 hover:bg-gray-200">Tabella</button>
            <button onclick="showTab('dashboard')" id="nav-dashboard" class="px-3 py-1.5 rounded-md text-xs font-medium transition text-gray-600 hover:bg-gray-200">Dashboard</button>
            <button onclick="showTab('catalogo')" id="nav-catalogo" class="px-3 py-1.5 rounded-md text-xs font-medium transition text-gray-600 hover:bg-gray-200 hidden"><i class="fas fa-book-open mr-1"></i>Catalogo</button>
        </nav>

        <div class="flex gap-1 items-center">
            <button onclick="openUserManagement()" id="btnUserManagement" class="bg-indigo-600 hover:bg-indigo-700 text-white px-2 py-1.5 rounded text-xs font-bold shadow transition hidden">
                <i class="fas fa-users"></i>
            </button>
            <button onclick="openActivityLog()" id="btnViewLog" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-bold hidden">
                <i class="fas fa-history mr-2"></i>Visualizza LOG (20 azioni)
            </button>
            <button onclick="logout()" class="bg-gray-600 hover:bg-gray-700 text-white px-2 py-1.5 rounded text-xs font-bold shadow transition">
                <i class="fas fa-sign-out-alt"></i>
            </button>
            <button onclick="clearAllOrders()" id="btnReset" class="bg-red-600 hover:bg-red-700 text-white px-2 py-1.5 rounded text-xs font-bold shadow transition"><i class="fas fa-eraser"></i></button>
             <button onclick="addNewOrder()" id="btnNuovo" class="bg-blue-600 hover:bg-blue-700 text-white px-2 py-1.5 rounded text-xs font-bold shadow transition"><i class="fas fa-plus"></i></button>
             <button onclick="importFromGoogleSheet()" id="btnImportGoogle" class="bg-purple-600 hover:bg-purple-700 text-white px-2 py-1.5 rounded text-xs font-bold shadow transition" title="Importa da Google"><i class="fas fa-cloud-download-alt"></i></button>
             <button onclick="exportBackup()" id="btnExportBackup" class="bg-teal-700 hover:bg-teal-800 text-white px-2 py-1.5 rounded text-xs font-bold shadow transition" title="Esporta Backup"><i class="fas fa-download"></i></button>
            <div class="flex items-center gap-1" id="importExcelContainer">
                <input type="file" id="fileInput" class="hidden" accept=".xlsx, .csv">
                <label for="fileInput" class="bg-green-600 hover:bg-green-700 text-white px-2 py-1.5 rounded text-xs font-bold cursor-pointer shadow transition" title="Importa Excel"><i class="fas fa-file-excel"></i></label>
                <div class="flex items-center gap-1 bg-gray-100 p-1 rounded border border-gray-300" id="prefixContainer">
                    <label for="startPrefixInput" class="text-[10px] font-medium text-gray-600">ID:</label>
                    <input type="text" id="startPrefixInput" onblur="updatePrefixAndID()" placeholder="2026A_1" class="text-xs border rounded px-1 py-0.5 w-20 text-right outline-none focus:ring-1 focus:ring-blue-500">
                </div>
            </div>
        </div>
    </header>

    <main class="flex-grow relative px-4 pt-4 pb-0">
        <div id="tab-ordini" class="tab-content active">
            <div class="bg-white rounded shadow overflow-hidden h-full flex flex-col">
                <div class="p-3 border-b bg-gray-50 flex flex-col gap-2">
                    <h2 class="font-bold text-blue-900 text-sm">Filtri & Ricerca</h2>
                    <div id="filtersContainer" class="flex gap-2 flex-wrap">
                        <input type="text" id="searchInput" onkeyup="renderTable()" placeholder="Cerca Cliente..." class="text-sm border rounded px-3 py-1 w-48">
                        <select id="sortOrder" onchange="renderTable()" class="text-sm border rounded px-2 font-bold bg-gray-50 text-blue-900">
                            <option value="asc">ID Crescente (1..10)</option>
                            <option value="desc">ID Decrescente (10..1)</option>
                        </select>
                        <select id="filterStatus" onchange="renderTable()" class="text-sm border rounded px-2">
                             <option value="all">Stato: Tutti</option><option value="Nuovo">Nuovo</option><option value="In Lavorazione">In Lavorazione</option><option value="Pagato">Pagato</option><option value="Ordine Arrivato">Arrivato</option><option value="Consegna Parziale">Consegna Parziale</option><option value="Consegnato">Consegnato</option><option value="Scomposto">Scomposto</option><option value="Ordine annullato">Annullato</option><option value="Ordine trasferito ad altro ID">Trasferito</option><option value="Da piazzare">Da piazzare</option>
                        </select>
                        <input type="text" id="filterRoleYear" onkeyup="renderTable()" placeholder="Anno/Ruolo..." class="text-sm border rounded px-3 py-1 w-32">
                        <select id="filterSize" onchange="renderTable()" class="text-sm border rounded px-2">
                            <option value="all">Taglia: Tutte</option>
                        </select>
                        <select id="filterKitType" onchange="renderTable()" class="text-sm border rounded px-2"></select>
                        <select id="filterItem" onchange="renderTable()" class="text-sm border rounded px-2 bg-purple-50 border-purple-300 font-medium">
                            <option value="all">üîç Cerca Capo...</option>
                        </select>
                        
                        <div class="h-6 w-px bg-gray-300"></div>
                        
                        <!-- Filtri ID Min/Max -->
                        <span class="text-xs font-bold text-gray-600">ID:</span>
                        <select id="filterMinId" class="text-xs border rounded px-2 py-1 w-28 text-center font-bold bg-white" onchange="renderTable()"></select>
                        <span class="text-xs text-gray-400">‚Üí</span>
                        <select id="filterMaxId" class="text-xs border rounded px-2 py-1 w-28 text-center font-bold bg-white" onchange="renderTable()"></select>
                        
                        <div class="h-6 w-px bg-gray-300"></div>
                        
                        <!-- Pulsanti Quick Filter ID -->
                        <span class="text-xs font-bold text-gray-600">Quick ID:</span>
                        <div class="flex items-center gap-1" id="quickIdButtons">
                            <!-- Pulsanti generati dinamicamente -->
                        </div>
                        <button onclick="openQuickIdConfig()" class="bg-gray-500 hover:bg-gray-600 text-white px-2 py-1 rounded text-xs font-bold transition" title="Configura intervalli ID rapidi">
                            <i class="fas fa-cog"></i>
                        </button>
                        <button onclick="resetAllIdFilters()" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs font-bold transition" title="Reset filtri ID">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div class="overflow-auto flex-grow">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky-header">
                             <tr>
                                <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase w-48">ID</th>
                                <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase w-40">Cliente</th>
                                <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase w-24">Anno/Ruolo</th>
                                <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase w-40">Tipo Ordine (Kit)</th>
                                <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase w-32">Note</th>
                                <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase">Contenuto Ordine</th>
                                <th class="px-4 py-3 text-center text-xs font-bold text-gray-500 uppercase w-16">Taglia</th>
                                <th class="px-4 py-3 text-center text-xs font-bold text-gray-500 uppercase w-16">Calze</th>
                                <th class="px-4 py-3 text-center text-xs font-bold text-gray-500 uppercase w-20">Bag/Zaino</th>
                                <th class="px-4 py-3 text-center text-xs font-bold text-gray-500 uppercase w-24">Totale ‚Ç¨</th>
                                <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase w-32">Stato</th>
                                <th class="px-4 py-3 text-center w-8"><i class="fas fa-download"></i></th>
                                <th class="px-4 py-3 text-center w-8"><i class="fas fa-cog"></i></th>
                                <th class="px-4 py-3 text-center w-8"><i class="fas fa-trash"></i></th> 
                            </tr>
                        </thead>
                        <tbody id="tableBody" class="divide-y divide-gray-200 bg-white"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tab-matrix" class="tab-content">
            <div class="flex flex-col gap-3 h-full">
                <div class="bg-white p-2 rounded shadow border-b flex justify-between items-center gap-4 flex-wrap flex-none">
                    <div class="flex items-center gap-4">
                        <div><h2 class="font-bold text-lg text-blue-900">Distinta & Magazzino</h2><p class="text-xs text-gray-500">Flusso: Richiesta -> Magazzino -> Ordine Fornitore</p></div>
                        <div id="liveClock" class="live-clock hidden md:block">--:--:--</div>
                        
                        <div class="h-6 w-px bg-gray-300"></div>
                        
                        <div class="flex items-center gap-2 bg-gray-50 p-2 rounded border">
                             <span class="text-xs font-bold text-gray-600">Filtra:</span>
                            <select id="matrixMinId" class="text-xs border rounded px-2 py-1 w-28 text-center font-bold bg-white"></select>
                            <span class="text-xs text-gray-400">a</span>
                            <select id="matrixMaxId" class="text-xs border rounded px-2 py-1 w-28 text-center font-bold bg-white"></select>
                            <button onclick="renderMatrices(true)" class="bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded text-xs font-bold transition"><i class="fas fa-sync-alt"></i></button>
                        </div>
                        
                        <!-- Quick ID Buttons -->
                        <div class="flex items-center gap-1">
                            <span class="text-xs font-bold text-gray-600">Quick:</span>
                            <div class="flex items-center gap-1" id="quickIdButtonsMatrix"></div>
                            <button onclick="openQuickIdConfig()" class="bg-gray-500 hover:bg-gray-600 text-white px-1.5 py-1 rounded text-xs font-bold transition" title="Configura Quick ID">
                                <i class="fas fa-cog"></i>
                            </button>
                            <button onclick="resetAllIdFilters()" class="bg-red-500 hover:bg-red-600 text-white px-1.5 py-1 rounded text-xs font-bold transition" title="Reset filtri ID">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-2">
                        <button onclick="openKitConfigModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-2 py-1 rounded text-xs font-bold transition"><i class="fas fa-tshirt mr-1"></i> KIT</button>
                        <button onclick="openSettingsModal()" class="bg-gray-600 hover:bg-gray-700 text-white px-2 py-1 rounded text-xs font-bold transition"><i class="fas fa-cog mr-1"></i> DB</button>
                        <button onclick="applyInventoryToOrders()" class="bg-orange-600 hover:bg-orange-700 text-white px-2 py-1 rounded text-xs font-bold transition" title="Scala il magazzino dagli ordini NUOVI nel range selezionato">
                            <i class="fas fa-box-open mr-1"></i> Scala
                        </button>
                        <button onclick="exportMatrix()" class="bg-green-600 hover:bg-green-700 text-white px-2 py-1 rounded text-xs font-bold transition shadow"><i class="fas fa-file-excel mr-1"></i> Excel</button>
                    </div>
                </div>

                <div class="flex-grow overflow-auto pr-2 pb-0">
                    <div class="bg-white rounded shadow px-2 pt-2 pb-0 mb-3">
                        <div class="flex justify-between items-center mb-2">
                            <div class="section-title text-blue-900 mb-0">
                                <span><i class="fas fa-list-alt mr-2"></i> 1. Riepilogo Richieste Totali (Lordo)</span>
                            </div>
                            <button onclick="openTableFullscreen('gross')" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs font-bold transition shadow-md" title="Apri a schermo intero">
                                <i class="fas fa-expand mr-1"></i> Espandi
                            </button>
                        </div>
                        <table class="min-w-full divide-y divide-gray-200 text-xs border mb-0" id="grossTable"><thead class="bg-blue-50 sticky-header" id="grossHeader"></thead><tbody id="grossBody" class="divide-y divide-gray-200"></tbody></table>
                    </div>
                    <div class="bg-white rounded shadow px-2 pt-2 pb-0 mb-3 border-l-4 border-yellow-400">
                         <div class="flex justify-between items-center mb-2">
                            <div class="section-title text-yellow-800 mb-0">
                                <span><i class="fas fa-warehouse mr-2"></i> 2. Magazzino (Giacenze)</span>
                            </div>
                            <button onclick="openTableFullscreen('inv')" class="bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded text-xs font-bold transition shadow-md" title="Apri a schermo intero">
                                <i class="fas fa-expand mr-1"></i> Espandi
                            </button>
                        </div>
                        <table class="min-w-full divide-y divide-gray-200 text-xs border mb-0" id="invClothingTable"><thead class="bg-yellow-50 sticky-header" id="invClothingHeader"></thead><tbody id="invClothingBody" class="divide-y divide-gray-200"></tbody></table>
                    </div>
                    
                    <div class="bg-white rounded shadow px-2 pt-2 pb-0 mb-3 border-l-4 border-red-600">
                         <div class="flex justify-between items-center mb-2">
                            <div class="section-title text-red-800 mb-0" id="title-net-clothing">
                                <span><i class="fas fa-shopping-cart mr-2"></i> 3. Ordine Fornitore (Netto)</span>
                            </div>
                            <button onclick="openTableFullscreen('net')" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-xs font-bold transition shadow-md" title="Apri a schermo intero">
                                <i class="fas fa-expand mr-1"></i> Espandi
                            </button>
                         </div>
                        <table class="min-w-full divide-y divide-gray-200 text-xs border mb-0" id="netTable"><thead class="bg-gray-100 sticky-header" id="netHeader"></thead><tbody id="netBody" class="divide-y divide-gray-200"></tbody></table>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white rounded shadow p-4 border-l-4 border-yellow-400">
                             <h3 class="font-bold text-yellow-700 mb-2 border-b pb-1 flex justify-between items-center">
                                <span>Inventario Calze</span>
                                <button onclick="openTableFullscreen('invSocks')" class="bg-yellow-600 hover:bg-yellow-700 text-white px-2 py-1 rounded text-xs font-bold transition" title="Apri a schermo intero">
                                    <i class="fas fa-expand mr-1"></i> Espandi
                                </button>
                             </h3>
                            <table class="min-w-full divide-y divide-gray-200 text-sm border" id="invSocksTable">
                                <thead class="bg-yellow-50 sticky-header">
                                     <tr>
                                        <th class="px-2 py-2 text-center font-bold text-gray-700 w-16 bg-yellow-50">TAGLIA</th>
                                         <th class="px-2 py-2 text-center font-bold text-blue-800 bg-blue-50 text-xs border-l" id="headerSockBlue"></th>
                                        <th class="px-2 py-2 text-center font-bold text-red-800 bg-red-50 text-xs border-l" id="headerSockRed"></th>
                                        <th class="px-2 py-2 text-center font-bold text-blue-800 bg-blue-100 text-xs border-l" id="headerSockSpolfBlue"></th>
                                        <th class="px-2 py-2 text-center font-bold text-red-800 bg-red-100 text-xs border-l" id="headerSockSpolfRed"></th>
                                     </tr>
                                </thead>
                                <tbody id="invSocksBody" class="divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                        
                        <div class="bg-white rounded shadow p-4 border-l-4 border-red-600">
                            <h3 class="font-bold text-red-800 mb-2 border-b pb-1 flex justify-between items-center" id="title-net-socks">
                                <span>Calze da Ordinare (Netto)</span>
                                <button onclick="openTableFullscreen('netSocks')" class="bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded text-xs font-bold transition" title="Apri a schermo intero">
                                    <i class="fas fa-expand mr-1"></i> Espandi
                                </button>
                            </h3>
                            <table class="min-w-full divide-y divide-gray-200 text-sm border" id="netSocksTable">
                                <thead class="bg-gray-100 sticky-header">
                                    <tr>
                                         <th class="px-2 py-2 text-center font-bold text-gray-700 w-16 bg-gray-100">TAGLIA</th>
                                        <th class="px-2 py-2 text-center font-bold text-blue-800 bg-blue-50 text-xs border-l" id="headerSockNetBlue"></th>
                                         <th class="px-2 py-2 text-center font-bold text-red-800 bg-red-50 text-xs border-l" id="headerSockNetRed"></th>
                                        <th class="px-2 py-2 text-center font-bold text-blue-800 bg-blue-100 text-xs border-l" id="headerSockNetSpolfBlue"></th>
                                        <th class="px-2 py-2 text-center font-bold text-red-800 bg-red-100 text-xs border-l" id="headerSockNetSpolfRed"></th>
                                    </tr>
                                </thead>
                                <tbody id="netSocksBody" class="divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-dashboard" class="tab-content">
            <!-- Filtri Dashboard -->
            <div class="bg-white p-4 rounded shadow mb-6 border-2 border-blue-300">
                <div class="flex flex-wrap items-center gap-4">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-filter text-blue-600"></i>
                        <span class="text-sm font-bold text-blue-900">Filtri Dashboard:</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-sm font-bold text-gray-600">ID:</label>
                        <select id="dashboardMinId" onchange="renderChart(); renderKitAnalysis();" class="text-sm border-2 border-blue-300 rounded px-2 py-1 w-32 text-center font-bold bg-white"></select>
                        <span class="text-gray-400">‚Üí</span>
                        <select id="dashboardMaxId" onchange="renderChart(); renderKitAnalysis();" class="text-sm border-2 border-blue-300 rounded px-2 py-1 w-32 text-center font-bold bg-white"></select>
                    </div>
                    <button onclick="resetDashboardFilters()" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded text-xs font-bold transition" title="Reset filtri">
                        <i class="fas fa-undo mr-1"></i>Reset
                    </button>
                    <div class="flex items-center gap-1">
                        <span class="text-sm font-bold text-gray-600">Quick:</span>
                        <div class="flex items-center gap-1" id="quickIdButtonsDashboard"></div>
                        <button onclick="openQuickIdConfig()" class="bg-gray-500 hover:bg-gray-600 text-white px-2 py-1 rounded text-xs font-bold transition" title="Configura Quick ID">
                            <i class="fas fa-cog"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                <div class="bg-white p-6 rounded shadow border-l-4 border-blue-600">
                    <div class="text-gray-500 text-xs font-bold uppercase">Ordini Attivi</div>
                    <div class="text-3xl font-bold" id="dash-total">0</div>
                    <div class="text-xs text-gray-400 mt-1">Totale: <span id="dash-total-all" class="font-bold">0</span></div>
                </div>
                <div class="bg-white p-6 rounded shadow border-l-4 border-red-500"><div class="text-gray-500 text-xs font-bold uppercase">Capi Staff (Attivi)</div><div class="text-3xl font-bold" id="dash-staff-items">0</div></div>
                <div class="bg-white p-6 rounded shadow border-l-4 border-gray-800"><div class="text-gray-500 text-xs font-bold uppercase">Capi Termici (Attivi)</div><div class="text-3xl font-bold" id="dash-thermal-items">0</div></div>
                <div class="bg-white p-6 rounded shadow border-l-4 border-blue-400"><div class="text-gray-500 text-xs font-bold uppercase">Capi Giocatori (Attivi)</div><div class="text-3xl font-bold" id="dash-player-items">0</div></div>
             </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div class="bg-white p-6 rounded shadow border-l-4 border-indigo-600">
                    <div class="text-gray-500 text-xs font-bold uppercase">Totale Listino (Lordo)</div>
                    <div class="text-2xl font-bold text-indigo-900" id="dash-money-gross">0‚Ç¨</div>
                </div>
                <div class="bg-white p-6 rounded shadow border-l-4 border-red-500">
                     <div class="text-gray-500 text-xs font-bold uppercase">Totale Sconti</div>
                    <div class="text-2xl font-bold text-red-600" id="dash-money-discount">0‚Ç¨</div>
                </div>
                <div class="bg-white p-6 rounded shadow border-l-4 border-green-600">
                     <div class="text-gray-500 text-xs font-bold uppercase">Totale Netto (Incasso)</div>
                    <div class="text-2xl font-bold text-green-700" id="dash-money-net">0‚Ç¨</div>
                </div>
             </div>
             
            <div class="bg-purple-50 p-4 rounded shadow mb-6 border-2 border-purple-200">
                <div class="flex items-center gap-2 mb-3">
                    <i class="fas fa-filter text-purple-600"></i>
                    <h3 class="text-sm font-bold text-purple-900 uppercase">Totali Range ID Filtrato</h3>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="bg-white p-4 rounded shadow border-l-4 border-purple-600">
                        <div class="text-gray-500 text-xs font-bold uppercase">Range ID Selezionato</div>
                        <div class="text-lg font-bold text-purple-900" id="dash-filtered-range">Nessun filtro</div>
                    </div>
                    <div class="bg-white p-4 rounded shadow border-l-4 border-purple-600">
                        <div class="text-gray-500 text-xs font-bold uppercase">Ordini nel Range</div>
                        <div class="text-lg font-bold text-purple-900" id="dash-filtered-count">0</div>
                    </div>
                    <div class="bg-white p-4 rounded shadow border-l-4 border-indigo-600">
                        <div class="text-gray-500 text-xs font-bold uppercase">Costo Lordo (Range)</div>
                        <div class="text-xl font-bold text-indigo-900" id="dash-filtered-gross">0‚Ç¨</div>
                    </div>
                    <div class="bg-white p-4 rounded shadow border-l-4 border-green-600">
                        <div class="text-gray-500 text-xs font-bold uppercase">Costo Netto (Range)</div>
                        <div class="text-xl font-bold text-green-700" id="dash-filtered-net">0‚Ç¨</div>
                    </div>
                </div>
                
                <div class="bg-white p-4 rounded shadow border-l-4 border-orange-500">
                    <div class="text-gray-500 text-xs font-bold uppercase mb-3 flex items-center gap-2">
                        <i class="fas fa-boxes"></i>
                        Breakdown Ordini per Tipo
                    </div>
                    <div id="dash-filtered-breakdown" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 text-sm">
                        <div class="text-gray-400 italic col-span-full text-center">Seleziona un range ID per vedere il breakdown</div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="bg-white p-4 rounded shadow h-80 relative">
                    <h3 class="text-xs font-bold text-gray-500 uppercase mb-2 pl-2">Stato Ordini</h3>
                    <div class="h-64 w-full"><canvas id="chartStatus"></canvas></div>
                </div>
                <div class="bg-white p-4 rounded shadow h-80 relative">
                     <h3 class="text-xs font-bold text-gray-500 uppercase mb-2 pl-2">Analisi Finanziaria</h3>
                     <div class="h-64 w-full"><canvas id="chartRevenue"></canvas></div>
                </div>
            </div>
            
            <div class="bg-white p-4 rounded shadow h-[600px] relative mb-6">
                <h3 class="text-xs font-bold text-gray-500 uppercase mb-2 pl-2">Quantit√† per Tipologia Abbigliamento</h3>
                <div class="h-[550px] w-full"><canvas id="chartItems"></canvas></div>
             </div>
             
            <!-- NUOVA SEZIONE: Analisi per Tipo Kit -->
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded shadow mb-6 border-2 border-blue-200">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-box-open text-blue-600 text-xl"></i>
                        <h3 class="text-lg font-bold text-blue-900">Analisi per Tipo Kit</h3>
                    </div>
                    <div class="flex items-center gap-3">
                        <label class="text-sm font-bold text-gray-600">Filtra per Kit:</label>
                        <select id="dashboardKitFilter" onchange="renderKitAnalysis()" class="border-2 border-blue-300 rounded-lg px-3 py-2 text-sm font-bold bg-white min-w-[250px]">
                            <option value="all">üìä Tutti i Kit</option>
                        </select>
                    </div>
                </div>
                
                <!-- Riepilogo Kit -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                    <div class="bg-white p-4 rounded-lg shadow border-l-4 border-blue-600">
                        <div class="text-gray-500 text-xs font-bold uppercase">Kit Selezionati</div>
                        <div class="text-3xl font-bold text-blue-900" id="dash-kit-count">0</div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow border-l-4 border-indigo-600">
                        <div class="text-gray-500 text-xs font-bold uppercase">Totale Lordo</div>
                        <div class="text-2xl font-bold text-indigo-900" id="dash-kit-gross">0‚Ç¨</div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow border-l-4 border-red-500">
                        <div class="text-gray-500 text-xs font-bold uppercase">Totale Sconti</div>
                        <div class="text-2xl font-bold text-red-600" id="dash-kit-discount">0‚Ç¨</div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow border-l-4 border-green-600">
                        <div class="text-gray-500 text-xs font-bold uppercase">Totale Netto</div>
                        <div class="text-2xl font-bold text-green-700" id="dash-kit-net">0‚Ç¨</div>
                    </div>
                </div>
                
                <!-- Tabella Kit per Tipo -->
                <div class="bg-white p-4 rounded-lg shadow mb-4">
                    <h4 class="text-sm font-bold text-gray-700 mb-3 flex items-center gap-2">
                        <i class="fas fa-list-ol text-blue-600"></i>
                        Quantit√† Kit per Tipo
                    </h4>
                    <div id="dash-kit-breakdown" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                        <!-- Popolato da JavaScript -->
                    </div>
                </div>
                
                <!-- NUOVA: Distribuzione Taglie Kit -->
                <div class="bg-white p-4 rounded-lg shadow mb-4">
                    <h4 class="text-sm font-bold text-gray-700 mb-3 flex items-center gap-2">
                        <i class="fas fa-ruler text-purple-600"></i>
                        Distribuzione Taglie Kit
                    </h4>
                    <div id="dash-kit-sizes" class="flex flex-wrap gap-2">
                        <!-- Popolato da JavaScript -->
                    </div>
                </div>
                
                <!-- NUOVA: Tabella Capi per Taglia -->
                <div class="bg-white p-4 rounded-lg shadow mb-4">
                    <h4 class="text-sm font-bold text-gray-700 mb-3 flex items-center gap-2">
                        <i class="fas fa-table text-indigo-600"></i>
                        Dettaglio Capi per Taglia (Kit Filtrato)
                    </h4>
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-xs" id="dash-items-by-size-table">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-3 py-2 text-left font-bold text-gray-700">Capo</th>
                                    <!-- Colonne taglie aggiunte da JS -->
                                </tr>
                            </thead>
                            <tbody id="dash-items-by-size-body">
                                <!-- Popolato da JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Grafico Capi per Kit Filtrato -->
                <div class="bg-white p-4 rounded-lg shadow">
                    <h4 class="text-sm font-bold text-gray-700 mb-3 flex items-center gap-2">
                        <i class="fas fa-tshirt text-blue-600"></i>
                        Quantit√† Singoli Capi (Kit Filtrato)
                    </h4>
                    <div class="h-[400px] w-full"><canvas id="chartKitItems"></canvas></div>
                </div>
            </div>
        </div>

        <div id="tab-tabella-ordini" class="tab-content">
            <div class="bg-white rounded shadow p-4 h-full flex flex-col">
                <div class="flex justify-between items-center mb-4 no-print">
                    <h2 class="text-xl font-bold text-blue-900">Tabella Ordini Stampabile</h2>
                    <div class="flex items-center gap-3 flex-wrap">
                        <span class="text-sm font-bold text-gray-600">Filtra ID:</span>
                        <select id="tabellaOrdiniMinId" class="text-sm border rounded px-2 py-1 w-28 text-center font-bold bg-white"></select>
                        <span class="text-sm text-gray-400">a</span>
                        <select id="tabellaOrdiniMaxId" class="text-sm border rounded px-2 py-1 w-28 text-center font-bold bg-white"></select>
                        
                        <div class="h-6 w-px bg-gray-300"></div>
                        
                        <span class="text-sm font-bold text-gray-600">Cliente:</span>
                        <input type="text" id="tabellaOrdiniFilterCliente" placeholder="Cerca cliente..." class="text-sm border rounded px-2 py-1 w-40 bg-white" onkeyup="renderTabellaOrdini()">
                        
                        <span class="text-sm font-bold text-gray-600">Taglia:</span>
                        <select id="tabellaOrdiniFilterTaglia" class="text-sm border rounded px-2 py-1 w-20 text-center font-bold bg-white" onchange="renderTabellaOrdini()">
                            <option value="">Tutte</option>
                            <option value="4XS">4XS</option>
                            <option value="3XS">3XS</option>
                            <option value="2XS">2XS</option>
                            <option value="XS">XS</option>
                            <option value="S">S</option>
                            <option value="M">M</option>
                            <option value="L">L</option>
                            <option value="XL">XL</option>
                            <option value="2XL">2XL</option>
                            <option value="3XL">3XL</option>
                            <option value="4XL">4XL</option>
                        </select>
                        
                        <button onclick="renderTabellaOrdini()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm font-bold transition">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        
                        <div class="h-6 w-px bg-gray-300"></div>
                        
                        <!-- Quick ID Buttons -->
                        <span class="text-sm font-bold text-gray-600">Quick:</span>
                        <div class="flex items-center gap-1" id="quickIdButtonsTabella"></div>
                        <button onclick="openQuickIdConfig()" class="bg-gray-500 hover:bg-gray-600 text-white px-2 py-1 rounded text-xs font-bold transition" title="Configura Quick ID">
                            <i class="fas fa-cog"></i>
                        </button>
                        <button onclick="resetAllIdFilters()" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs font-bold transition" title="Reset filtri ID">
                            <i class="fas fa-times"></i>
                        </button>
                        
                        <div class="h-6 w-px bg-gray-300"></div>
                        
                        <button onclick="exportTabellaOrdiniToExcel()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-2 py-1 rounded text-xs font-bold shadow transition">
                            <i class="fas fa-file-excel mr-1"></i>Excel
                        </button>
                        
                        <div class="flex items-center gap-1">
                            <button onclick="printTabellaOrdiniPart(1)" class="bg-green-600 hover:bg-green-700 text-white px-2 py-1 rounded text-xs font-bold shadow transition">
                                <i class="fas fa-print mr-1"></i>Parte 1
                            </button>
                            <button onclick="printTabellaOrdiniPart(2)" class="bg-green-600 hover:bg-green-700 text-white px-2 py-1 rounded text-xs font-bold shadow transition">
                                <i class="fas fa-print mr-1"></i>Parte 2
                            </button>
                        </div>
                    </div>
                </div>
                <div class="overflow-auto flex-grow">
                    <table id="tabellaOrdiniStampabile" class="border-collapse border text-xs" style="width: auto;">
                        <thead>
                            <tr id="tabellaOrdiniHeaderRow1" class="bg-blue-900 text-white">
                                <!-- Header dinamico -->
                            </tr>
                            <tr id="tabellaOrdiniHeaderRow2" class="bg-blue-700 text-white">
                                <!-- Totali dinamici -->
                            </tr>
                        </thead>
                        <tbody id="tabellaOrdiniBody">
                            <!-- Popolato dinamicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TAB CATALOGO (solo admin) -->
        <div id="tab-catalogo" class="tab-content">
            <div class="bg-white p-4 rounded shadow mb-4">
                <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
                    <div>
                        <h2 class="font-bold text-xl text-blue-900"><i class="fas fa-book-open mr-2"></i>Gestione Catalogo</h2>
                        <p class="text-xs text-gray-500">Configura il catalogo pubblico da condividere con i clienti</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="openCatalogPreview()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-bold transition">
                            <i class="fas fa-eye mr-2"></i>Anteprima Catalogo
                        </button>
                        <button onclick="copyCatalogLink()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-bold transition">
                            <i class="fas fa-link mr-2"></i>Copia Link
                        </button>
                        <button onclick="saveCatalogConfig()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded font-bold transition">
                            <i class="fas fa-save mr-2"></i>Salva Catalogo
                        </button>
                    </div>
                </div>
                
                <!-- Configurazione QR Code e Link -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 p-4 bg-gray-50 rounded border">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2"><i class="fas fa-qrcode mr-1"></i>URL QR Code per Ordini</label>
                        <input type="text" id="catalogQrUrl" placeholder="https://forms.google.com/..." class="w-full border rounded px-3 py-2 text-sm" onchange="updateQrPreview()">
                        <p class="text-xs text-gray-500 mt-1">Inserisci il link al modulo ordini (es. Google Form)</p>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2"><i class="fas fa-external-link-alt mr-1"></i>Link Catalogo Completo (opzionale)</label>
                        <input type="text" id="catalogFullUrl" placeholder="https://..." class="w-full border rounded px-3 py-2 text-sm">
                        <p class="text-xs text-gray-500 mt-1">Link a un catalogo PDF o sito esterno</p>
                    </div>
                </div>
                
                <!-- Titolo e descrizione catalogo -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 p-4 bg-blue-50 rounded border border-blue-200">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2"><i class="fas fa-heading mr-1"></i>Titolo Catalogo</label>
                        <input type="text" id="catalogTitle" placeholder="Catalogo Abbigliamento Sportivo 2025" class="w-full border rounded px-3 py-2 text-sm" value="Catalogo Abbigliamento">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2"><i class="fas fa-image mr-1"></i>Logo/Immagine Header (URL)</label>
                        <input type="text" id="catalogLogo" placeholder="https://..." class="w-full border rounded px-3 py-2 text-sm">
                    </div>
                </div>
            </div>
            
            <!-- Lista Articoli del Catalogo -->
            <div class="bg-white p-4 rounded shadow">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="font-bold text-lg text-gray-800"><i class="fas fa-tshirt mr-2"></i>Articoli nel Catalogo</h3>
                    <div class="flex gap-2">
                        <button onclick="addCatalogItem()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded text-sm font-bold transition">
                            <i class="fas fa-plus mr-1"></i>Aggiungi Articolo
                        </button>
                        <button onclick="importItemsFromDB()" class="bg-orange-600 hover:bg-orange-700 text-white px-3 py-1.5 rounded text-sm font-bold transition">
                            <i class="fas fa-database mr-1"></i>Importa da DB
                        </button>
                    </div>
                </div>
                
                <div id="catalogItemsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Articoli popolati dinamicamente -->
                    <div class="text-center text-gray-400 py-8 col-span-full">
                        <i class="fas fa-box-open text-4xl mb-2"></i>
                        <p>Nessun articolo nel catalogo. Clicca "Aggiungi Articolo" o "Importa da DB".</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="itemModal" class="modal">
        <div class="bg-white rounded-lg shadow-xl w-11/12 md:w-2/3 max-h-[90vh] flex flex-col">
            <div class="p-4 border-b flex justify-between items-center bg-blue-50 rounded-t-lg"><h3 class="font-bold text-blue-900">Gestione Articoli Ordine</h3><button onclick="closeModal()" class="text-gray-500 hover:text-red-500 text-2xl">&times;</button></div>
            <div class="p-4 overflow-y-auto flex-grow bg-gray-50">
                <div class="mb-4 bg-gray-50 p-3 rounded border grid grid-cols-1 md:grid-cols-3 gap-3">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">üìÖ Data/Ora Ordine</label>
                        <input type="text" id="modalTimestamp" readonly class="w-full border rounded p-1 text-sm bg-gray-100 text-gray-600 font-mono" placeholder="Non disponibile">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">üìß Email</label>
                        <input type="email" id="modalEmail" onchange="updateContactInfo('email', this.value)" class="w-full border rounded p-1 text-sm" placeholder="cliente@email.com">
                    </div>
                    <div>
                         <label class="block text-xs font-bold text-gray-500 uppercase mb-1">üì± Telefono</label>
                        <input type="tel" id="modalPhone" onchange="updateContactInfo('phone', this.value)" class="w-full border rounded p-1 text-sm" placeholder="+39 ...">
                    </div>
                </div>

                <div class="bg-white rounded border shadow-sm mb-4"><table class="w-full text-xs text-left"><thead class="bg-gray-200 text-gray-600 uppercase"><tr><th class="p-3">Articolo</th><th class="p-3 w-32 text-center">Taglia</th><th class="p-3 w-16 text-center">Rimuovi</th></tr></thead><tbody id="modalItemsBody"></tbody></table></div>
                <div class="p-3 bg-blue-50 rounded border border-blue-100 flex flex-col gap-2"><label class="text-xs font-bold text-blue-800">Aggiungi Articolo Extra:</label><div class="flex gap-2"><select id="addItemSelect" class="border p-2 text-sm rounded w-full outline-none focus:ring-2 focus:ring-blue-300"></select><button onclick="addItemToOrder()" class="bg-blue-600 text-white px-4 py-2 rounded font-bold hover:bg-blue-700 transition">AGGIUNGI</button></div></div>
            </div>
            <div class="p-4 border-t bg-white text-right rounded-b-lg"><button onclick="closeModal()" class="bg-gray-800 text-white px-6 py-2 rounded hover:bg-black transition shadow">Chiudi & Salva</button></div>
        </div>
    </div>

    <div id="settingsModal" class="modal">
        <div class="bg-white rounded-lg shadow-xl w-11/12 md:w-1/2 max-h-[90vh] flex flex-col">
             <div class="p-4 border-b flex justify-between items-center bg-gray-100 rounded-t-lg"><h3 class="font-bold text-gray-800">Configurazione Articoli DB</h3><button onclick="closeSettingsModal()" class="text-gray-500 hover:text-red-500 text-2xl">&times;</button></div>
            <div class="p-4 overflow-y-auto flex-grow bg-white">
                 <div class="mb-4 p-2 bg-orange-50 border border-orange-200 rounded flex justify-between items-center">
                    <span class="text-xs text-orange-800 font-bold">Hai modificato i prezzi nel codice ma non vedi i totali aggiornati?</span>
                    <button onclick="forceUpdatePrices()" class="bg-orange-600 hover:bg-orange-700 text-white px-3 py-1 rounded text-xs font-bold shadow">Forza Aggiornamento Prezzi</button>
                </div>
                <div class="flex gap-2 mb-4 border-b pb-4"><input type="text" id="newItemName" placeholder="Nuovo Articolo (es: Cappellino Blu)" class="border rounded p-2 flex-grow text-sm"><button onclick="addItemToConfig()" class="bg-green-600 text-white px-4 py-2 rounded font-bold hover:bg-green-700">Aggiungi</button></div>
                 <div class="overflow-y-auto h-96">
                    <table class="w-full text-xs text-left border">
                        <thead class="bg-gray-200 sticky top-0"><tr><th class="p-2">Nome Articolo</th><th class="p-2 w-24 text-center">Azioni</th></tr></thead>
                        <tbody id="configItemsBody"></tbody>
                    </table>
                </div>
                <div class="mt-4 text-xs text-gray-500 bg-yellow-50 p-2 rounded border border-yellow-200"><i class="fas fa-exclamation-triangle text-yellow-600"></i> Attenzione: Rinominando un articolo, verr√† aggiornato anche in tutti gli ordini esistenti e nel magazzino.</div>
            </div>
            <div class="p-4 border-t bg-gray-100 text-right rounded-b-lg flex justify-between"><button onclick="resetConfigDefaults()" class="text-red-600 hover:text-red-800 text-xs font-bold underline">Ripristina Default</button><button onclick="closeSettingsModal()" class="bg-blue-900 text-white px-6 py-2 rounded hover:bg-blue-800 shadow">Salva & Chiudi</button></div>
        </div>
    </div>

    <div id="kitConfigModal" class="modal">
        <div class="bg-white rounded-lg shadow-xl w-11/12 md:w-3/4 max-h-[90vh] flex flex-col">
            <div class="p-4 border-b flex justify-between items-center bg-indigo-50 rounded-t-lg"><h3 class="font-bold text-indigo-900">Configurazione KIT (Composizione)</h3><button onclick="closeKitConfigModal()" class="text-gray-500 hover:text-red-500 text-2xl">&times;</button></div>
            <div class="p-4 flex flex-col md:flex-row gap-4 overflow-hidden flex-grow">
                 <div class="w-full md:w-1/3 border-r pr-2 overflow-y-auto">
                    <div class="mb-2"><button onclick="addNewKitDefinition()" class="w-full bg-green-600 text-white py-2 rounded font-bold text-sm">+ Nuovo KIT</button></div>
                    <div id="kitListContainer" class="flex flex-col gap-2"></div>
                    <button onclick="resetKitDefaults()" class="mt-4 text-xs text-red-500 underline w-full text-center">Ripristina Kit Default</button>
                </div>
                <div class="w-full md:w-2/3 pl-2 flex flex-col overflow-hidden" id="kitDetailContainer" style="display:none;">
                    <div class="mb-4 grid grid-cols-1 gap-2">
                        <label class="text-xs font-bold">Nome Visualizzato (inclusi Prezzo ‚Ç¨):</label>
                         <input type="text" id="editKitName" class="border p-2 rounded font-bold text-sm w-full" placeholder="Es: Kit Base (100‚Ç¨)">
                        <label class="text-xs font-bold">ID Interno (chiave unica, non modificabile):</label>
                        <input type="text" id="editKitKey" class="border p-2 rounded text-xs bg-gray-100 text-gray-500" disabled>
                     </div>
                    <div class="flex-grow overflow-y-auto border rounded bg-gray-50 p-2 mb-2">
                        <h4 class="font-bold text-xs mb-2">Articoli Inclusi:</h4>
                        <ul id="editKitItemsList" class="space-y-1"></ul>
                    </div>
                    <div class="flex gap-2 items-center mt-2 border-t pt-2">
                        <select id="addKitItemSelect" class="border p-2 text-xs rounded flex-grow"></select>
                        <button onclick="addItemToKitDefinition()" class="bg-blue-600 text-white px-3 py-2 rounded text-xs font-bold">Aggiungi</button>
                    </div>
                    <div class="mt-4 flex justify-between">
                        <button onclick="deleteCurrentKit()" class="bg-red-100 text-red-600 px-3 py-2 rounded text-xs font-bold">Elimina Kit</button>
                        <button onclick="saveCurrentKit()" class="bg-indigo-600 text-white px-6 py-2 rounded font-bold shadow">Salva Modifiche</button>
                    </div>
                </div>
                 <div class="w-full md:w-2/3 pl-2 flex flex-col justify-center items-center text-gray-400" id="kitPlaceholder">
                    <i class="fas fa-tshirt text-4xl mb-2"></i>
                    <p>Seleziona un Kit a sinistra per modificarlo</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Popup Note -->
    <div id="notesPopup" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <i class="fas fa-sticky-note text-yellow-500"></i>
                    Gestione Note
                </h2>
                <button onclick="closeNotesPopup()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-bold text-gray-700 mb-2">Nota Ordine</label>
                <textarea id="noteTextarea" rows="5" class="w-full border rounded p-3 text-sm focus:ring-2 focus:ring-blue-300 outline-none resize-none" placeholder="Inserisci note per questo ordine..."></textarea>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-bold text-gray-700 mb-2">üé® Colore Nota</label>
                <div class="grid grid-cols-4 gap-2">
                    <button onclick="selectNoteColor('default')" class="note-color-btn border-2 rounded p-3 hover:scale-105 transition" data-color="default">
                        <div class="w-full h-8 bg-white border-2 border-gray-300 rounded"></div>
                        <span class="text-xs mt-1 block">Nessuno</span>
                    </button>
                    <button onclick="selectNoteColor('yellow')" class="note-color-btn border-2 rounded p-3 hover:scale-105 transition" data-color="yellow">
                        <div class="w-full h-8 bg-yellow-200 rounded"></div>
                        <span class="text-xs mt-1 block">Giallo</span>
                    </button>
                    <button onclick="selectNoteColor('green')" class="note-color-btn border-2 rounded p-3 hover:scale-105 transition" data-color="green">
                        <div class="w-full h-8 bg-green-200 rounded"></div>
                        <span class="text-xs mt-1 block">Verde</span>
                    </button>
                    <button onclick="selectNoteColor('blue')" class="note-color-btn border-2 rounded p-3 hover:scale-105 transition" data-color="blue">
                        <div class="w-full h-8 bg-blue-200 rounded"></div>
                        <span class="text-xs mt-1 block">Blu</span>
                    </button>
                    <button onclick="selectNoteColor('red')" class="note-color-btn border-2 rounded p-3 hover:scale-105 transition" data-color="red">
                        <div class="w-full h-8 bg-red-200 rounded"></div>
                        <span class="text-xs mt-1 block">Rosso</span>
                    </button>
                    <button onclick="selectNoteColor('orange')" class="note-color-btn border-2 rounded p-3 hover:scale-105 transition" data-color="orange">
                        <div class="w-full h-8 bg-orange-200 rounded"></div>
                        <span class="text-xs mt-1 block">Arancione</span>
                    </button>
                    <button onclick="selectNoteColor('purple')" class="note-color-btn border-2 rounded p-3 hover:scale-105 transition" data-color="purple">
                        <div class="w-full h-8 bg-purple-200 rounded"></div>
                        <span class="text-xs mt-1 block">Viola</span>
                    </button>
                    <button onclick="selectNoteColor('pink')" class="note-color-btn border-2 rounded p-3 hover:scale-105 transition" data-color="pink">
                        <div class="w-full h-8 bg-pink-200 rounded"></div>
                        <span class="text-xs mt-1 block">Rosa</span>
                    </button>
                </div>
            </div>
            
            <div class="flex gap-2 justify-end">
                <button onclick="closeNotesPopup()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 font-bold transition">
                    Annulla
                </button>
                <button onclick="saveNoteFromPopup()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 font-bold transition">
                    <i class="fas fa-save mr-2"></i>Salva Nota
                </button>
            </div>
        </div>
    </div>

    <!-- Popup Consegna Parziale -->
    <div id="partialDeliveryPopup" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <i class="fas fa-box-open text-amber-600"></i>
                    Consegna Parziale - Cosa Manca?
                </h2>
                <button onclick="closePartialDeliveryPopup()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            
            <div class="bg-amber-50 border border-amber-200 rounded p-3 mb-4">
                <p class="text-sm text-amber-800">
                    <i class="fas fa-info-circle mr-2"></i>
                    <strong>Nota:</strong> Inserisci l'abbigliamento mancante per questa consegna parziale. 
                    Esempio: "Maglia 2XL, Pantaloni M"
                </p>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-bold text-gray-700 mb-2">üìù Articoli Mancanti</label>
                <textarea id="partialDeliveryNote" rows="5" class="w-full border rounded p-3 text-sm focus:ring-2 focus:ring-amber-300 outline-none resize-none" placeholder="Es: Maglia M, Pantaloncini L, Calze 39/42..."></textarea>
                <p class="text-xs text-gray-500 mt-1">
                    üí° Puoi anche specificare quantit√†: "2x Maglia M, 1x Pantaloni L"
                </p>
            </div>
            
            <div class="flex gap-2 justify-end">
                <button onclick="closePartialDeliveryPopup()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 font-bold transition">
                    Annulla
                </button>
                <button onclick="savePartialDeliveryNote()" class="px-4 py-2 bg-amber-600 text-white rounded hover:bg-amber-700 font-bold transition">
                    <i class="fas fa-save mr-2"></i>Salva Nota
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://appordinigo.vercel.app/api';
        const SIZE_ORDER = ["23/26", "27/30", "31/34", "35/38", "39/42", "43/46", "6 ANNI", "8 ANNI", "10 ANNI", "12 ANNI", "14 ANNI", "S", "M", "L", "XL", "2XL", "3XL", "4XL", "03 BIMBO", "05 ADULTO", "UNICA"];
        const SOCKS_BLUE_DEFAULT = "Calzettoni di Allenamento WULGAR Blu Marine 618 (7‚Ç¨)";
        const SOCKS_RED_DEFAULT = "Calzettoni di Allen. WULGAR COL. 565 RED (7‚Ç¨)";
        const SOCKS_SPOLF_BLUE = "Calzettone (Senza Piede) SPOLF Blue Marine 193 (8‚Ç¨)";
        const SOCKS_SPOLF_RED = "Calzettone (Senza Piede) SPOLF RED 565 (8‚Ç¨)";
        
        // Funzione helper per identificare se un articolo √® una calza
        function isSockItem(itemName) {
            return itemName.includes("Calzettoni") || itemName.includes("Calzettone");
        }
        const PANT_NAME = "Pantalone Allen. GASTON Blu Marine 193 (20‚Ç¨)";
        const OLD_JACKET_NAME = "Giaccone Invernale BURAN Blue Marine 901 (55‚Ç¨)";
        const NEW_JACKET_NAME = "Giaccone Invernale BURAN Blue Marine 901 (35‚Ç¨)";
        const TUTA_NAME = "Tuta Rapp. DALCITO Blu Marine A02 (35‚Ç¨)";
        const POLO_NAME = "Polo Rapp. GASTIO Blue Marine 193 (25‚Ç¨)";
        const POLO_STAFF_NAME = "Polo Staff GASTIO H03 BLU SAPPHIRE (25‚Ç¨)";
        const GK_SHIRT = "Maglia Allen. Portieri GK FARCO PM8 (15‚Ç¨)";
        const GK_PANT_LONG = "Pantalone Allen. Portiere GK FESOLO Black 005 (25‚Ç¨)";
        const GK_PANT_SHORT = "Pantaloncino Portiere GK FAVIO Nero 005 (15‚Ç¨)";
        const DEFAULT_ITEMS_LIST = [
            // Accessori
            "Borsone HARDBASE Blue Marine 901 (25‚Ç¨)",
            "Zaino BACKPACK Blue Marine 901 (25‚Ç¨)",
            
            // Abbigliamento Giocatori
            "Giaccone Invernale BURAN Blue Marine 901 (35‚Ç¨)",
            "Felpa Allen. GASSOLO Blu Marine A04 (25‚Ç¨)",
            "T-Shirt Allen. Giocatori DOVO Blu H03 (12‚Ç¨)",
            "Pantaloncino Allen. Giocatori BORGO Blu H03 (12‚Ç¨)",
            PANT_NAME,
            TUTA_NAME,
            "Bermuda Rapp. BAJO Blue Marine 193 (15‚Ç¨)",
            POLO_NAME,
            "K-Way WISTER Blu Marine 193 (20‚Ç¨)",
            
            // Portieri
            GK_SHIRT,
            GK_PANT_SHORT,
            GK_PANT_LONG,
            
            // Termici
            "Maglia Termica VURBAT - col. 005 nero (20‚Ç¨)",
            "Pantalone Termico VANT - col. 005 nero (18‚Ç¨)",
            
            // Felpe Extra
            "Felpa Estiva GREVOLO Blu Marine A04 (30‚Ç¨)",
            "Felpa Invernale BANTO Blu Marine 193 (30‚Ç¨)",
            
            // Staff/Allenatori
            "T-Shirt Allen. Staff DOVO COL. 565 RED (12‚Ç¨)",
            "Pantaloncino Allen. Staff BORGO COL. 565 RED (12‚Ç¨)",
            "Felpa Allen. Staff GASSOLO COL. A02 RED (25‚Ç¨)",
            POLO_STAFF_NAME,
            "K-Way WISTER COL. 565 RED (Staff) (20‚Ç¨)",
            
            // Accessori Extra
            "Scaldacollo NECK (8‚Ç¨)",
            "Cappellino ZUCOT (10‚Ç¨)",
            "Guanti Player (12‚Ç¨)",
            
            // Calze (sempre in fondo)
            SOCKS_BLUE_DEFAULT,
            SOCKS_RED_DEFAULT,
            SOCKS_SPOLF_BLUE,
            SOCKS_SPOLF_RED
        ];
        
        const EXCEL_ITEM_MAPPING = { 
            "t-shirt di allenamento giocatori": "T-Shirt Allen. Giocatori DOVO Blu H03 (12‚Ç¨)", 
            "pantaloncino di allenamento giocatori": "Pantaloncino Allen. Giocatori BORGO Blu H03 (12‚Ç¨)", 
            "pantalone di allenamento": PANT_NAME,
            "pantalone,": PANT_NAME, 
            "pantalone ": PANT_NAME, 
            "felpa di allenamento gassolo": "Felpa Allen. GASSOLO Blu Marine A04 (25‚Ç¨)", 
            "felpa estiva": "Felpa Estiva GREVOLO Blu Marine A04 (30‚Ç¨)",
            "grevolo": "Felpa Estiva GREVOLO Blu Marine A04 (30‚Ç¨)",
            "felpa invernale": "Felpa Invernale BANTO Blu Marine 193 (30‚Ç¨)",
            "banto": "Felpa Invernale BANTO Blu Marine 193 (30‚Ç¨)",
            "tuta di rappresentanza": TUTA_NAME, 
            "polo di rappresentanza": POLO_NAME, 
            "bermuda": "Bermuda Rapp. BAJO Blue Marine 193 (15‚Ç¨)", 
            "k-way wister blu": "K-Way WISTER Blu Marine 193 (20‚Ç¨)", 
            "maglia termica": "Maglia Termica VURBAT - col. 005 nero (20‚Ç¨)", 
            "pantalone termico": "Pantalone Termico VANT - col. 005 nero (18‚Ç¨)", 
            "calzettoni wulgar": SOCKS_BLUE_DEFAULT, 
            "calzettoni di allenamento wulgar": SOCKS_BLUE_DEFAULT, 
            "wulgar": SOCKS_BLUE_DEFAULT,
            "spolf blue": SOCKS_SPOLF_BLUE,
            "spolf blu": SOCKS_SPOLF_BLUE,
            "calzettone spolf blue": SOCKS_SPOLF_BLUE,
            "calzettone senza piede blu": SOCKS_SPOLF_BLUE,
            "spolf red": SOCKS_SPOLF_RED,
            "spolf rosso": SOCKS_SPOLF_RED,
            "calzettone spolf red": SOCKS_SPOLF_RED,
            "calzettone senza piede rosso": SOCKS_SPOLF_RED, 
            "t-shirt di allenamento staff": "T-Shirt Allen. Staff DOVO COL. 565 RED (12‚Ç¨)", 
            "pantaloncino di allenamento staff": "Pantaloncino Allen. Staff BORGO COL. 565 RED (12‚Ç¨)", 
            "felpa di allenamento staff": "Felpa Allen. Staff GASSOLO COL. A02 RED (25‚Ç¨)", 
            "polo di rapp. dirigenti": POLO_STAFF_NAME, 
            "blu sapphire": POLO_STAFF_NAME, 
            "k-way wister rosso": "K-Way WISTER COL. 565 RED (Staff) (20‚Ç¨)", 
            "calzettoni staff": SOCKS_RED_DEFAULT, 
            "giaccone invernale": NEW_JACKET_NAME, 
            "borsone hardbase": "Borsone HARDBASE Blue Marine 901 (25‚Ç¨)", 
            "zaino backpack": "Zaino BACKPACK Blue Marine 901 (25‚Ç¨)", 
            "cappellino": "Cappellino ZUCOT (10‚Ç¨)", 
            "scaldacollo": "Scaldacollo NECK (8‚Ç¨)", 
            "guanti": "Guanti Player (12‚Ç¨)",
            "farco": GK_SHIRT,
            "fesolo": GK_PANT_LONG,
            "favio": GK_PANT_SHORT,
            "gk fesolo": GK_PANT_LONG,
            "gk favio": GK_PANT_SHORT,
            "gk farco": GK_SHIRT
        };

        const DEFAULT_KIT_DEFINITIONS = { 
            'giocatore_completo': { display: 'KIT Giocatore da Campo Completo (220‚Ç¨)', items: ["T-Shirt Allen. Giocatori DOVO Blu H03 (12‚Ç¨)", "Pantaloncino Allen. Giocatori BORGO Blu H03 (12‚Ç¨)", PANT_NAME, "Felpa Allen. GASSOLO Blu Marine A04 (25‚Ç¨)", TUTA_NAME, POLO_NAME, "Bermuda Rapp. BAJO Blue Marine 193 (15‚Ç¨)", "K-Way WISTER Blu Marine 193 (20‚Ç¨)", NEW_JACKET_NAME, SOCKS_BLUE_DEFAULT, "Borsone HARDBASE Blue Marine 901 (25‚Ç¨)"] }, 
            'giocatore_mini': { display: 'Mini Kit Giocatore da Campo (135‚Ç¨)', items: ["T-Shirt Allen. Giocatori DOVO Blu H03 (12‚Ç¨)", "Pantaloncino Allen. Giocatori BORGO Blu H03 (12‚Ç¨)", PANT_NAME, TUTA_NAME, POLO_NAME, "Bermuda Rapp. BAJO Blue Marine 193 (15‚Ç¨)", "K-Way WISTER Blu Marine 193 (20‚Ç¨)", SOCKS_BLUE_DEFAULT] }, 
            'staff_dirigente': { display: 'Kit Dirigente (80‚Ç¨)', items: [NEW_JACKET_NAME, TUTA_NAME, POLO_STAFF_NAME, "Bermuda Rapp. BAJO Blue Marine 193 (15‚Ç¨)"] }, 
            'staff_allenatore_completo': { display: 'Kit Allenatore Completo (245‚Ç¨)', items: ["T-Shirt Allen. Staff DOVO COL. 565 RED (12‚Ç¨)", "Pantaloncino Allen. Staff BORGO COL. 565 RED (12‚Ç¨)", PANT_NAME, "Felpa Allen. Staff GASSOLO COL. A02 RED (25‚Ç¨)", TUTA_NAME, POLO_STAFF_NAME, "Bermuda Rapp. BAJO Blue Marine 193 (15‚Ç¨)", "K-Way WISTER COL. 565 RED (Staff) (20‚Ç¨)", NEW_JACKET_NAME, SOCKS_RED_DEFAULT, "Borsone HARDBASE Blue Marine 901 (25‚Ç¨)"] }, 
            'staff_allenatore_base': { display: 'Kit Allenatore Base (135‚Ç¨)', items: ["T-Shirt Allen. Staff DOVO COL. 565 RED (12‚Ç¨)", "Pantaloncino Allen. Staff BORGO COL. 565 RED (12‚Ç¨)", POLO_STAFF_NAME, "Bermuda Rapp. BAJO Blue Marine 193 (15‚Ç¨)", "K-Way WISTER COL. 565 RED (Staff) (20‚Ç¨)", TUTA_NAME, "Felpa Allen. Staff GASSOLO COL. A02 RED (25‚Ç¨)", SOCKS_RED_DEFAULT] }, 
            'portiere_completo_lungo': { display: 'Kit Portiere Completo - Lungo (220‚Ç¨)', items: [GK_SHIRT, GK_PANT_LONG, "Felpa Allen. GASSOLO Blu Marine A04 (25‚Ç¨)", TUTA_NAME, POLO_NAME, "Bermuda Rapp. BAJO Blue Marine 193 (15‚Ç¨)", "K-Way WISTER Blu Marine 193 (20‚Ç¨)", NEW_JACKET_NAME, SOCKS_BLUE_DEFAULT, "Borsone HARDBASE Blue Marine 901 (25‚Ç¨)"] },
            'portiere_completo_corto': { display: 'Kit Portiere Completo - Corto (210‚Ç¨)', items: [GK_SHIRT, GK_PANT_SHORT, "Felpa Allen. GASSOLO Blu Marine A04 (25‚Ç¨)", TUTA_NAME, POLO_NAME, "Bermuda Rapp. BAJO Blue Marine 193 (15‚Ç¨)", "K-Way WISTER Blu Marine 193 (20‚Ç¨)", NEW_JACKET_NAME, SOCKS_BLUE_DEFAULT, "Borsone HARDBASE Blue Marine 901 (25‚Ç¨)"] },
            'portiere_mini_lungo': { display: 'Mini Kit Portiere - Lungo (135‚Ç¨)', items: [GK_SHIRT, GK_PANT_LONG, TUTA_NAME, POLO_NAME, "Bermuda Rapp. BAJO Blue Marine 193 (15‚Ç¨)", "K-Way WISTER Blu Marine 193 (20‚Ç¨)", SOCKS_BLUE_DEFAULT] },
            'portiere_mini_corto': { display: 'Mini Kit Portiere - Corto (135‚Ç¨)', items: [GK_SHIRT, GK_PANT_SHORT, TUTA_NAME, POLO_NAME, "Bermuda Rapp. BAJO Blue Marine 193 (15‚Ç¨)", "K-Way WISTER Blu Marine 193 (20‚Ç¨)", SOCKS_BLUE_DEFAULT] }
        };

        const STATUSES = [ 
            { value: 'Nuovo', label: 'Nuovo', color: 'bg-yellow-100 text-yellow-800' }, 
            { value: 'In Lavorazione', label: 'In Lavorazione', color: 'bg-blue-100 text-blue-800' }, 
            { value: 'Pagato', label: 'Pagato', color: 'bg-green-700 text-white' }, 
            { value: 'Ordine Arrivato', label: 'Arrivato', color: 'bg-orange-100 text-orange-800' },
            { value: 'Consegna Parziale', label: 'Consegna Parziale', color: 'bg-amber-100 text-amber-800' },
            { value: 'Consegnato', label: 'Consegnato', color: 'bg-gray-700 text-white' },
            { value: 'Scomposto', label: 'Scomposto', color: 'bg-teal-100 text-teal-800' },
            { value: 'Ordine annullato', label: 'Annullato', color: 'bg-red-100 text-red-800' }, 
            { value: 'Ordine trasferito ad altro ID', label: 'Trasferito', color: 'bg-purple-100 text-purple-800' },
	    { value: 'Da piazzare', label: 'Da piazzare', color: 'bg-indigo-100 text-indigo-800' }
        ];
        
        // === FUNZIONI GLOBALI PER ORDINAMENTO ID ===
        // Estrae prefisso (anno) e numero dall'ID
        // Esempi: "2025_001" -> {prefix: "2025_", num: 1}, "2025A_244" -> {prefix: "2025A_", num: 244}, "2026_001" -> {prefix: "2026_", num: 1}
        function parseDisplayId(displayId) {
            if (!displayId) return { prefix: '', num: 0 };
            const match = displayId.match(/^(.+?)(\d+)$/);
            if (match) {
                return { prefix: match[1], num: parseInt(match[2]) };
            }
            return { prefix: displayId, num: 0 };
        }
        
        // Confronta due ID considerando prefisso + numero
        // 2025_001 < 2025_002 < 2025A_001 < 2025A_244 < 2026_001
        function compareDisplayIds(idA, idB) {
            const a = parseDisplayId(idA);
            const b = parseDisplayId(idB);
            
            // Prima confronta il prefisso (ordine alfabetico: 2025A_ < 2026_)
            if (a.prefix !== b.prefix) {
                return a.prefix.localeCompare(b.prefix);
            }
            // Se stesso prefisso, confronta il numero
            return a.num - b.num;
        }
        
        // Ordina un array di ordini per displayId
        function sortOrdersByDisplayId(ordersArray, ascending = true) {
            return [...ordersArray].sort((a, b) => {
                const comparison = compareDisplayIds(a.displayId, b.displayId);
                return ascending ? comparison : -comparison;
            });
        }

        let globalItems = []; 
        let orders = []; 
        let inventory = {}; 
        let globalKitTypes = {}; 
        let quickIdFilters = {}; // Filtri Quick ID condivisi su Redis
        let currentEditId = null;
        let currentEditingKitKey = null; 
        let chartStatus = null;
        let chartRevenue = null; let chartItems = null;
        let chartKitItems = null; // Grafico capi per kit filtrato
        let lastOrderId = 0; const DEFAULT_ID_PREFIX = `${new Date().getFullYear()}A_`;
        let currentPrefix = DEFAULT_ID_PREFIX; 
        let highlightedSizeCells = {}; // Nuovo: salva lo stato delle celle evidenziate {orderId_itemName_size: true} 

        function startClock() {
            const updateClock = () => {
                const clockEl = document.getElementById('liveClock');
                if (clockEl) {
                    const now = new Date();
                    clockEl.innerText = now.toLocaleString('it-IT');
                }
            };
            
            // Aggiorna subito
            updateClock();
            
            // Poi ogni secondo
            setInterval(updateClock, 1000);
        }

        function showTab(tabName) { 
            // Verifica permessi per Dashboard
            if (tabName === 'dashboard' && !checkPermission('viewDashboard')) {
                alert('‚ö†Ô∏è Non hai i permessi per visualizzare la Dashboard.');
                return;
            }
            
            // Verifica permessi per Catalogo (solo admin)
            if (tabName === 'catalogo' && currentUser?.role !== 'admin') {
                alert('‚ö†Ô∏è Non hai i permessi per visualizzare il Catalogo.');
                return;
            }
            
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            
            // Reset stili nav buttons MA rispetta i permessi
            const navButtons = ['nav-ordini', 'nav-matrix', 'nav-tabella-ordini', 'nav-dashboard', 'nav-catalogo'];
            navButtons.forEach(id => {
                const btn = document.getElementById(id);
                if (btn && !btn.classList.contains('hidden')) {
                    btn.className = "px-3 py-1.5 rounded-md text-xs font-medium transition text-gray-600 hover:bg-gray-200";
                }
            });
            
            document.getElementById('tab-' + tabName).classList.add('active');
            document.getElementById('nav-' + tabName).className = "px-3 py-1.5 rounded-md text-xs font-medium transition bg-blue-900 text-white shadow";
            
            if (tabName === 'matrix') renderMatrices();
            if (tabName === 'dashboard') { 
                updateDashboardCounts(); 
                renderChart(); 
            }
            if (tabName === 'catalogo') renderCatalogItems();
            if (tabName === 'tabella-ordini') { populateTabellaOrdiniFilters(); renderTabellaOrdini(); }
        }
        
        function populateTabellaOrdiniFilters() {
            const minSelect = document.getElementById('tabellaOrdiniMinId');
            const maxSelect = document.getElementById('tabellaOrdiniMaxId');
            if (!minSelect || !maxSelect) return;
            
            // Ordina usando la funzione globale
            const sortedOrders = sortOrdersByDisplayId(orders, true);
            const allIds = sortedOrders.map(o => o.displayId);
            
            minSelect.innerHTML = allIds.map(id => `<option value="${id}">${id}</option>`).join('');
            maxSelect.innerHTML = allIds.map(id => `<option value="${id}">${id}</option>`).join('');
            if (allIds.length > 0) {
                minSelect.value = allIds[0];
                maxSelect.value = allIds[allIds.length - 1];
            }
        }
        
        function printTabellaOrdiniPart(part) {
            const table = document.getElementById('tabellaOrdiniStampabile');
            if (!table) return;
            
            // Semplice: aggiungi una classe alla tabella per indicare quale parte
            table.classList.remove('print-part-1', 'print-part-2');
            
            if (part === 1) {
                table.classList.add('print-part-1');
            } else {
                table.classList.add('print-part-2');
            }
            
            // Stampa
            setTimeout(() => {
                window.print();
                
                // Ripristina
                setTimeout(() => {
                    table.classList.remove('print-part-1', 'print-part-2');
                }, 200);
            }, 100);
        }
        
        // Funzione per evidenziare/de-evidenziare celle taglie
        function toggleSizeCellHighlight(cell, orderId, itemName, size) {
            const cellKey = `${orderId}_${itemName}_${size}`;
            
            // Toggle dello stato
            if (highlightedSizeCells[cellKey]) {
                delete highlightedSizeCells[cellKey];
                cell.classList.remove('size-cell-highlighted');
            } else {
                highlightedSizeCells[cellKey] = true;
                cell.classList.add('size-cell-highlighted');
            }
            
            // Salva lo stato
            saveData();
        }
        
        // Funzione per scaricare ordine tramite Google Form
        function downloadOrderToGoogleForm(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) {
                alert('Ordine non trovato!');
                return;
            }
            
            // Verifica che ci siano i dati necessari
            if (!order.email) {
                alert('‚ö†Ô∏è Email mancante!\n\nInserisci l\'email dell\'ordine prima di scaricare.');
                return;
            }
            
            if (!order.customer) {
                alert('‚ö†Ô∏è Nome cliente mancante!');
                return;
            }
            
            // Separa nome e cognome (assume formato "Nome Cognome")
            const nameParts = order.customer.trim().split(' ');
            const firstName = nameParts[0] || '';
            const lastName = nameParts.slice(1).join(' ') || '';
            
            if (!lastName) {
                alert('‚ö†Ô∏è Formato nome non valido!\n\nIl campo Cliente deve contenere Nome e Cognome separati da spazio.\nEsempio: "Mario Rossi"');
                return;
            }
            
            const role = order.roleOrYear || '';
            
            // URL del Google Form: https://forms.gle/RHkk464RUcDEEcG86
            // Link completo corretto del form
            const formBaseUrl = 'https://docs.google.com/forms/d/e/1FAIpQLSfd9fUfr2WADHdUzWK6Ek6_Z3AV8_MHc7DzV033zPriUqSNEg/viewform';
            
            // Parametri del form con gli ENTRY ID corretti (AGGIORNATO dopo rimozione raccolta email automatica)
            const params = new URLSearchParams({
                'usp': 'pp_url',                      // Parametro per link precompilato
                'entry.743500804': order.email,       // Email (NUOVO ENTRY ID)
                'entry.933188327': firstName,         // Nome Atleta
                'entry.562701918': lastName,          // Cognome Atleta
                'entry.248891173': role               // Annata o Ruolo
            });
            
            const fullUrl = `${formBaseUrl}?${params.toString()}`;
            
            // Apri il form in una nuova scheda
            window.open(fullUrl, '_blank');
            
            // Log per debug
            console.log('üìã Google Form aperto con dati precompilati:', {
                orderId: order.displayId,
                email: order.email,
                nome: firstName,
                cognome: lastName,
                ruolo: role,
                url: fullUrl
            });
        }
        
        function renderTabellaOrdini() {
            const headerRow1 = document.getElementById('tabellaOrdiniHeaderRow1');
            const headerRow2 = document.getElementById('tabellaOrdiniHeaderRow2');
            const tbody = document.getElementById('tabellaOrdiniBody');
            if (!headerRow1 || !headerRow2 || !tbody) return;
            
            // Popola select ID se vuoti
            const tabellaMinId = document.getElementById('tabellaOrdiniMinId');
            const tabellaMaxId = document.getElementById('tabellaOrdiniMaxId');
            if (tabellaMinId && tabellaMaxId && tabellaMinId.options.length === 0) {
                const sortedOrders = sortOrdersByDisplayId(orders, true);
                
                sortedOrders.forEach(o => {
                    const optMin = document.createElement('option');
                    optMin.value = o.displayId;
                    optMin.text = o.displayId;
                    tabellaMinId.appendChild(optMin);
                    
                    const optMax = document.createElement('option');
                    optMax.value = o.displayId;
                    optMax.text = o.displayId;
                    tabellaMaxId.appendChild(optMax);
                });
                
                // Imposta default: primo e ultimo
                if (sortedOrders.length > 0) {
                    tabellaMinId.value = sortedOrders[0].displayId;
                    tabellaMaxId.value = sortedOrders[sortedOrders.length - 1].displayId;
                }
            }
            
            // Filtri ID
            const minId = tabellaMinId?.value;
            const maxId = tabellaMaxId?.value;
            
            // Ordine ESATTO colonne come nell'Excel
            const columnOrder = [
                'Borsone HARDBASE',
                'Zaino BACKPACK',
                'Giaccone Invernale BURAN',
                'T-Shirt', // Allen. Giocatori DOVO
                'Pantaloncino', // Allen. Giocatori BORGO
                'Felpa di Allen. GASSOLO',
                'Pantalone di Allen.', // GASTON
                'Tuta di Rapp. DALCITO',
                'Bermuda di Rapp. BAJO',
                'Polo di Rapp. GASTIO Blue Marine',
                'K-Way WISTER Blu',
                'Maglia di Allen. Portieri',
                'Pantaloncino Portiere',
                'Pantalone di Allen. Portiere',
                'Maglia Termica VURBAT',
                'Pantalone Termico VANT',
                'Felpa Estiva',
                'Felpa Invernale BANTO',
                'T-Shirt di Rappresentanza',
                'Scaldacollo',
                'Cappellino',
                'Guanti',
                'Polo di Rapp. Dirigenti', // GASTIO SAPPHIRE
                'T-Shirt di Allen. Allenatori', // DOVO RED
                'Pantaloncino di Allen. Giocatori', // BORGO RED
                'Felpa di Allen. GASSOLO', // RED
                'Calzettoni', // WULGAR
                'K-Way WISTER' // RED
            ];
            
            // Raccolta articoli ordinati
            const allItemsMap = new Map();
            orders.forEach(order => {
                order.itemsList.forEach(item => {
                    if (!item || !item.name || typeof item.name !== 'string') return;
                    // Estrai nome senza prezzo - trova l'ultima parentesi con ‚Ç¨ o ‚Ç¨)
                    const priceMatch = item.name.match(/\s*\(\d+‚Ç¨\)\s*$/);
                    const itemName = priceMatch ? item.name.substring(0, item.name.lastIndexOf(priceMatch[0])).trim() : item.name;
                    if (!allItemsMap.has(itemName)) {
                        allItemsMap.set(itemName, itemName);
                    }
                });
            });
            
            const allItems = Array.from(allItemsMap.values()).sort((a, b) => {
                const findOrder = (name) => {
                    for (let i = 0; i < columnOrder.length; i++) {
                        if (name.includes(columnOrder[i])) return i;
                    }
                    return 999;
                };
                return findOrder(a) - findOrder(b);
            });
            
            // Header riga 1
            let header1HTML = `
                <th class="border p-2 bg-gray-200 tabella-ordini-sticky-header-1" rowspan="2" style="min-width: 140px; max-width: 140px; width: 140px; font-size: 11px; font-weight: bold; color: #000; white-space: nowrap;">ID Ordine</th>
                <th class="border p-2 bg-gray-200 tabella-ordini-sticky-header-2" rowspan="2" style="min-width: 150px; font-size: 11px; font-weight: bold; color: #000;">Cliente</th>
                <th class="border p-2 bg-gray-200" rowspan="2" style="min-width: 50px; font-size: 11px; font-weight: bold; color: #000;">Taglia</th>
                <th class="border p-2 bg-gray-200" rowspan="2" style="min-width: 70px; font-size: 11px; font-weight: bold; color: #000;">Taglia Calzettoni</th>
                <th class="border p-2 bg-gray-200" rowspan="2" style="min-width: 70px; font-size: 11px; font-weight: bold; color: #000;">Taglia Accessori</th>
                <th class="border p-2 bg-gray-200" rowspan="2" style="min-width: 180px; font-size: 11px; font-weight: bold; color: #000;">Ordine Da Effettuare</th>
                <th class="border p-2 bg-gray-200" rowspan="2" style="min-width: 100px; font-size: 11px; font-weight: bold; color: #000;">Note</th>
                <th class="border p-2 bg-gray-200" rowspan="2" style="min-width: 60px; font-size: 11px; font-weight: bold; color: #000; white-space: normal; line-height: 1.2;">Borsone/<br>Zaino</th>
                <th class="border p-2 bg-gray-200" rowspan="2" style="min-width: 80px; font-size: 11px; font-weight: bold; color: #000;">Google Form</th>
            `;
            
            allItems.forEach((itemName, idx) => {
                // Colore neutro uniforme
                const bgColor = '#f5f5f5';
                const textColor = '#000';
                
                // Spezza il nome su 2 righe se lungo
                let displayName = itemName;
                if (itemName.length > 25) {
                    const words = itemName.split(' ');
                    const midPoint = Math.ceil(words.length / 2);
                    displayName = words.slice(0, midPoint).join(' ') + '<br>' + words.slice(midPoint).join(' ');
                }
                
                // Determina quale met√†: primi 50% sono part-1, secondi 50% sono part-2
                const halfPoint = Math.ceil(allItems.length / 2);
                const partClass = idx < halfPoint ? 'print-show-part-1' : 'print-show-part-2';
                
                // TESTO ORIZZONTALE LEGGIBILE - NON RUOTATO
                // Aggiungi data-col-index per identificare le colonne articoli (8 fisse + indice articolo)
                const colIndex = 8 + idx;
                header1HTML += `<th class="border p-2 item-col ${partClass}" data-col-index="${colIndex}" style="background-color: ${bgColor}; color: ${textColor}; min-width: 80px; font-size: 10px; padding: 6px 3px; white-space: normal; line-height: 1.2; font-weight: bold; text-align: center;">${displayName}</th>`;
            });
            headerRow1.innerHTML = header1HTML;
            
            // Salva il numero totale di colonne per la divisione della stampa
            window.tabellaOrdiniTotalCols = 8 + allItems.length;
            window.tabellaOrdiniItemCols = allItems.length;
            
            // Filtra ordini
            const filterCliente = document.getElementById('tabellaOrdiniFilterCliente')?.value.toLowerCase().trim() || '';
            const filterTaglia = document.getElementById('tabellaOrdiniFilterTaglia')?.value || '';
            
            let filteredOrders = orders.filter(o => {
                // Usa confronto completo per il filtro ID
                if (minId && compareDisplayIds(o.displayId, minId) < 0) return false;
                if (maxId && compareDisplayIds(o.displayId, maxId) > 0) return false;
                
                // Filtro Cliente
                if (filterCliente && !o.customer.toLowerCase().includes(filterCliente)) return false;
                
                // Filtro Taglia
                if (filterTaglia && o.mainSize !== filterTaglia) return false;
                
                return true;
            });
            
            // Ordina usando la nuova funzione globale
            filteredOrders = sortOrdersByDisplayId(filteredOrders, true);
            
            // Header riga 2 - Totali
            let header2HTML = '';
            allItems.forEach((itemName, idx) => {
                const total = filteredOrders.reduce((sum, order) => {
                    return sum + order.itemsList.filter(i => i.name.split('(')[0].trim() === itemName).length;
                }, 0);
                
                // Stessa logica di divisione
                const halfPoint = Math.ceil(allItems.length / 2);
                const partClass = idx < halfPoint ? 'print-show-part-1' : 'print-show-part-2';
                
                const colIndex = 8 + idx;
                header2HTML += `<th class="border p-1 bg-blue-700 item-col ${partClass}" data-col-index="${colIndex}" style="font-size: 10px;">${total}</th>`;
            });
            headerRow2.innerHTML = header2HTML;
            
            // Popola tbody
            tbody.innerHTML = '';
            filteredOrders.forEach(order => {
                const tr = document.createElement('tr');
                tr.className = 'border hover:bg-gray-50';
                
                const borsoneZaino = order.itemsList.find(i => i.name.includes('Borsone')) ? 'Borsone' : 
                                    order.itemsList.find(i => i.name.includes('Zaino')) ? 'Zaino' : '-';
                
                // Funzione per pulire le note
                const cleanNotes = (notes) => {
                    if (!notes) return '-';
                    
                    let cleaned = notes;
                    
                    // Rimuovi "NON APPLICABILE PER LA TIPOLOGIA DI ORDINE" con tutte le varianti di spazi/newline
                    cleaned = cleaned.replace(/NON\s*APPLICABILE\s*PER\s*LA\s*TIPOLOGIA\s*DI\s*ORDINE/gi, '');
                    
                    // Rimuovi righe vuote multiple
                    cleaned = cleaned.replace(/\n\s*\n/g, '\n').trim();
                    
                    // Se la nota √® ora vuota, ritorna '-'
                    if (!cleaned || cleaned === '') return '-';
                    
                    // Se contiene l'emoji üì¶ e "Scalato da magazzino"
                    if (cleaned.includes('üì¶') && (cleaned.includes('Scalato da magazzino') || cleaned.includes('Inventario scalato'))) {
                        // Estrai solo la riga con data
                        const lines = cleaned.split('\n');
                        const firstLine = lines[0];
                        
                        // Cerca la data nel formato gg/mm/yyyy, hh:mm:ss o gg/mm/yyyy
                        const dateMatch = firstLine.match(/\d{2}\/\d{2}\/\d{4}(?:,?\s+\d{2}:\d{2}(?::\d{2})?)?/);
                        if (dateMatch) {
                            const dateStr = dateMatch[0].replace(',', '');
                            return `Scalato da magazzino il ${dateStr}`;
                        }
                        return 'Scalato da magazzino';
                    }
                    
                    // Altrimenti rimuovi solo emoji e righe di articoli scalati
                    cleaned = cleaned.replace(/üì¶/g, '').trim();
                    
                    // Se contiene "Articoli scalati:" rimuovi tutto da l√¨ in poi
                    if (cleaned.includes('Articoli scalati:')) {
                        const beforeArticles = cleaned.split('Articoli scalati:')[0].trim();
                        // Cerca la data
                        const dateMatch = beforeArticles.match(/\d{2}\/\d{2}\/\d{4}(?:,?\s+\d{2}:\d{2}(?::\d{2})?)?/);
                        if (dateMatch && (beforeArticles.includes('Scalato') || beforeArticles.includes('Inventario'))) {
                            const dateStr = dateMatch[0].replace(',', '');
                            return `Scalato da magazzino il ${dateStr}`;
                        }
                        return beforeArticles || '-';
                    }
                    
                    return cleaned.trim() || '-';
                };
                
                // Pulisci mainSize rimuovendo "NON APPLICABILE"
                let cleanMainSize = order.mainSize || '-';
                if (cleanMainSize && cleanMainSize.includes('NON APPLICABILE')) {
                    cleanMainSize = '-';
                }
                
                // Pulisci sockSize rimuovendo "NON APPLICABILE"
                let cleanSockSize = order.sockSize || '-';
                if (cleanSockSize && cleanSockSize.includes('NON APPLICABILE')) {
                    cleanSockSize = '-';
                }
                
                
                // Crea chiave per Borsone/Zaino
                const borsoneZainoCellKey = `${order.id}_BorsoneZaino_${borsoneZaino}`;
                const isBorsoneZainoHighlighted = highlightedSizeCells[borsoneZainoCellKey] === true;
                const borsoneZainoHighlightClass = isBorsoneZainoHighlighted ? 'size-cell-highlighted' : '';
                
                let html = `
                    <td class="border p-1 text-center tabella-ordini-sticky-col-1" style="font-size: 10px;">${order.displayId}</td>
                    <td class="border p-1 tabella-ordini-sticky-col-2" style="font-size: 10px;">${order.customer}</td>
                    <td class="border p-1 text-center" style="font-size: 10px;">${cleanMainSize}</td>
                    <td class="border p-1 text-center" style="font-size: 10px;">${cleanSockSize}</td>
                    <td class="border p-1 text-center" style="font-size: 10px;">UNICA</td>
                    <td class="border p-1" style="font-size: 9px;">${order.kitType || 'Personalizzato'}</td>
                    <td class="border p-1" style="font-size: 9px; max-width: 100px; overflow: hidden; text-overflow: ellipsis;">${cleanNotes(order.notes)}</td>
                    <td class="border p-1 text-center size-cell-clickable ${borsoneZainoHighlightClass}" 
                        data-order-id="${order.id}" 
                        data-item-name="BorsoneZaino" 
                        data-size="${borsoneZaino}"
                        onclick="toggleSizeCellHighlight(this, '${order.id}', 'BorsoneZaino', '${borsoneZaino}')" 
                        style="font-size: 10px;">${borsoneZaino}</td>
                    <td class="border p-1 text-center" style="font-size: 10px;">
                        <button onclick="downloadOrderToGoogleForm(${order.id})" class="download-google-form-btn text-green-600 hover:text-green-800" title="Scarica tramite Google Form">
                            <i class="fas fa-download"></i>
                        </button>
                    </td>
                `;
                
                allItems.forEach((itemName, idx) => {
                    const item = order.itemsList.find(i => {
                        if (!i || !i.name || typeof i.name !== 'string') return false;
                        const priceMatch = i.name.match(/\s*\(\d+‚Ç¨\)\s*$/);
                        const cleanName = priceMatch ? i.name.substring(0, i.name.lastIndexOf(priceMatch[0])).trim() : i.name;
                        return cleanName === itemName;
                    });
                    const size = item ? item.size : '';
                    
                    // Stessa logica di divisione
                    const halfPoint = Math.ceil(allItems.length / 2);
                    const partClass = idx < halfPoint ? 'print-show-part-1' : 'print-show-part-2';
                    
                    const colIndex = 8 + idx;
                    
                    // Crea una chiave univoca per questa cella
                    const cellKey = `${order.id}_${itemName}_${size}`;
                    const isHighlighted = highlightedSizeCells[cellKey] === true;
                    const highlightClass = isHighlighted ? 'size-cell-highlighted' : '';
                    
                    html += `<td class="border p-1 text-center item-col size-cell-clickable ${partClass} ${highlightClass}" 
                                data-col-index="${colIndex}" 
                                data-order-id="${order.id}" 
                                data-item-name="${itemName}" 
                                data-size="${size}"
                                onclick="toggleSizeCellHighlight(this, '${order.id}', '${itemName.replace(/'/g, "\\'")}', '${size}')" 
                                style="font-size: 10px;">${size}</td>`;
                });
                
                tr.innerHTML = html;
                tbody.appendChild(tr);
            });
        }
        
        function importFromGoogleSheet() {
            if (!checkPermission('importGoogle')) {
                alert('‚ö†Ô∏è Non hai i permessi per importare da Google.');
                return;
            }
            // ID del Google Sheet
            const SHEET_ID = '19ZKCyVFR_ncL8fn0h7myg3jpBfl_4VfD5TkFvTpI5FI';
            const GID = '2068656898'; // Foglio "Risposte del modulo 1"
            
            // URL per esportare come CSV
            const csvUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID}`;
            
            // Usa un proxy CORS pi√π affidabile
            const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(csvUrl)}`;
            
            console.log('üîÑ Inizio importazione da Google Sheet...');
            console.log('üì° URL proxy:', proxyUrl);
            
            fetch(proxyUrl)
                .then(response => {
                    console.log('üì° Risposta ricevuta:', response.status);
                    if (!response.ok) {
                        throw new Error('Impossibile accedere al Google Sheet. Verifica che sia pubblico.');
                    }
                    return response.text();
                })
                .then(csvText => {
                    console.log('üìÑ CSV scaricato, lunghezza:', csvText.length);
                    
                    // Converti CSV in array di righe
                    const rows = [];
                    const lines = csvText.split('\n');
                    
                    lines.forEach(line => {
                        if (!line.trim()) return; // Salta righe vuote
                        
                        const cells = [];
                        let cell = '';
                        let inQuotes = false;
                        
                        for (let i = 0; i < line.length; i++) {
                            const char = line[i];
                            
                            if (char === '"') {
                                if (inQuotes && line[i + 1] === '"') {
                                    // Doppia virgoletta = virgoletta letterale
                                    cell += '"';
                                    i++; // Salta la prossima virgoletta
                                } else {
                                    inQuotes = !inQuotes;
                                }
                            } else if (char === ',' && !inQuotes) {
                                cells.push(cell);
                                cell = '';
                            } else {
                                cell += char;
                            }
                        }
                        cells.push(cell); // Aggiungi l'ultima cella
                        rows.push(cells);
                    });
                    
                    console.log('üìä Righe processate:', rows.length);
                    console.log('üìã Prima riga (header):', rows[0]);
                    
                    if (rows.length < 2) {
                        throw new Error('Il foglio √® vuoto o non contiene dati validi.');
                    }
                    
                    // Usa la funzione esistente per processare l'import
                    processImport(rows);
                    
                    const importedCount = rows.length - 1;
                    console.log('‚úÖ Importazione completata:', importedCount, 'ordini');
                    
                    alert('‚úÖ Importazione completata!\n\n' + 
                          `Righe elaborate: ${importedCount}\n` +
                          'Controlla la tabella per vedere i nuovi ordini.');
                    
                    // Aggiorna la visualizzazione
                    updateUI();
                    resetFiltersToDefault();
                })
                .catch(error => {
                    console.error('‚ùå Errore durante l\'importazione:', error);
                    
                    alert('‚ùå Errore durante l\'importazione!\n\n' + 
                          error.message + '\n\n' +
                          'Verifica che:\n' +
                          '1. Il Google Sheet sia pubblico (Condividi ‚Üí Chiunque con il link)\n' +
                          '2. La connessione internet sia attiva\n' +
                          '3. Il foglio contenga dati validi\n\n' +
                          'Controlla la Console (F12) per dettagli tecnici.');
                });
        }
        
        function fixOldTimestamps() {
            if (!confirm('üîß UNIFORMA FORMATO DATA/ORA\n\nQuesta funzione uniforma tutti i timestamp al formato:\nYYYY-MM-DD HH:mm:00.000\n\nGestisce:\n‚úÖ Numeri seriali Excel\n‚úÖ Formato Google (DD/MM/YYYY)\n‚úÖ Formato database (YYYY-MM-DD)\n‚úÖ Correzione orari sbagliati (+1 ora)\n‚úÖ Arrotondamento al minuto\n\nContinuare?')) {
                return;
            }
            
            let excelCount = 0;
            let normalizedCount = 0;
            let correctedCount = 0;
            let totalCount = 0;
            
            orders.forEach((order, index) => {
                if (!order.timestamp || !order.importKey) {
                    return;
                }
                
                const oldTimestamp = order.timestamp;
                let newTimestamp = '';
                let needsHourCorrection = false;
                let year, month, day, hour, minute;
                
                // STEP 1: Identifica il formato e converti
                
                // Formato A: Numero seriale Excel (es: 45989.3026614476)
                const excelSerialMatch = oldTimestamp.toString().match(/^(\d+\.?\d*)$/);
                if (excelSerialMatch) {
                    const excelSerial = parseFloat(excelSerialMatch[1]);
                    const excelEpoch = new Date(1899, 11, 30);
                    const jsDate = new Date(excelEpoch.getTime() + excelSerial * 86400000);
                    
                    year = jsDate.getFullYear();
                    month = (jsDate.getMonth() + 1).toString().padStart(2, '0');
                    day = jsDate.getDate().toString().padStart(2, '0');
                    hour = jsDate.getHours();
                    minute = jsDate.getMinutes().toString().padStart(2, '0');
                    
                    excelCount++;
                    needsHourCorrection = false;
                } 
                // Formato B: YYYY-MM-DD HH:mm:ss.ms (database)
                else {
                    let match = oldTimestamp.match(/^(\d{4})-(\d{2})-(\d{2})\s+(\d{2}):(\d{2}):(\d{2})\.(\d{3})$/);
                    if (match) {
                        year = match[1];
                        month = match[2];
                        day = match[3];
                        hour = parseInt(match[4]);
                        minute = match[5];
                        needsHourCorrection = false; // NON correggere pi√π - gli ordini sono gi√† stati corretti
                    } 
                    // Formato C: DD/MM/YYYY HH.mm.ss (Google Sheet con punti)
                    else {
                        match = oldTimestamp.match(/^(\d{2})\/(\d{2})\/(\d{4})\s+(\d{1,2})\.(\d{2})\.(\d{2})$/);
                        if (match) {
                            day = match[1];
                            month = match[2];
                            year = match[3];
                            hour = parseInt(match[4]);
                            minute = match[5];
                            normalizedCount++;
                            needsHourCorrection = false;
                        } else {
                            // Formato D: DD/MM/YYYY HH:mm:ss (creati dall'app con due punti)
                            match = oldTimestamp.match(/^(\d{2})\/(\d{2})\/(\d{4})\s+(\d{1,2}):(\d{2}):(\d{2})$/);
                            if (match) {
                                day = match[1];
                                month = match[2];
                                year = match[3];
                                hour = parseInt(match[4]);
                                minute = match[5];
                                normalizedCount++;
                                needsHourCorrection = false;
                            } else {
                                return; // Formato non riconosciuto
                            }
                        }
                    }
                }
                
                // STEP 2: Correggi l'ora se necessario
                if (needsHourCorrection) {
                    hour = (hour + 1) % 24;
                    correctedCount++;
                }
                
                // STEP 3: Crea timestamp uniforme (arrotondato al minuto)
                const hourStr = hour.toString().padStart(2, '0');
                newTimestamp = `${year}-${month}-${day} ${hourStr}:${minute}:00.000`;
                
                // STEP 4: Aggiorna se diverso
                if (newTimestamp !== oldTimestamp) {
                    order.timestamp = newTimestamp;
                    order.importKey = newTimestamp;
                    totalCount++;
                }
            });
            
            // Salva
            saveData();
            updateUI();
            
            // Messaggio finale
            let msg = `‚úÖ UNIFORMAZIONE COMPLETATA!\n\n`;
            msg += `üìä Ordini elaborati: ${orders.length}\n`;
            msg += `üîÑ Timestamp modificati: ${totalCount}\n\n`;
            if (excelCount > 0) msg += `üìä Excel serials convertiti: ${excelCount}\n`;
            if (normalizedCount > 0) msg += `üìÖ Formati Google convertiti: ${normalizedCount}\n`;
            if (correctedCount > 0) msg += `üïê Orari corretti (+1h): ${correctedCount}\n`;
            msg += `\n‚úÖ Tutti i timestamp ora hanno il formato:\nYYYY-MM-DD HH:mm:00.000`;
            
            alert(msg);
        }
        
        function subtractOneHour() {
            if (!confirm('‚è™ SOTTRAI 1 ORA\n\nQuesta funzione sottrae 1 ora a TUTTI i timestamp.\n\nUsala se hai cliccato "Correggi Orari" due volte per errore.\n\nContinuare?')) {
                return;
            }
            
            let correctedCount = 0;
            
            orders.forEach((order, index) => {
                if (!order.timestamp || !order.importKey) {
                    return;
                }
                
                const oldTimestamp = order.timestamp;
                
                // Parse del formato: YYYY-MM-DD HH:mm:ss.ms
                const match = oldTimestamp.match(/^(\d{4})-(\d{2})-(\d{2})\s+(\d{2}):(\d{2}):(\d{2})\.(\d{3})$/);
                
                if (match) {
                    const year = match[1];
                    const month = match[2];
                    const day = match[3];
                    let hour = parseInt(match[4]);
                    const minute = match[5];
                    const second = match[6];
                    const ms = match[7];
                    
                    // Sottrai 1 ora
                    hour = (hour - 1 + 24) % 24; // +24 per gestire ore negative (es: 0 - 1 = 23)
                    const hourStr = hour.toString().padStart(2, '0');
                    
                    const newTimestamp = `${year}-${month}-${day} ${hourStr}:${minute}:${second}.${ms}`;
                    
                    // Aggiorna
                    order.timestamp = newTimestamp;
                    order.importKey = newTimestamp;
                    correctedCount++;
                }
            });
            
            // Salva
            saveData();
            updateUI();
            
            alert(`‚úÖ Correzione completata!\n\nüïê Ordini corretti (-1h): ${correctedCount}\nüìä Totale: ${orders.length}`);
        }
        
        async function loadData() {
    try {
        // Load orders
        const ordersRes = await fetch('/api/orders');
        if (ordersRes.ok) {
            const ordersData = await ordersRes.json();
            if (ordersData.success && ordersData.data) {
                orders = ordersData.data.orders || [];
                lastOrderId = ordersData.data.lastOrderId || 0;
                currentPrefix = ordersData.data.currentPrefix || 'R68-';
                highlightedSizeCells = ordersData.data.highlightedSizeCells || {};
            }
        }
        
        // Load inventory
        const invRes = await fetch('/api/inventory');
        if (invRes.ok) {
            const invData = await invRes.json();
            if (invData.success && invData.data) {
                inventory = invData.data.inventory || {};
            }
        }
        
        // Load config
        const configRes = await fetch('/api/config');
        if (configRes.ok) {
            const configData = await configRes.json();
            if (configData.success && configData.data) {
                globalItems = configData.data.globalItems || [...DEFAULT_ITEMS_LIST];
                globalKitTypes = configData.data.globalKitTypes || JSON.parse(JSON.stringify(DEFAULT_KIT_DEFINITIONS));
                quickIdFilters = configData.data.quickIdFilters || {};
            }
        }
        
        // Initialize defaults if empty
        if (globalItems.length === 0) {
            globalItems = [...DEFAULT_ITEMS_LIST];
        }
        if (Object.keys(globalKitTypes).length === 0) {
            globalKitTypes = JSON.parse(JSON.stringify(DEFAULT_KIT_DEFINITIONS));
        }
        
        // Repair import keys
        repairAllImportKeys();
        renderKitFilterOptions();
        initQuickIdButtons(); // Inizializza i pulsanti Quick ID dopo aver caricato i filtri
        await saveData();
    } catch (error) {
        console.error('Error loading data:', error);
        alert('Errore nel caricamento dei dati');
    }
}
        
        // ===== SISTEMA NOTIFICHE =====
        function showQuickNotification(message, type = 'info') {
            // Crea elemento notifica
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 z-[10000] px-6 py-3 rounded-lg shadow-lg text-white font-bold flex items-center gap-2 transition-all';
            
            // Colore in base al tipo
            const colors = {
                'success': 'bg-green-600',
                'error': 'bg-red-600',
                'warning': 'bg-yellow-600',
                'info': 'bg-blue-600'
            };
            notification.classList.add(colors[type] || colors.info);
            
            // Icona in base al tipo
            const icons = {
                'success': '‚úÖ',
                'error': '‚ùå',
                'warning': '‚ö†Ô∏è',
                'info': '‚ÑπÔ∏è'
            };
            
            notification.innerHTML = `
                <span class="text-xl">${icons[type] || icons.info}</span>
                <span>${message}</span>
            `;
            
            // Aggiungi al body
            document.body.appendChild(notification);
            
            // Animazione entrata
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
                notification.style.opacity = '1';
            }, 10);
            
            // Rimuovi dopo 3 secondi
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // ===== SISTEMA AUTO-REFRESH =====
        let autoRefreshInterval = null;
        let lastDataHash = null;
        
       // Calcola un hash semplice dei dati per rilevare modifiche
       function getDataHash() {
         return JSON.stringify({
           ordersCount: orders.length,
           lastOrderId: lastOrderId,
           ordersData: orders.map(o => ({
             id: o.id,
             status: o.status,
             customer: o.customer,
             kitType: o.kitType,
             mainSize: o.mainSize,
             sockSize: o.sockSize,
             notes: o.notes,
             itemsCount: o.itemsList?.length || 0,
             linkedId: o.linkedId,
             partialDeliveryNote: o.partialDeliveryNote
           })),
           inventoryKeys: Object.keys(inventory).sort().join('|')
         });
       }
        
        // Funzione di auto-refresh silenziosa
        async function autoRefreshData() {
            try {
                // Salva posizione scroll
                const scrollPos = window.scrollY;
                
                // Carica dati senza chiamare saveData
                const ordersRes = await fetch('/api/orders');
                if (ordersRes.ok) {
                    const ordersData = await ordersRes.json();
                    if (ordersData.success && ordersData.data) {
                        const newHash = JSON.stringify({
                            ordersCount: ordersData.data.orders?.length || 0,
                            lastOrderId: ordersData.data.lastOrderId || 0,
                            ordersData: (ordersData.data.orders || []).map(o => ({
                                id: o.id,
                                status: o.status,
                                itemsCount: o.itemsList?.length || 0
                            }))
                        });
                        
                        // Controlla se ci sono modifiche
                        if (lastDataHash && newHash !== lastDataHash) {
                            console.log('üîÑ Dati aggiornati da altro utente');
                            
                            // Aggiorna i dati
                            orders = ordersData.data.orders || [];
                            lastOrderId = ordersData.data.lastOrderId || 0;
                            currentPrefix = ordersData.data.currentPrefix || 'R68-';
                            highlightedSizeCells = ordersData.data.highlightedSizeCells || {};
                            
                            // Re-render UI
                            updateUI();
                            
                            // Mostra notifica
                            showQuickNotification('üîÑ Dati aggiornati', 'info');
                            
                            // Ripristina scroll
                            setTimeout(() => window.scrollTo(0, scrollPos), 100);
                        }
                        
                        lastDataHash = newHash;
                    }
                }
                
                // Carica anche inventory
                const invRes = await fetch('/api/inventory');
                if (invRes.ok) {
                    const invData = await invRes.json();
                    if (invData.success && invData.data) {
                        inventory = invData.data.inventory || {};
                    }
                }
                
            } catch (error) {
                console.warn('‚ö†Ô∏è Auto-refresh error:', error);
            }
        }
        
        // Avvia auto-refresh
        function startAutoRefresh() {
            // Ferma eventuale refresh precedente
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            // Inizializza hash
            lastDataHash = getDataHash();
            
            // Avvia polling ogni 30 secondi
            autoRefreshInterval = setInterval(autoRefreshData, 30000);
            console.log('‚úÖ Auto-refresh attivo (ogni 30 secondi)');
        }
        
        // Ferma auto-refresh
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                console.log('‚è∏Ô∏è Auto-refresh fermato');
            }
        }
        
        // ===== FINE SISTEMA AUTO-REFRESH =====
        
        // NUOVA FUNZIONE: Ripara tutti gli importKey per evitare duplicati all'importazione
        function repairAllImportKeys() {
            let repairedCount = 0;
            orders.forEach(o => {
                if (o.timestamp) {
                    const oldKey = o.importKey;
                    // USA TIMESTAMP ESATTO (NON arrotondare)
                    o.importKey = o.timestamp;
                    if (oldKey !== o.importKey) {
                        repairedCount++;
                    }
                } else if (o.displayId && !o.importKey) {
                    // Se non ha timestamp, usa displayId come fallback
                    o.importKey = o.displayId;
                }
            });
            
            if (repairedCount > 0) {
                console.log(`üîß Riparati automaticamente ${repairedCount} importKey al caricamento`);
            }
        }
        
        // FUNZIONE HELPER: Normalizza qualsiasi timestamp al formato YYYY-MM-DD HH:mm:00.000
        function normalizeTimestampToMinute(timestamp) {
            if (!timestamp || typeof timestamp !== 'string') {
                return timestamp;
            }
            
            // Formato 1: YYYY-MM-DD HH:mm:ss.ms ‚Üí YYYY-MM-DD HH:mm:00.000
            let match = timestamp.match(/^(\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}):\d{2}\.\d{3}$/);
            if (match) {
                return match[1] + ':00.000';
            }
            
            // Formato 2: YYYY-MM-DD HH:mm:ss (senza millisecondi) ‚Üí YYYY-MM-DD HH:mm:00.000
            match = timestamp.match(/^(\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}):\d{2}$/);
            if (match) {
                return match[1] + ':00.000';
            }
            
            // Formato 3: DD/MM/YYYY HH.mm.ss ‚Üí YYYY-MM-DD HH:mm:00.000
            match = timestamp.match(/^(\d{2})\/(\d{2})\/(\d{4})\s+(\d{1,2})\.(\d{2})\.\d{2}$/);
            if (match) {
                const day = match[1];
                const month = match[2];
                const year = match[3];
                const hour = match[4].padStart(2, '0');
                const minute = match[5];
                return `${year}-${month}-${day} ${hour}:${minute}:00.000`;
            }
            
            // Formato 4: DD/MM/YYYY HH:mm:ss ‚Üí YYYY-MM-DD HH:mm:00.000
            match = timestamp.match(/^(\d{2})\/(\d{2})\/(\d{4})\s+(\d{1,2}):(\d{2}):\d{2}$/);
            if (match) {
                const day = match[1];
                const month = match[2];
                const year = match[3];
                const hour = match[4].padStart(2, '0');
                const minute = match[5];
                return `${year}-${month}-${day} ${hour}:${minute}:00.000`;
            }
            
            // Formato 5: Gi√† normalizzato YYYY-MM-DD HH:mm:00.000 ‚Üí mantieni cos√¨
            match = timestamp.match(/^(\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}):00\.000$/);
            if (match) {
                return timestamp; // Gi√† corretto
            }
            
            // Formato 6: YYYY-MM-DD HH:mm (senza secondi) ‚Üí YYYY-MM-DD HH:mm:00.000
            match = timestamp.match(/^(\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2})$/);
            if (match) {
                return match[1] + ':00.000';
            }
            
            // Se non matcha nessun pattern, prova a estrarre almeno YYYY-MM-DD HH:mm
            match = timestamp.match(/(\d{4})-(\d{2})-(\d{2})\s+(\d{2}):(\d{2})/);
            if (match) {
                return `${match[1]}-${match[2]}-${match[3]} ${match[4]}:${match[5]}:00.000`;
            }
            
            // Fallback: restituisci cos√¨ com'√®
            console.warn(`‚ö†Ô∏è Timestamp non riconosciuto: "${timestamp}"`);
            return timestamp;
        }
        
        // NUOVA FUNZIONE: Riparazione manuale degli importKey (con messaggio)
        function manualRepairImportKeys() {
            if (!confirm('üîß RIPARA IMPORTKEY\n\nQuesta funzione aggiorna tutti gli importKey per evitare duplicati durante l\'importazione.\n\nUSA IL TIMESTAMP ESATTO (mantiene secondi e millisecondi).\n\nContinuare?')) {
                return;
            }
            
            let repairedCount = 0;
            let noTimestampCount = 0;
            
            orders.forEach(o => {
                if (o.timestamp) {
                    const oldKey = o.importKey;
                    
                    // USA TIMESTAMP ESATTO (NON arrotondare)
                    o.importKey = o.timestamp;
                    
                    if (oldKey !== o.importKey) {
                        repairedCount++;
                    }
                } else if (o.displayId && !o.importKey) {
                    // Se non ha timestamp, usa displayId come fallback
                    o.importKey = o.displayId;
                    noTimestampCount++;
                }
            });
            
            saveData();
            
            let msg = `‚úÖ RIPARAZIONE COMPLETATA!\n\n`;
            msg += `üìä Totale ordini: ${orders.length}\n`;
            msg += `üîß ImportKey riparati: ${repairedCount}\n`;
            if (noTimestampCount > 0) {
                msg += `‚ö†Ô∏è Ordini senza timestamp (usato displayId): ${noTimestampCount}\n`;
            }
            msg += `\n‚úÖ Tutti gli importKey ora usano il timestamp ESATTO.\n`;
            msg += `(secondi e millisecondi mantenuti)\n`;
            msg += `Esempio: 2025-09-22 14:12:38.000 rimane cos√¨\n\n`;
            msg += `I prossimi import non dovrebbero creare duplicati.`;
            
            alert(msg);
        }
        
        async function saveData() {
            try {
                // Save orders
                await fetch('/api/orders', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'save', 
                        orders,
                        lastOrderId,
                        currentPrefix,
                        highlightedSizeCells
                    })
                });
                // Registra nel log
                logActivity('Salvataggio dati', `Ordini: ${orders.length}, Articoli: ${Object.keys(inventory).length}`);
                
                // Save inventory
                await fetch('/api/inventory', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'save', 
                        inventory 
                    })
                });
                
                // Save config (include quickIdFilters)
                await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'save', 
                        globalItems,
                        globalKitTypes,
                        quickIdFilters
                    })
                });
                
                console.log('Data saved successfully');
            } catch (error) {
                console.error('Error saving data:', error);
            }
        }
      // Funzione per registrare un'azione nello storico
       function logActivity(action, description, details = {}) {
        const logs = JSON.parse(localStorage.getItem('orderFlowActivityLog') || '[]');
        const logEntry = {
        timestamp: new Date().toISOString(),
        user: currentUser ? currentUser.username : 'Sistema',
        userName: currentUser ? currentUser.name : 'Sistema',
        action: action,
        description: description,
        details: details
      };
        logs.unshift(logEntry);
        if (logs.length > 100) {
        logs.splice(100);
    }
    localStorage.setItem('orderFlowActivityLog', JSON.stringify(logs));
        }
        function generateNewId(isManual = false) { lastOrderId++; saveData(); const sequence = lastOrderId.toString().padStart(3, '0');
        return isManual ? `MAN-${sequence}` : `${currentPrefix}${sequence}`; }
        
        function updatePrefixAndID() { 
            const inputEl = document.getElementById('startPrefixInput');
            const input = inputEl.value.trim(); 
            if(!input) { inputEl.value = ''; return; }
            const match = input.match(/^(\d{4}[A]?_)((\d+))$/i);
            if(match){ 
                const newPrefix=match[1].toUpperCase();
                const newStartId=parseInt(match[2]); 
                if(newPrefix!==currentPrefix){ currentPrefix=newPrefix; lastOrderId=newStartId-1; alert(`Nuovo Prefisso: ${currentPrefix} impostato.`); } 
                else if(newStartId-1>lastOrderId){ lastOrderId=newStartId-1; alert(`ID Sequenza aggiornato.`); } 
                else { alert(`Nessuna modifica.`); }
                saveData(); inputEl.value = '';
            } else { alert('ERRORE: Formato ID non valido.'); }
        }

        function updateOrderType(id, newType) {
            const o = orders.find(x => x.id === id);
            if (!o) return;
            o.type = newType;
            updateUI();
        }
        
        function updateContactInfo(field, val) {
            const o = orders.find(x => x.id === currentEditId);
            if (!o) return;
            if (field === 'email') o.email = val.trim();
            if (field === 'phone') o.phone = val.trim();
            saveData();
        }

        function updateOrderField(id, field, value) { 
            const o = orders.find(x => x.id === id);
            if (!o) return; 
            if (field === 'displayId') { 
                const newValue = value.toUpperCase().trim();
                if (orders.some(x => x.displayId === newValue && x.id !== id)) { alert(`ID esistente.`); renderTable(); return; } 
                o.displayId = newValue;
            } else if (field === 'customer') {
                // Rimuovi newline e spazi multipli, unisci con uno spazio
                const cleanValue = value.replace(/\n/g, ' ').replace(/\s+/g, ' ').trim();
                o.customer = cleanValue;
            }
            else if (field === 'roleOrYear') o.roleOrYear = value.trim();
            else if (field === 'kitType') { 
                o.kitType = value;
                if (value.toLowerCase().includes('staff') || value.toLowerCase().includes('allenatore') || value.toLowerCase().includes('dirigente')) o.type = 'Staff'; else o.type = 'Giocatore';
            } else if (field === 'notes') o.notes = value.trim(); 
            updateUI();
        }

        function clearAllOrders() { 
            if (!checkPermission('resetData')) {
                alert('‚ö†Ô∏è Non hai i permessi per resettare i dati.');
                return;
            }
            if (confirm("Reset completo?")) { 
                const orderCount = orders.length;
                orders = []; 
                inventory={};
                
                logActivity('RESET_DATA', `Reset completo sistema - Eliminati ${orderCount} ordini`);
                
                updateUI();
        highlightedSizeCells = {}; lastOrderId = 0; localStorage.clear(); location.reload(); } }
        function extractKitName(input) { if (!input) return null;
        const match = input.match(/^(.*?)\s*\(/); return (match && match[1].trim()) ? match[1].trim() : input.trim(); }
        function updateSizes(id, t, v) { const o = orders.find(x=>x.id===id); if (!o) return; v = v.toUpperCase().trim(); if (t === 'sock') { if (v === 'UNICA') return alert('Taglia non valida'); o.sockSize = v; o.itemsList.forEach(i => { if(isSockItem(i.name)) i.size=v; }); } if(t==='main') { o.mainSize = v; o.itemsList.forEach(i=>{ if(!isSockItem(i.name) && !i.name.includes("Borsone") && !i.name.includes("Zaino") && !i.name.includes("Cappellino") && !i.name.includes("Scaldacollo") && !i.name.includes("Guanti")) i.size=v; }); } updateUI(); }
        function updateInventory(itemName, size, value) { const key = `${itemName}_${size}`; if(value === "" || value === null) delete inventory[key]; else inventory[key] = parseInt(value); saveData(); renderMatrices(true); }
        function getPriceFromString(str) { if (!str || typeof str !== 'string') return 0; const match = str.match(/\((\d+)‚Ç¨\)/); return match ? parseInt(match[1]) : 0; }
        function getBagType(items) { const bag = items.find(i => i.name.includes('Borsone') || i.name.includes('Zaino'));
        if (!bag) return ''; return bag.name.includes('Zaino') ? 'Zaino' : 'Borsone'; }
        function updateDiscount(id, val) { const o = orders.find(x => x.id === id);
        if (!o) return; o.discount = parseInt(val) || 0; updateUI(); }
        
        function calculateOrderTotal(o) {
            if (!o) return 0;
            
            let kitPrice = getPriceFromString(o.kitType);
            
            if (kitPrice === 0 && o.kitType && typeof o.kitType === 'string') { 
                for (const key in globalKitTypes) { 
                    const cleanNameDB = globalKitTypes[key].display.split('(')[0].trim(); 
                    const cleanNameOrder = o.kitType.split('(')[0].trim(); 
                    if (cleanNameDB === cleanNameOrder) { 
                        kitPrice = getPriceFromString(globalKitTypes[key].display); 
                        o.kitType = globalKitTypes[key].display; 
                        break; 
                    } 
                } 
            }
            
            if (kitPrice === 0 && o.itemsList && Array.isArray(o.itemsList)) { 
                o.itemsList.forEach(i => {
                    if (i && i.name) {
                        kitPrice += getPriceFromString(i.name);
                    }
                }); 
            }
            
            const discount = o.discount || 0; 
            return Math.max(0, kitPrice - discount);
        }

        function renderKitFilterOptions() {
            const select = document.getElementById('filterKitType');
            const currentVal = select.value;
            select.innerHTML = '<option value="all">Tipo Ordine: Tutti</option>';
            Object.values(globalKitTypes).forEach(kit => {
                if (kit && kit.display && typeof kit.display === 'string') {
                    select.innerHTML += `<option value="${kit.display}">${kit.display.split('(')[0].trim()}</option>`;
                }
            });
            const extras = ['Abbigliamento Singolo', 'Personalizzato'];
            extras.forEach(e => {
                select.innerHTML += `<option value="${e}">${e}</option>`;
            });
            if(currentVal) select.value = currentVal;
        }

        function getAvailableKitOptionsHTML(selected) {
             let html = '';
             Object.values(globalKitTypes).forEach(kit => {
                 html += `<option value="${kit.display}" ${selected===kit.display?'selected':''}>${kit.display}</option>`;
             });
             ['Abbigliamento Singolo', 'Personalizzato'].forEach(k => {
                 html += `<option value="${k}" ${selected===k?'selected':''}>${k}</option>`;
             });
             return html;
        }

        document.getElementById('fileInput').addEventListener('change', function(e) { 
            try { 
                const file = e.target.files[0]; 
                const reader = new FileReader(); 
                reader.onload = function(e) { 
                    try { 
                        const data = new Uint8Array(e.target.result); 
                        const wb = XLSX.read(data, {type: 'array'}); 
                        
                        // Leggi primo foglio (ordini)
                        const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header: 1}); 
                        processImport(rows, wb); // Passa anche workbook per leggere magazzino
                    } catch(err) { 
                        alert(`ERRORE FILE: ${err.message}`); 
                    } 
                }; 
                reader.readAsArrayBuffer(file); 
            } catch (err) { 
                alert(`ERRORE IMPORT: ${err.message}`); 
            }
        });

        function processImport(rows, wb) {
            if (!rows || rows.length < 2) return alert("File vuoto.");
            const header = rows[0].map(c => c ? c.toString().toLowerCase() : "");
            let isGestioneOrdini = false; let isGoogleForm = false;
            let isBackup = false;

            const checkArea = header.slice(0, 20);
            const hasId = checkArea[0] && checkArea[0].includes("id");
            const hasClienteOrTimestamp = (checkArea[1] && checkArea[1].includes("cliente")) || (checkArea[1] && checkArea[1].includes("timestamp") && checkArea[2] && checkArea[2].includes("cliente"));
            const hasRelevantCols = checkArea.some(h => h && (h.includes("email") || h.includes("kit") || h.includes("anno")));
            if (hasId && hasClienteOrTimestamp && hasRelevantCols) {
                isBackup = true;
            }
            else if (checkArea[0] && (checkArea[0].includes("informazioni") || checkArea[0].includes("timestamp"))) isGoogleForm = true;
            else if (checkArea.includes("id ordine")) isGestioneOrdini = true;
            else if (checkArea.includes("nome") && checkArea.includes("cognome")) { isGoogleForm = true; }

            // Funzione per arrotondare timestamp al minuto (rimuove secondi e millisecondi)
            // Gestisce anche importKey con formato: "Timestamp_Nome_Cognome"
            function roundToMinute(importKey) {
                if (!importKey || typeof importKey !== 'string') {
                    return importKey;
                }
                
                // Se l'importKey contiene "_" (formato: Timestamp_Nome_Cognome)
                if (importKey.includes('_')) {
                    const parts = importKey.split('_');
                    const timestamp = parts[0];
                    const resto = parts.slice(1).join('_'); // Nome_Cognome
                    
                    const roundedTimestamp = roundTimestampOnly(timestamp);
                    return `${roundedTimestamp}_${resto}`;
                }
                
                // Altrimenti √® solo un timestamp
                return roundTimestampOnly(importKey);
            }
            
            // Funzione helper per convertire timestamp mantenendo i secondi esatti
            function roundTimestampOnly(timestamp) {
                if (!timestamp || typeof timestamp !== 'string') {
                    return timestamp;
                }
                
                // Prova pattern: YYYY-MM-DD HH:mm:ss.ms (GI√Ä NEL FORMATO CORRETTO)
                let match = timestamp.match(/^\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}\.\d{3}$/);
                if (match) {
                    return timestamp; // Gi√† nel formato corretto
                }
                
                // Prova pattern senza millisecondi: YYYY-MM-DD HH:mm:ss
                match = timestamp.match(/^(\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2})$/);
                if (match) {
                    return match[1] + '.000'; // Aggiungi solo i millisecondi
                }
                
                // Pattern DD/MM/YYYY HH.mm.ss (Google con punti) - MANTIENI SECONDI
                match = timestamp.match(/^(\d{2})\/(\d{2})\/(\d{4})\s+(\d{1,2})\.(\d{2})\.(\d{2})$/);
                if (match) {
                    const day = match[1];
                    const month = match[2];
                    const year = match[3];
                    const hour = match[4].padStart(2, '0');
                    const minute = match[5];
                    const second = match[6]; // MANTIENI i secondi
                    return `${year}-${month}-${day} ${hour}:${minute}:${second}.000`;
                }
                
                // Pattern DD/MM/YYYY HH:mm:ss (Google con due punti) - MANTIENI SECONDI
                match = timestamp.match(/^(\d{2})\/(\d{2})\/(\d{4})\s+(\d{1,2}):(\d{2}):(\d{2})$/);
                if (match) {
                    const day = match[1];
                    const month = match[2];
                    const year = match[3];
                    const hour = match[4].padStart(2, '0');
                    const minute = match[5];
                    const second = match[6]; // MANTIENI i secondi
                    return `${year}-${month}-${day} ${hour}:${minute}:${second}.000`;
                }
                
                // Se non matcha nessun pattern, restituisci cos√¨ com'√®
                return timestamp;
            }

            const newOrUpdatedOrders = [];
            
            // STEP 1: Trova l'ULTIMO ordine nel database per data/ora
            let latestOrder = null;
            let latestTimestampDate = null;
            if (isGoogleForm && orders.length > 0) {
                // Ordina gli ordini per ID (dal pi√π alto al pi√π basso)
                const getNumId = (displayId) => {
                    const match = displayId.match(/(\d+)$/);
                    return match ? parseInt(match[1]) : 0;
                };
                
                // Usa ordinamento globale (decrescente per trovare l'ultimo)
                const sortedOrders = sortOrdersByDisplayId(orders, false);
                latestOrder = sortedOrders[0];
                
                if (latestOrder && latestOrder.timestamp) {
                    try {
                        // IMPORTANTE: Normalizza timestamp prima di creare Date object
                        const normalizedTimestamp = roundTimestampOnly(latestOrder.timestamp);
                        latestTimestampDate = new Date(normalizedTimestamp);
                        
                        console.log(`\nüïê === ULTIMO ORDINE NEL DATABASE ===`);
                        console.log(`ID: ${latestOrder.displayId}`);
                        console.log(`Cliente: ${latestOrder.customer}`);
                        console.log(`Timestamp originale: ${latestOrder.timestamp}`);
                        console.log(`Timestamp normalizzato: ${normalizedTimestamp}`);
                        console.log(`Date object: ${latestTimestampDate.toLocaleString('it-IT')}`);
                        console.log(`Valid? ${!isNaN(latestTimestampDate.getTime())}`);
                        console.log(`\nüìã Importer√≤ SOLO ordini con timestamp successivo`);
                    } catch (e) {
                        console.warn(`Errore timestamp: ${e.message}`);
                    }
                }
            }
            
            // STEP 2: Aggiorna TUTTI gli importKey usando timestamp ESATTO
            console.log(`\nüéØ === AGGIORNAMENTO IMPORTKEY ===`);
            console.log(`Totale ordini nel sistema: ${orders.length}`);
            
            orders.filter(o => o.timestamp).forEach(o => {
                // ImportKey = timestamp ESATTO (NON arrotondare)
                o.importKey = o.timestamp;
            });
            
            // STEP 2: Crea mappa con TUTTI gli importKey aggiornati
            const existingOrdersMap = new Map(
                orders.filter(o => o.importKey).map(o => [o.importKey, o])
            );
            
            console.log(`ImportKey creati: ${existingOrdersMap.size}`);
            console.log(`\nüìä === TUTTI I TIMESTAMP NEL DATABASE (primi 30) ===`);
            let count = 0;
            for (let [key, order] of existingOrdersMap) {
                if (count < 30) {
                    console.log(`  ${order.displayId}: "${key}" (length: ${key.length})`);
                    // Mostra ogni carattere
                    const chars = key.split('').map((c, i) => `[${i}]=${c.charCodeAt(0)}`).join(' ');
                    if (count < 3) console.log(`    Chars: ${chars}`);
                    count++;
                }
            }
            console.log();
            
            const manualOrders = orders.filter(o => !o.importKey); 
            
            console.log(`üì• Inizio import: ${rows.length - 1} righe da processare`);
            console.log(`üìä Ordini esistenti con importKey: ${existingOrdersMap.size}`);
            console.log(`üìä Ordini manuali: ${manualOrders.length}`);
            
            let ordersToProcess = rows.slice(1);
            let successCount = 0;
            let duplicateCount = 0;
            const newOrderIds = []; // Traccia gli ID degli ordini veramente nuovi

            ordersToProcess.forEach((row, i) => {
                try {
                    if (row.slice(0, 4).every(c => !c || c.toString().trim() === "")) return;

                    let importKey, customer, mainSize, sockSize, notes, inputs, kitDisplayName, type = 'Giocatore', itemsList = []; 
                    let linkedIdImport = null; // FIX: Dichiarazione variabile
                    let rowDisplayId = null; 
                    let bagChoice = null;
                    let discountImport = 0;
                    let statusImport = 'Nuovo';
                    let emailImport = '', phoneImport = '', roleOrYearImport = '';
                    let timestamp = null; // Dichiarazione timestamp per tutti i tipi di import
                    let rawTimestampForLog = null; // Per log debug
                    let accessorySize = 'UNICA'; // Taglia accessori (Cappellino, Scaldacollo, Guanti)
                    let noteColorImport = 'default';
                    let inventoryScaledAtImport = null;

                    if (isBackup) {
                        rowDisplayId = row[0] ? row[0].toString().trim() : generateNewId(true);
                        
                        // Trova indici colonne per nome (pi√π affidabile)
                        const findColIdx = (names) => {
                            for (let name of names) {
                                const idx = header.findIndex(h => h && h.toLowerCase().includes(name.toLowerCase()));
                                if (idx !== -1) return idx;
                            }
                            return -1;
                        };
                        
                        const idxTimestamp = findColIdx(['timestamp']);
                        const idxCliente = findColIdx(['cliente', 'customer']);
                        const idxAnnoRuolo = findColIdx(['anno', 'ruolo']);
                        const idxEmail = findColIdx(['email']);
                        const idxTelefono = findColIdx(['telefono', 'phone']);
                        const idxKit = findColIdx(['kit']);
                        const idxTaglia = findColIdx(['taglia']);
                        const idxCalze = findColIdx(['calze', 'sock']);
                        const idxNote = findColIdx(['note']);
                        const idxColoreNota = findColIdx(['colore nota', 'notecolor']);
                        const idxScalatoMag = findColIdx(['scalato', 'inventory']);
                        const idxStato = findColIdx(['stato', 'status']);
                        const idxSconto = findColIdx(['sconto', 'discount']);
                        const idxTrasferito = findColIdx(['trasferito', 'linked']);
                        const idxDettaglio = findColIdx(['dettaglio', 'articoli']);
                        
                        // Leggi valori usando gli indici trovati
                        timestamp = idxTimestamp !== -1 && row[idxTimestamp] ? row[idxTimestamp].toString().trim() : null;
                        rawTimestampForLog = timestamp; // Salva per log
                        
                        // USA IL TIMESTAMP ESATTO COME IMPORTKEY (NON arrotondare)
                        if (timestamp) {
                            importKey = timestamp;
                        } else {
                            // Fallback: usa l'ID se non c'√® timestamp
                            importKey = rowDisplayId;
                        }
                        
                        customer = idxCliente !== -1 && row[idxCliente] ? row[idxCliente].toString().trim() : "Cliente";
                        roleOrYearImport = idxAnnoRuolo !== -1 && row[idxAnnoRuolo] ? row[idxAnnoRuolo].toString().trim() : "";
                        emailImport = idxEmail !== -1 && row[idxEmail] ? row[idxEmail].toString().trim() : "";
                        phoneImport = idxTelefono !== -1 && row[idxTelefono] ? row[idxTelefono].toString().trim() : "";
                        kitDisplayName = idxKit !== -1 && row[idxKit] ? row[idxKit].toString().trim() : "Personalizzato";
                        mainSize = idxTaglia !== -1 && row[idxTaglia] ? row[idxTaglia].toString().trim() : "L";
                        sockSize = idxCalze !== -1 && row[idxCalze] ? row[idxCalze].toString().trim() : "43/46";
                        notes = idxNote !== -1 && row[idxNote] ? row[idxNote].toString().trim() : "";
                        noteColorImport = idxColoreNota !== -1 && row[idxColoreNota] && row[idxColoreNota].toString().trim() ? row[idxColoreNota].toString().trim() : "default";
                        inventoryScaledAtImport = idxScalatoMag !== -1 && row[idxScalatoMag] && row[idxScalatoMag].toString().trim() ? row[idxScalatoMag].toString().trim() : null;
                        statusImport = idxStato !== -1 && row[idxStato] && row[idxStato].toString().trim() ? row[idxStato].toString().trim() : "Nuovo";
                        if (!STATUSES.some(s => s.value === statusImport)) statusImport = "Nuovo";
                        
                        // DEBUG: Log status import
                        console.log(`üìã Ordine ${rowDisplayId}: Colonna Stato idx=${idxStato}, Valore raw="${row[idxStato]}", Status importato="${statusImport}"`);
                        
                        // DEBUG: Log ordini trasferiti
                        if (statusImport && statusImport.includes('trasferito')) {
                            console.log(`üì¶ Importando ordine TRASFERITO: ${rowDisplayId}, Cliente: ${customer}, Stato: ${statusImport}`);
                        }
                        
                        discountImport = idxSconto !== -1 && row[idxSconto] ? parseInt(row[idxSconto]) : 0;
                        linkedIdImport = idxTrasferito !== -1 && row[idxTrasferito] && row[idxTrasferito].toString().trim() ? row[idxTrasferito].toString().trim() : null;
                        const detailsCol = idxDettaglio !== -1 ? row[idxDettaglio] : null; 

                        if(kitDisplayName.toLowerCase().includes('staff') || kitDisplayName.toLowerCase().includes('allenatore')) type = 'Staff';

                         if (detailsCol) {
                            const itemsStr = detailsCol.toString();
                            const rawItems = itemsStr.split('||');
                            rawItems.forEach(itemRaw => {
                                const clean = itemRaw.trim();
                                if(clean) {
                                    const match = clean.match(/^(.*?) \[(.*?)\]$/);
                                    if (match) {
                                        itemsList.push({ name: match[1].trim(), size: match[2].trim() });
                                    } else {
                                        let s = mainSize;
                                        if(clean.includes("Calzettoni")) s = sockSize;
                                        if(clean.includes("Borsone")||clean.includes("Zaino")) s = "UNICA";
                                        itemsList.push({name: clean, size: s});
                                    }
                                }
                            });
                        } else {
                             for(let k in globalKitTypes) {
                                 if(kitDisplayName === globalKitTypes[k].display) {
                                     const kitInfo = globalKitTypes[k];
                                     itemsList = kitInfo.items.map(n => ({ name: n, size: n.includes("Calzettoni")?sockSize:(n.includes("Borsone")||n.includes("Zaino")?"UNICA":mainSize) }));
                                 }
                             }
                        }
                    }
                    else if (isGoogleForm) { 
                        if (!row[0] && !row[2] && !row[3]) return;
                        
                        // DEBUG: Mostra cosa c'√® nelle prime colonne
                        console.log(`\nüìã === RIGA ${i + 2} ===`);
                        console.log(`Col A (timestamp grezzo):`, row[0], `(tipo: ${typeof row[0]})`);
                        console.log(`Col B (email):`, row[1]);
                        console.log(`Col C (nome):`, row[2]);
                        console.log(`Col D (cognome):`, row[3]);
                        
                        // Salta le righe di "Intergrazione" o "Integrazione"
                        const nomeTemp = row[2] ? row[2].toString().toLowerCase() : '';
                        const cognomeTemp = row[3] ? row[3].toString().toLowerCase() : '';
                        if (nomeTemp.includes('intergrazione') || nomeTemp.includes('integrazione') ||
                            cognomeTemp.includes('intergrazione') || cognomeTemp.includes('integrazione')) {
                            console.log(`‚è≠Ô∏è Saltata riga di integrazione`);
                            return;
                        }
                        
                        // CONVERTE IL TIMESTAMP DAL FORMATO GOOGLE AL FORMATO DATABASE
                        // Google: "04/12/2025 19.44.42"
                        // Database: "2025-12-04 19:44:00.000" (ARROTONDATO AL MINUTO)
                        let rawTimestamp = row[0] ? row[0].toString().trim() : '';
                        
                        // Parse del formato Google: DD/MM/YYYY HH.mm.ss
                        const match = rawTimestamp.match(/^(\d{2})\/(\d{2})\/(\d{4})\s+(\d{1,2})\.(\d{2})\.(\d{2})$/);
                        
                        if (match) {
                            const day = match[1];
                            const month = match[2];
                            const year = match[3];
                            const hour = match[4].padStart(2, '0');
                            const minute = match[5];
                            const second = match[6]; // MANTIENI i secondi
                            
                            // Formato database: YYYY-MM-DD HH:mm:ss.000 (con secondi)
                            timestamp = `${year}-${month}-${day} ${hour}:${minute}:${second}.000`;
                            console.log(`üìÖ Timestamp convertito: "${rawTimestamp}" ‚Üí "${timestamp}"`);
                            
                            // NON filtrare per data - importa tutti gli ordini
                        } else {
                            // Timestamp non valido - salta questa riga
                            console.log(`‚è≠Ô∏è Saltata riga con timestamp invalido: "${rawTimestamp}"`);
                            return;
                        }
                        
                        // Estrai Nome e Cognome dalle colonne corrette
                        const nome = row[2] ? row[2].toString().trim() : ''; // Colonna C
                        const cognome = row[3] ? row[3].toString().trim() : ''; // Colonna D
                        customer = `${nome} ${cognome}`.trim() || `Cliente Senza Nome`;
                        emailImport = row[1] ? row[1].toString().trim() : ""; 
                        
                        // ImportKey = timestamp ESATTO (NON arrotondare)
                        importKey = timestamp;
                        
                        // Salva rawTimestamp per log successivo
                        const rawTimestampForLog = rawTimestamp;
                        
                        console.log(`üîë ImportKey: "${importKey}"`);
                        console.log(`üë§ Cliente: ${customer}`);
                        
                        roleOrYearImport = row[4] ? row[4].toString().trim() : "";
                        phoneImport = row[5] ? row[5].toString().trim() : "";

                        mainSize = row[16] ? row[16].toString().trim().toUpperCase() : "L"; 
                        sockSize = row[17] ? row[17].toString().trim().toUpperCase() : "43/46"; 
                        notes = row[19] ? row[19].toString().trim() : '';
                        
                        // Colonna S (18): Taglia accessori (Cappellino, Scaldacollo, Guanti)
                        if (row[18]) {
                            const colS = row[18].toString().trim().toUpperCase();
                            if (colS.includes('TAGLIA 05') || colS.includes('ADULTO') || colS.includes('05')) {
                                accessorySize = '05 ADULTO';
                            } else if (colS.includes('TAGLIA 03') || colS.includes('BIMBO') || colS.includes('03')) {
                                accessorySize = '03 BIMBO';
                            }
                        }
                        
                        bagChoice = row[12] ? row[12].toString().trim().toLowerCase() : null;
                        inputs = [row[9], row[10], row[11]].map(x => x ? x.toString().trim().toLowerCase() : '').filter(f => f && !f.includes('non applicabile'));
                        if (row[14]) {
                            const col_o_items = row[14].toString().split(',').map(x => x.trim().toLowerCase()).filter(x => x);
                            inputs.push(...col_o_items);
                        }
                        if (row[15]) {
                            const col_p_items = row[15].toString().split(',').map(x => x.trim().toLowerCase()).filter(x => x);
                            inputs.push(...col_p_items);
                        } 
                    } else { 
                        if (!row[0] && !row[1] && !row[2]) return;
                        rowDisplayId = row[0] ? row[0].toString().trim() : generateNewId(true); 
                        customer = `${(row[1]||'')} ${(row[2]||'')}`.trim() || `Cliente`; 
                        importKey = rowDisplayId; 
                        notes = row[7] ? row[7].toString().trim() : ''; 
                        inputs = [row[8] ? row[8].toString().trim().toLowerCase() : '']; 
                        mainSize = row[4] ? row[4].toString().trim().toUpperCase() : "L";
                        sockSize = row[5] ? row[5].toString().trim().toUpperCase() : "43/46"; 
                    }

                    if (!isBackup && inputs && inputs.length > 0) {
                        const primary = inputs[0];
                        let kitKey = null;
                        
                        const rawTypeCol = row[7] ? row[7].toString().toLowerCase() : "";
                        if (rawTypeCol.includes('singolo') || primary.includes('singolo') || primary.includes('abbigliamento singolo')) {
                             kitKey = null;
                             kitDisplayName = 'Abbigliamento Singolo';
                        } 
                        else if (primary.includes('kit giocatore') && !primary.includes('mini')) kitKey = 'giocatore_completo';
                        else if (primary.includes('mini kit')) kitKey = 'giocatore_mini'; 
                        else if (primary.includes('kit allenatore completo')) { kitKey = 'staff_allenatore_completo'; type = 'Staff'; } 
                        else if (primary.includes('kit allenatore')) { kitKey = 'staff_allenatore_base'; type = 'Staff'; } 
                        else if (primary.includes('kit dirigente')) { kitKey = 'staff_dirigente'; type = 'Staff'; } 
                        else if (primary.includes('kit portiere') || primary.includes('portiere')) {
                             if(primary.includes('mini')) kitKey = 'portiere_mini_lungo';
                             else kitKey = 'portiere_completo_lungo';
                        }

                        if (!kitKey && kitDisplayName !== 'Abbigliamento Singolo') {
                             for(let k in globalKitTypes) {
                                 if(primary.includes(k) || primary.includes(globalKitTypes[k].display.toLowerCase())) {
                                     kitKey = k;
                                     break;
                                 }
                             }
                        }

                        if (kitKey && globalKitTypes[kitKey]) { 
                            kitDisplayName = globalKitTypes[kitKey].display;
                            itemsList = globalKitTypes[kitKey].items.map(itemName => { 
                                let size = mainSize; 
                                if (itemName.includes("Calzettoni")) size = sockSize; 
                                if (itemName.includes("Cappellino") || itemName.includes("Scaldacollo") || itemName.includes("Guanti")) { 
                                    size = accessorySize; 
                                }
                                if (itemName.includes("Borsone") || itemName.includes("Zaino")) { 
                                    size = 'UNICA'; 
                                    let explicitBagName = null;
                                    if (bagChoice) {
                                         if (bagChoice.includes('zaino')) explicitBagName = "Zaino BACKPACK Blue Marine 901 (25‚Ç¨)";
                                        else if (bagChoice.includes('borsone')) explicitBagName = "Borsone HARDBASE Blue Marine 901 (25‚Ç¨)";
                                    }
                                    if (explicitBagName === "Zaino BACKPACK Blue Marine 901 (25‚Ç¨)") return { name: explicitBagName, size: 'UNICA' };
                                    return { name: "Borsone HARDBASE Blue Marine 901 (25‚Ç¨)", size: 'UNICA' };
                                } 
                                return { name: itemName, size: size };
                            }); 
                            itemsList = itemsList.filter(item => !item.name.includes("Zaino") || item.name.includes("BACKPACK")); 
                        } else { 
                            if (kitDisplayName !== 'Abbigliamento Singolo') kitDisplayName = extractKitName(primary);
                            if(primary.includes('singolo')) kitDisplayName = 'Abbigliamento Singolo';

                            itemsList = []; 
                            inputs.forEach(field => { 
                                if (field.trim() === '0' || field.trim() === '' || field.trim() === 'no') return;
                                for (const [k, v] of Object.entries(EXCEL_ITEM_MAPPING)) { 
                                    if (field.includes(k)) { 
                                        let s = mainSize; 
                                        if (v.includes("Calzettoni")) s = sockSize; 
                                        if (v.includes("Cappellino") || v.includes("Scaldacollo") || v.includes("Guanti")) s = accessorySize; 
                                        if (v.includes("Borsone") || v.includes("Zaino")) s = 'UNICA'; 
                                        if (!itemsList.find(i => i.name === v)) { 
                                            itemsList.push({ name: v, size: s }); 
                                            if (v.includes("Staff") || v.includes("RED") || v.includes("SAPPHIRE")) type = 'Staff'; 
                                        } 
                                    } 
                                } 
                            });
                        }
                    } else if (!isBackup && (notes || customer !== `Cliente Senza Nome`)) {
                         kitDisplayName = 'Personalizzato';
                         itemsList = [];
                    } 

                    if(!itemsList) itemsList = [];
                    
                    // CONTROLLO: Per Google Form, importa SOLO ordini pi√π recenti dell'ultimo nel DB
                    if (isGoogleForm && latestTimestampDate && timestamp && !isBackup) {
                        try {
                            // IMPORTANTE: Normalizza timestamp prima di creare Date object
                            const normalizedCurrentTimestamp = roundTimestampOnly(timestamp);
                            const currentTimestampDate = new Date(normalizedCurrentTimestamp);
                            
                            if (i < 10) {
                                console.log(`\nüîç Riga ${i+2}: ${customer}`);
                                console.log(`   Timestamp Excel originale: ${timestamp}`);
                                console.log(`   Timestamp normalizzato: ${normalizedCurrentTimestamp}`);
                                console.log(`   Date: ${currentTimestampDate.toLocaleString('it-IT')}`);
                                console.log(`   Valid? ${!isNaN(currentTimestampDate.getTime())}`);
                                console.log(`   Ultimo DB: ${latestTimestampDate.toLocaleString('it-IT')}`);
                                console.log(`   Confronto: ${currentTimestampDate.getTime()} > ${latestTimestampDate.getTime()} = ${currentTimestampDate > latestTimestampDate}`);
                            }
                            
                            // Verifica validit√† Date
                            if (isNaN(currentTimestampDate.getTime())) {
                                console.warn(`‚ö†Ô∏è Timestamp invalido alla riga ${i+2}: ${timestamp}`);
                                duplicateCount++;
                                return;
                            }
                            
                            // Se questo ordine √® pi√π vecchio o uguale all'ultimo nel DB ‚Üí SALTA
                            if (currentTimestampDate <= latestTimestampDate) {
                                if (i < 10) console.log(`   ‚è≠Ô∏è SALTATO: ordine pi√π vecchio o uguale`);
                                duplicateCount++;
                                return;
                            } else {
                                if (i < 10) console.log(`   ‚úÖ IMPORTO: ordine pi√π recente!`);
                            }
                        } catch (e) {
                            console.warn(`Errore confronto timestamp riga ${i+2}: ${e.message}`);
                            duplicateCount++;
                            return;
                        }
                    }
                    
                    // CONTROLLO SECONDARIO: Controlla se esiste gi√† tramite importKey
                    let existingOrder = existingOrdersMap.get(importKey);
                    
                    // LOG DETTAGLIATO per primi 15 ordini
                    if (i < 15) {
                        console.log(`\nüîç RIGA ${i+2}: ${customer}`);
                        console.log(`   üìÖ Raw: "${rawTimestampForLog || 'N/A'}"`);
                        console.log(`   üîë ImportKey: "${importKey}" (length: ${importKey.length})`);
                        
                        // Mostra caratteri per primi 3
                        if (i < 3) {
                            const chars = importKey.split('').map((c, idx) => `[${idx}]=${c.charCodeAt(0)}`).join(' ');
                            console.log(`   üìù Chars: ${chars}`);
                        }
                        
                        console.log(`   ${existingOrder ? '‚úÖ TROVATO: ' + existingOrder.displayId : '‚ùå NON TROVATO'}`);
                        
                        // Se non trovato, cerca timestamp simili
                        if (!existingOrder && existingOrdersMap.size > 0) {
                            const prefix = importKey.substring(0, 16); // YYYY-MM-DD HH:mm
                            console.log(`   üîé Cerco simili con prefix: "${prefix}"`);
                            let found = 0;
                            for (let [key, order] of existingOrdersMap) {
                                if (key.startsWith(prefix) && found < 2) {
                                    console.log(`      ‚Üí ${order.displayId}: "${key}"`);
                                    console.log(`         Match? ${key === importKey ? '‚úÖ SI' : '‚ùå NO - Diff: "' + key + '" vs "' + importKey + '"'}`);
                                    found++;
                                }
                            }
                        }
                    }
                    
                    if (existingOrder) {
                        duplicateCount++;
                        newOrUpdatedOrders.push(existingOrder); 
                        existingOrdersMap.delete(importKey); 
                    } else {
                        // Ordine non trovato tra i duplicati, procedi con creazione
                        const newDisplayId = rowDisplayId || generateNewId();
                        console.log(`‚ú® Nuovo ordine: ${newDisplayId} - ${customer} (timestamp: ${timestamp || 'N/A'})`);
                        
                        newOrderIds.push(newDisplayId); // Traccia questo nuovo ordine
                        
                        newOrUpdatedOrders.push({ 
                            id: Date.now() + i, 
                            displayId: newDisplayId, 
                            importKey, 
                            timestamp: timestamp || null,
                            excelRowIndex: i, 
                            customer, 
                            mainSize, 
                            sockSize, 
                            notes, 
                            itemsList, 
                            status: isBackup ? statusImport : 'Nuovo', 
                            type, 
                            kitType: kitDisplayName, 
                            linkedId: linkedIdImport || null, // FIX: Assegnazione Nuovo
                            discount: discountImport,
                            email: emailImport,
                            phone: phoneImport,
                            roleOrYear: roleOrYearImport || "",
                            noteColor: isBackup ? noteColorImport : 'default',
                            inventoryScaledAt: isBackup ? inventoryScaledAtImport : null
                        });
                    }
                    successCount++;
                } catch (err) { console.error(`Errore riga ${i + 2}:`, err); }
            });
            const manualOrdersSorted = manualOrders.sort((a, b) => (a.id || 0) - (b.id || 0)); 
            newOrUpdatedOrders.sort((a, b) => a.excelRowIndex - b.excelRowIndex);
            orders = [...newOrUpdatedOrders, ...existingOrdersMap.values(), ...manualOrdersSorted];
            
            // RICALCOLA lastOrderId basandoti sul massimo ID reale
            const prefixRegex = new RegExp(`^${currentPrefix.replace(/[-[\]{}()*+?.,\\^$|#\s]/g, '\\$&')}`);
            const maxId = orders.reduce((max, o) => {
                if (o.displayId && o.displayId.match(prefixRegex)) {
                    const n = parseInt(o.displayId.replace(currentPrefix, ''));
                    return isNaN(n) ? max : Math.max(max, n);
                }
                return max;
            }, 0);
            lastOrderId = maxId;
            console.log(`üî¢ lastOrderId ricalcolato: ${lastOrderId} (prossimo ID sar√† ${currentPrefix}${(lastOrderId + 1).toString().padStart(3, '0')})`);
            
            // DEBUG: Conta ordini trasferiti dopo import
            const transferredCount = orders.filter(o => o.status && o.status.includes('trasferito')).length;
            const newCount = newOrderIds.length;
            
            console.log(`\n‚úÖ Import completato!`);
            console.log(`   ‚ú® Nuovi ordini importati: ${newCount}`);
            if (newCount > 0) {
                console.log(`   üìã ID nuovi ordini: ${newOrderIds.join(', ')}`);
            }
            console.log(`   ‚è≠Ô∏è Ordini gi√† presenti (saltati): ${duplicateCount}`);
            console.log(`   üì¶ Ordini trasferiti nel sistema: ${transferredCount}`);
            console.log(`   üéØ Totale ordini nel sistema: ${orders.length}`);
            
            // Importa foglio magazzino se presente
            let inventoryImported = 0;
            if (wb && wb.SheetNames.length > 1) {
                const inventorySheetName = wb.SheetNames.find(name => 
                    name.toLowerCase().includes('magazzino') || name.toLowerCase().includes('inventory')
                );
                
                if (inventorySheetName) {
                    const invRows = XLSX.utils.sheet_to_json(wb.Sheets[inventorySheetName], {header: 1});
                    if (invRows && invRows.length > 1) {
                        const invHeader = invRows[0].map(c => c ? c.toString().toLowerCase() : "");
                        
                        invRows.slice(1).forEach(row => {
                            if (row.length >= 3 && row[0] && row[1] && row[2]) {
                                const itemName = row[0].toString().trim();
                                const size = row[1].toString().trim();
                                const quantity = parseInt(row[2]);
                                
                                if (!isNaN(quantity) && quantity > 0) {
                                    const key = `${itemName}_${size}`;
                                    inventory[key] = quantity;
                                    inventoryImported++;
                                }
                            }
                        });
                        
                        console.log(`üì¶ Magazzino importato: ${inventoryImported} articoli`);
                    }
                }
            }
            
            saveData(); initSelect(); updateUI(); 
            
            let alertMsg = `‚úÖ IMPORTAZIONE COMPLETATA!\n\n`;
            alertMsg += `üìä RIEPILOGO:\n`;
            alertMsg += `‚Ä¢ Totale righe processate: ${successCount}\n`;
            if (isGoogleForm && latestOrder) {
                alertMsg += `‚Ä¢ üïê Ultimo ordine nel database: ${latestOrder.displayId}\n`;
                alertMsg += `‚Ä¢ ‚ú® Nuovi ordini importati (dopo ${latestOrder.displayId}): ${newCount}\n`;
            } else {
                alertMsg += `‚Ä¢ ‚ú® Nuovi ordini importati: ${newCount}\n`;
            }
            if (newCount > 0 && newCount <= 10) {
                alertMsg += `  üìã ID: ${newOrderIds.join(', ')}\n`;
            } else if (newCount > 10) {
                alertMsg += `  üìã Primi 10 ID: ${newOrderIds.slice(0, 10).join(', ')}...\n`;
            }
            alertMsg += `‚Ä¢ ‚è≠Ô∏è Ordini gi√† presenti o pi√π vecchi (saltati): ${duplicateCount}\n`;
            alertMsg += `‚Ä¢ üì¶ Totale ordini nel sistema: ${orders.length}\n`;
            if (inventoryImported > 0) {
                alertMsg += `‚Ä¢ üè≠ Magazzino importato: ${inventoryImported} articoli\n`;
            }
            if (isGoogleForm) {
                alertMsg += `\nüí° LOGICA IMPORTAZIONE:\n`;
                alertMsg += `Da Google Fogli vengono importati SOLO\n`;
                alertMsg += `gli ordini pi√π recenti dell'ultimo nel database.\n`;
                alertMsg += `Questo evita duplicati e preserva le modifiche manuali.`;
            }
            
            alert(alertMsg);
        }

        function addNewOrder() {
    if (!checkPermission('createOrders')) {
        alert('‚ö†Ô∏è Non hai i permessi per creare nuovi ordini.');
        return;
    }
    const kitInfo = globalKitTypes['giocatore_completo'] || Object.values(globalKitTypes)[0];

    const newOrder = {
        id: Date.now(),
        displayId: generateNewId(true),
        importKey: null,
        customer: "Nuovo Ordine",
        mainSize: "L",
        sockSize: "43/46",
        notes: "",
        itemsList: kitInfo.items.map(n => ({
            name: n,
            size: n.includes("Calzettoni")
                ? "43/46"
                : (n.includes("Borsone") || n.includes("Zaino") || n.includes("Cappellino") || n.includes("Scaldacollo") || n.includes("Guanti") ? "UNICA" : "L")
        })),
        status: 'Nuovo',
        type: 'Giocatore',
        kitType: kitInfo.display,
        linkedId: null,
        discount: 0,
        email: "",
        phone: "",
        roleOrYear: ""
    };

    orders.push(newOrder);

    logActivity('CREATE_ORDER', `Creato nuovo ordine: ${newOrder.displayId}`);

    updateUI();
}

// Funzione per gestire il cambio di stato degli ordini
function handleStatusChange(id, newStatus) {
    const o = orders.find(x => x.id === id);
    if (!o) return;
    
    const oldStatus = o.status;
    
    if (newStatus === 'Ordine trasferito ad altro ID') {
        const t = prompt('Inserisci ID Destinazione (es: 2026A_5):');
        if (t) {
            o.status = newStatus;
            o.linkedId = t.trim().toUpperCase();
        } else {
            // Se annulla, mantieni lo stato precedente
            return;
        }
    } else if (newStatus === 'Consegna Parziale') {
        // Apri popup per inserire cosa manca
        openPartialDeliveryPopup(id);
        return; // Il salvataggio verr√† fatto dal popup
    } else {
        o.status = newStatus;
        o.linkedId = null;
        o.partialDeliveryNote = null;
    }
    
    // Log della modifica
    if (oldStatus !== newStatus) {
        logActivity('CHANGE_STATUS', `Ordine ${o.displayId} (${o.customer}): Stato cambiato da "${oldStatus}" a "${newStatus}"`);
    }
    
    // updateUI gi√† chiama saveData()
    updateUI();
    renderMatrices();
}

// Rendi la funzione disponibile globalmente
window.handleStatusChange = handleStatusChange;

function deleteOrder(id) {
    if (confirm('Eliminare?')) {
        const order = orders.find(x => x.id === id);
        const orderId = order ? order.displayId : 'N/A';

        orders = orders.filter(x => x.id !== id);

        logActivity('DELETE_ORDER', `Eliminato ordine: ${orderId}`);

        updateUI();
    }
}

        // Rende le funzioni disponibili agli onclick nel DOM
        window.addNewOrder = addNewOrder;
        window.deleteOrder = deleteOrder;

                // Popup Consegna Parziale
                let currentPartialDeliveryOrderId = null;
        
        function openPartialDeliveryPopup(orderId) {
            currentPartialDeliveryOrderId = orderId;
            const order = orders.find(o => o.id === orderId);
            
            if (order) {
                // Aggiorna stato immediatamente
                order.status = 'Consegna Parziale';
                
                // Mostra nota esistente se presente
                document.getElementById('partialDeliveryNote').value = order.partialDeliveryNote || '';
                document.getElementById('partialDeliveryPopup').classList.add('active');
            }
        }
        
        function closePartialDeliveryPopup() {
            document.getElementById('partialDeliveryPopup').classList.remove('active');
            currentPartialDeliveryOrderId = null;
        }
        
        function savePartialDeliveryNote() {
            if (!currentPartialDeliveryOrderId) return;
            
            const note = document.getElementById('partialDeliveryNote').value.trim();
            const order = orders.find(o => o.id === currentPartialDeliveryOrderId);
            
            if (order) {
                const oldStatus = order.status;
                order.partialDeliveryNote = note;
                order.status = 'Consegna Parziale';
                
                // Se la nota √® vuota, chiedi conferma
                if (!note) {
                    const confirm = window.confirm('‚ö†Ô∏è Nessuna nota inserita. Vuoi confermare comunque?');
                    if (!confirm) return;
                }
                
                // Log della modifica
                logActivity('CHANGE_STATUS', `Ordine ${order.displayId} (${order.customer}): Stato cambiato a "Consegna Parziale" - Nota: ${note || 'nessuna'}`);
                
                // Salva su Redis
                saveData();
                
                showQuickNotification('‚úÖ Nota consegna parziale salvata', 'success');
                closePartialDeliveryPopup();
                updateUI();
            }
        }

        function updateLinkedId(id, newLinkedId) {
             const o = orders.find(x => x.id === id);
             if (!o) return;
             o.linkedId = newLinkedId.toUpperCase().trim();
             saveData();
             updateUI(); 
             renderMatrices();
        }

        function openSettingsModal() { document.getElementById('settingsModal').classList.add('active'); renderConfigTable(); }
        function closeSettingsModal() { document.getElementById('settingsModal').classList.remove('active'); initSelect(); renderMatrices(); saveData(); }
        
        function renderConfigTable() { 
            const tbody = document.getElementById('configItemsBody');
            tbody.innerHTML = ''; 
            globalItems.forEach((item, index) => { 
                tbody.innerHTML += `<tr class="border-b hover:bg-gray-50"><td class="p-2 text-xs w-full">${item}</td><td class="p-2 text-center flex justify-center gap-2"><button onclick="renameItemInConfig(${index})" class="text-blue-500 hover:text-blue-700 px-1"><i class="fas fa-pen"></i></button><button onclick="removeItemFromConfig(${index})" class="text-red-500 hover:text-red-700 px-1"><i class="fas fa-trash"></i></button></td></tr>`; 
            });
        }
        function renameItemInConfig(index) {
            const oldName = globalItems[index];
            const newName = prompt("Modifica nome:", oldName);
            if (newName && newName !== oldName) {
                globalItems[index] = newName;
                orders.forEach(o => { o.itemsList.forEach(i => { if(i.name === oldName) i.name = newName; }); });
                Object.keys(inventory).forEach(k => { if (k.startsWith(oldName + '_')) { const val = inventory[k]; delete inventory[k]; inventory[`${newName}_${k.split('_')[1]}`] = val; } });
                Object.values(globalKitTypes).forEach(kit => { kit.items = kit.items.map(i => i === oldName ? newName : i); });
                saveData(); renderConfigTable(); renderChart(); alert("Articolo rinominato ovunque.");
            }
        }
        
        function forceUpdatePrices() {
            if(!confirm("Questo comando analizzer√† TUTTI gli ordini.\nSe trova un articolo o un Kit con lo stesso nome ma prezzo diverso rispetto al database attuale, lo aggiorner√†.\n\nSei sicuro?")) return;
            let countItems = 0;
            let countKits = 0;
            const stripPrice = (str) => str.split('(')[0].trim();
            orders.forEach(o => {
                const oldKitName = o.kitType;
                const cleanOldKit = stripPrice(oldKitName);
                for(let key in globalKitTypes) {
                    const dbKit = globalKitTypes[key];
                    const cleanDbKit = stripPrice(dbKit.display);
                    if (cleanOldKit === cleanDbKit && oldKitName !== dbKit.display) {
                        o.kitType = dbKit.display;
                        countKits++;
                        break; 
                    }
                }
                o.itemsList.forEach(item => {
                    const oldItemName = item.name;
                    const cleanOldItem = stripPrice(oldItemName);
                    const foundInDB = globalItems.find(dbItem => stripPrice(dbItem) === cleanOldItem);
                    if (foundInDB && foundInDB !== oldItemName) {
                        item.name = foundInDB;
                        countItems++;
                    }
                });
            });
            saveData();
            renderMatrices();
            renderChart();
            alert(`Aggiornamento Completato!\n- Kit aggiornati: ${countKits}\n- Articoli aggiornati: ${countItems}`);
        }

        function addItemToConfig() { const input = document.getElementById('newItemName');
        const val = input.value.trim(); if (val && !globalItems.includes(val)) { globalItems.push(val); input.value = ''; renderConfigTable(); renderChart(); saveData();
        } else { alert('Esistente o vuoto!'); } }
        function removeItemFromConfig(index) { if(confirm("Eliminare?")) { globalItems.splice(index, 1);
        renderConfigTable(); renderChart(); saveData(); } }
        function resetConfigDefaults() { if(confirm("Ripristinare default?")) { globalItems = [...DEFAULT_ITEMS_LIST];
        renderConfigTable(); saveData(); } }

        function openKitConfigModal() { 
            document.getElementById('kitConfigModal').classList.add('active');
            renderKitList();
            const sel = document.getElementById('addKitItemSelect'); sel.innerHTML = '';
            globalItems.forEach(i => sel.innerHTML += `<option value="${i}">${i}</option>`);
        }
        function closeKitConfigModal() { document.getElementById('kitConfigModal').classList.remove('active'); renderKitFilterOptions(); updateUI(); }

        function renderKitList() {
            const cont = document.getElementById('kitListContainer');
            cont.innerHTML = '';
            Object.keys(globalKitTypes).forEach(key => {
                const kit = globalKitTypes[key];
                cont.innerHTML += `<button onclick="editKit('${key}')" class="text-left px-3 py-2 border rounded text-xs font-bold hover:bg-blue-50 ${currentEditingKitKey===key?'bg-blue-100 ring-2 ring-blue-500':''}">${kit.display}</button>`;
            });
        }

        function addNewKitDefinition() {
            const name = prompt("Nome del Nuovo Kit (incluso prezzo, es: Kit Base (100‚Ç¨))");
            if(!name) return;
            const key = 'custom_kit_' + Date.now();
            globalKitTypes[key] = { display: name, items: [] };
            saveData(); renderKitList(); editKit(key);
        }

        function resetKitDefaults() {
            if(confirm("Attenzione: Questo canceller√† tutti i Kit personalizzati e ripristiner√† quelli di base. Continuare?")) {
                globalKitTypes = JSON.parse(JSON.stringify(DEFAULT_KIT_DEFINITIONS));
                saveData(); renderKitList(); document.getElementById('kitDetailContainer').style.display='none'; document.getElementById('kitPlaceholder').style.display='flex';
            }
        }

        function editKit(key) {
            currentEditingKitKey = key;
            const kit = globalKitTypes[key];
            document.getElementById('kitPlaceholder').style.display='none';
            document.getElementById('kitDetailContainer').style.display='flex';
            document.getElementById('editKitName').value = kit.display;
            document.getElementById('editKitKey').value = key;
            renderKitItemsList();
        }

        function renderKitItemsList() {
            const list = document.getElementById('editKitItemsList');
            list.innerHTML = '';
            const kit = globalKitTypes[currentEditingKitKey];
            kit.items.forEach((item, idx) => {
                list.innerHTML += `<li class="flex justify-between items-center bg-white border p-1 rounded text-xs"><span>${item}</span><button onclick="removeItemFromKit(${idx})" class="text-red-500 px-2 font-bold">&times;</button></li>`;
            });
        }

        function addItemToKitDefinition() {
            const val = document.getElementById('addKitItemSelect').value;
            if(currentEditingKitKey && val) {
                globalKitTypes[currentEditingKitKey].items.push(val);
                renderKitItemsList(); saveData();
            }
        }

        function removeItemFromKit(idx) {
            globalKitTypes[currentEditingKitKey].items.splice(idx, 1);
            renderKitItemsList(); saveData();
        }

        function saveCurrentKit() {
            const newName = document.getElementById('editKitName').value;
            if(newName && currentEditingKitKey) {
                globalKitTypes[currentEditingKitKey].display = newName;
                saveData(); renderKitList(); alert("Kit salvato.");
            }
        }

        function deleteCurrentKit() {
            if(confirm("Eliminare definitivamente questo Kit?")) {
                delete globalKitTypes[currentEditingKitKey];
                currentEditingKitKey = null;
                document.getElementById('kitDetailContainer').style.display='none';
                document.getElementById('kitPlaceholder').style.display='flex';
                saveData(); renderKitList();
            }
        }

        // ===== SISTEMA MEMORIZZAZIONE FILTRI =====
        function saveFiltersState() {
            try {
                const filtersState = {
                    searchInput: document.getElementById('searchInput')?.value || '',
                    sortOrder: document.getElementById('sortOrder')?.value || 'asc',
                    filterStatus: document.getElementById('filterStatus')?.value || 'all',
                    filterRoleYear: document.getElementById('filterRoleYear')?.value || '',
                    filterSize: document.getElementById('filterSize')?.value || 'all',
                    filterKitType: document.getElementById('filterKitType')?.value || 'all',
                    filterItem: document.getElementById('filterItem')?.value || 'all',
                    filterMinId: document.getElementById('filterMinId')?.value || '',
                    filterMaxId: document.getElementById('filterMaxId')?.value || ''
                };
                localStorage.setItem('orderflow_filters', JSON.stringify(filtersState));
            } catch (e) {
                console.warn('‚ö†Ô∏è Impossibile salvare filtri:', e);
            }
        }
        
        function restoreFiltersState() {
            try {
                const saved = localStorage.getItem('orderflow_filters');
                if (!saved) return;
                
                const filtersState = JSON.parse(saved);
                
                // Ripristina ogni filtro
                Object.keys(filtersState).forEach(key => {
                    const element = document.getElementById(key);
                    if (element && filtersState[key]) {
                        element.value = filtersState[key];
                    }
                });
                
                console.log('‚úÖ Filtri ripristinati:', filtersState);
            } catch (e) {
                console.warn('‚ö†Ô∏è Impossibile ripristinare filtri:', e);
            }
        }
        
        function clearFiltersState() {
            localStorage.removeItem('orderflow_filters');
            console.log('üóëÔ∏è Filtri cancellati');
        }
        // ===== FINE SISTEMA MEMORIZZAZIONE FILTRI =====
        
        function renderTable() {
            // Salva stato filtri
            saveFiltersState();
            
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            const filterStatus = document.getElementById('filterStatus').value; 
            const filterKitType = document.getElementById('filterKitType').value; 
            const filterSize = document.getElementById('filterSize').value;
            const filterItem = document.getElementById('filterItem').value;
            const filterRoleYear = document.getElementById('filterRoleYear').value.toLowerCase().trim();
            const search = document.getElementById('searchInput').value.toLowerCase();
            const sortOrder = document.getElementById('sortOrder').value;
            
            // Filtro ID Min/Max
            const filterMinId = document.getElementById('filterMinId')?.value;
            const filterMaxId = document.getElementById('filterMaxId')?.value;
            
            // Funzione per estrarre anno/prefisso e numero dall'ID
            // Esempi: "2025_001" -> {prefix: "2025_", num: 1}, "2025A_001" -> {prefix: "2025A_", num: 1}
            const parseDisplayId = (displayId) => {
                const match = displayId.match(/^(.+?)(\d+)$/);
                if (match) {
                    return { prefix: match[1], num: parseInt(match[2]) };
                }
                return { prefix: displayId, num: 0 };
            };
            
            // Funzione per confrontare due ID (considera prefisso + numero)
            const compareIds = (idA, idB) => {
                const a = parseDisplayId(idA);
                const b = parseDisplayId(idB);
                
                // Prima confronta il prefisso (2025A_ viene prima di 2026_)
                if (a.prefix !== b.prefix) {
                    return a.prefix.localeCompare(b.prefix);
                }
                // Se stesso prefisso, confronta il numero
                return a.num - b.num;
            };
            
            const getNumId = (displayId) => {
                const match = displayId.match(/(\d+)$/);
                return match ? parseInt(match[1]) : 0;
            };
            
            // Per i filtri min/max, usa il confronto completo
            const minNum = filterMinId ? getNumId(filterMinId) : 0;
            const maxNum = filterMaxId ? getNumId(filterMaxId) : Infinity;
            const minPrefix = filterMinId ? parseDisplayId(filterMinId).prefix : '';
            const maxPrefix = filterMaxId ? parseDisplayId(filterMaxId).prefix : '';

            const nameCounts = {};
            orders.forEach(o => {
                const c = o.customer.trim().toLowerCase();
                if(c) nameCounts[c] = (nameCounts[c] || 0) + 1;
            });
            let displayedOrders = orders.filter(o => {
                // FILTRO ID MIN/MAX - considera anche il prefisso
                if (filterMinId && compareIds(o.displayId, filterMinId) < 0) return false;
                if (filterMaxId && compareIds(o.displayId, filterMaxId) > 0) return false;
                
                if(filterStatus !== 'all' && o.status !== filterStatus) return false;
                if(filterSize !== 'all' && o.mainSize !== filterSize) return false; 
                
                // Filtro Anno/Ruolo
                if(filterRoleYear && o.roleOrYear) {
                    if(!o.roleOrYear.toLowerCase().includes(filterRoleYear)) return false;
                } else if(filterRoleYear && !o.roleOrYear) {
                    return false; // Se filtro attivo ma ordine senza anno/ruolo, escludi
                }
                
                if(filterKitType && filterKitType !== 'all') {
                     const filterClean = filterKitType.split('(')[0].trim();
                     const orderClean = o.kitType.split('(')[0].trim();
                     if(filterClean !== orderClean && o.kitType !== filterKitType) return false;
                }
                
                // Filtro per singolo capo
                if(filterItem && filterItem !== 'all') {
                    const hasItem = o.itemsList.some(item => item.name === filterItem);
                    if(!hasItem) return false;
                }
                
                if(!o.customer.toLowerCase().includes(search) && !o.displayId.toLowerCase().includes(search)) return false;
                return true;
            });

            // Ordinamento che considera prefisso + numero
            displayedOrders.sort((a, b) => {
                const comparison = compareIds(a.displayId, b.displayId);
                return sortOrder === 'asc' ? comparison : -comparison;
            });

            displayedOrders.forEach(o => {
                const tr = document.createElement('tr'); const isStaff = o.type === 'Staff'; tr.className = isStaff ? "bg-red-50 hover:bg-red-100 border-b" : "hover:bg-gray-50 border-b";
                const kitOptions = getAvailableKitOptionsHTML(o.kitType);
                
                let statusInfo;
                const linkedFrom = orders.find(x => x.linkedId === o.displayId);
                
                if (linkedFrom) {
                    statusInfo = `
                    <div class="flex flex-col">
                        <span class="text-[10px] font-bold text-purple-700 bg-purple-100 border border-purple-300 rounded p-1 mb-1 text-center">
                             <i class="fas fa-arrow-down"></i> DA ID: ${linkedFrom.displayId}
                        </span>
                        <select onchange="handleStatusChange(${o.id}, this.value)" class="status-select text-xs border rounded p-1 w-full font-bold bg-gray-100">
                            <option value="In Lavorazione" ${o.status==='In Lavorazione'?'selected':''}>In Lavorazione</option>
                            <option value="Ordine Arrivato" ${o.status==='Ordine Arrivato'?'selected':''}>Arrivato</option>
                            <option value="Pagato" ${o.status==='Pagato'?'selected':''}>Pagato</option>
                            <option value="Consegna Parziale" ${o.status==='Consegna Parziale'?'selected':''}>Consegna Parziale</option>
                            <option value="Consegnato" ${o.status==='Consegnato'?'selected':''}>Consegnato</option>
                             ${(o.status !== 'In Lavorazione' && o.status !== 'Ordine Arrivato' && o.status !== 'Pagato' && o.status !== 'Consegna Parziale' && o.status !== 'Consegnato') ?
                            `<option value="${o.status}" selected disabled>${o.status}</option>` : ''}
                        </select>
                    </div>`;
                } else {
                    const isTransferred = o.status === 'Ordine trasferito ad altro ID';
                    if (isTransferred) {
                        statusInfo = `
                        <div class="flex flex-col gap-1">
                            <select onchange="handleStatusChange(${o.id}, this.value)" class="status-select text-xs border rounded p-1 w-full bg-purple-100 text-purple-800 font-bold">
                                 ${STATUSES.map(s => `<option value="${s.value}" ${o.status===s.value?'selected':''}>${s.label}</option>`).join('')}
                            </select>
                            <div class="flex items-center gap-1">
                                <span class="text-[10px] font-bold text-gray-500">A:</span>
                                <input type="text" value="${o.linkedId || ''}" onchange="updateLinkedId(${o.id}, this.value)" class="text-xs border border-purple-300 rounded p-1 w-full font-bold text-purple-700 bg-white" placeholder="ID Dest...">
                            </div>
                        </div>`;
                    } else {
                        // Controlla se c'√® una nota di consegna parziale
                        const hasPartialNote = o.status === 'Consegna Parziale' && o.partialDeliveryNote;
                        
                        statusInfo = `
                        <div class="flex flex-col gap-1">
                            <select onchange="handleStatusChange(${o.id}, this.value)" class="status-select text-xs border rounded p-1 w-full ${STATUSES.find(s=>s.value===o.status)?.color || ''}">
                                ${STATUSES.map(s => `<option value="${s.value}" ${o.status===s.value?'selected':''}>${s.label}</option>`).join('')}
                            </select>
                            ${hasPartialNote ? `
                            <div class="bg-amber-50 border border-amber-300 rounded p-1.5 cursor-pointer hover:bg-amber-100 transition" onclick="openPartialDeliveryPopup(${o.id})" title="Clicca per modificare">
                                <div class="text-[10px] font-bold text-amber-800 flex items-center gap-1">
                                    <i class="fas fa-box-open"></i>
                                    <span>Manca:</span>
                                </div>
                                <div class="text-[10px] text-amber-700 mt-0.5 line-clamp-2">${o.partialDeliveryNote}</div>
                            </div>` : ''}
                        </div>`;
                    }
                }

                const bagType = getBagType(o.itemsList);
                const finalTotal = calculateOrderTotal(o);
                const roleSelector = `<select onchange="updateOrderType(${o.id}, this.value)" class="text-[10px] uppercase font-bold bg-transparent border-none focus:ring-0 cursor-pointer ${isStaff?'text-red-600':'text-blue-600'} outline-none"><option value="Giocatore" ${o.type==='Giocatore'?'selected':''}>GIOCATORE</option><option value="Staff" ${o.type==='Staff'?'selected':''}>STAFF</option></select>`;
                const isDuplicate = nameCounts[o.customer.trim().toLowerCase()] > 1;
                const customerClass = isDuplicate ?
                "w-full border rounded px-1 text-xs font-medium duplicate-highlight leading-tight" : "w-full border rounded px-1 text-xs font-medium leading-tight";
                
                // Dividi nome e cognome su due righe
                const customerParts = o.customer.trim().split(' ');
                let customerDisplay = o.customer;
                if (customerParts.length >= 2) {
                    const firstName = customerParts[0];
                    const lastName = customerParts.slice(1).join(' ');
                    customerDisplay = `${firstName}\n${lastName}`;
                }
                
                // Note con colore
                const noteColor = o.noteColor || 'default';
                const noteClass = `note-${noteColor}`;
                const noteText = o.notes || '';
                const notePreview = noteText.length > 30 ? noteText.substring(0, 30) + '...' : noteText;
                
                // Badge scalato magazzino
                const inventoryBadge = o.inventoryScaledAt ? 
                    `<span class="text-[9px] bg-green-100 text-green-800 px-1 py-0.5 rounded font-bold border border-green-300" title="Scalato dal magazzino il ${o.inventoryScaledAt}">üì¶ SCALATO</span>` : '';
                
                tr.innerHTML = `<td class="px-4 py-3 text-xs text-gray-500 font-bold"><input value="${o.displayId}" onblur="updateOrderField(${o.id}, 'displayId', this.value)" class="w-full text-left border rounded px-1 text-xs font-bold uppercase"></td>
                <td class="px-2 py-1 font-medium text-xs" style="min-width: 120px; max-width: 150px;"><textarea rows="2" onblur="updateOrderField(${o.id}, 'customer', this.value)" class="${customerClass}" style="resize: none; height: 36px; overflow: hidden;">${customerDisplay}</textarea><span class="block">${roleSelector}</span></td>
                <td class="px-4 py-3"><input value="${o.roleOrYear || ''}" onblur="updateOrderField(${o.id}, 'roleOrYear', this.value)" class="w-full border rounded px-1 text-xs text-center" placeholder="Anno/Ruolo"></td>
                <td class="px-4 py-3 text-sm text-gray-700"><select onchange="updateOrderField(${o.id}, 'kitType', this.value)" class="text-xs border rounded p-1 w-full">${kitOptions}</select></td>
                <td class="px-4 py-3 text-xs text-gray-500 note-cell" onclick="openNotesPopup(${o.id})" title="Clicca per modificare la nota">
                    <div class="w-full border-2 rounded px-2 py-1 ${noteClass} cursor-pointer hover:shadow-md transition">
                        ${notePreview || '<span class="text-gray-400 italic">Aggiungi nota...</span>'}
                    </div>
                </td>
                <td class="px-4 py-3"><button onclick="openItemModal(${o.id})" class="edit-order-btn bg-white border border-gray-200 text-gray-700 text-xs px-3 py-2 rounded shadow-sm w-full text-left flex justify-between"><span>${o.itemsList.length} Capi</span><i class="fas fa-edit"></i></button></td><td class="px-4 py-3 text-center"><input value="${o.mainSize}" onchange="updateSizes(${o.id}, 'main', this.value)" class="edit-order-btn w-12 text-center border rounded text-xs font-bold"></td><td class="px-4 py-3 text-center"><input value="${o.sockSize}" onchange="updateSizes(${o.id}, 'sock', this.value)" class="edit-order-btn w-12 text-center border rounded text-xs font-bold text-gray-600"></td><td class="px-4 py-3 text-center text-xs font-bold text-blue-800">${bagType}</td><td class="px-4 py-3 text-center"><div class="flex flex-col items-end"><span class="price-display">${finalTotal}‚Ç¨</span><div class="flex items-center gap-1"><span class="text-[9px] text-gray-400">Sconto:</span><input type="number" value="${o.discount||0}" onchange="updateDiscount(${o.id}, this.value)" class="edit-order-btn discount-input"></div></div></td><td class="px-4 py-3 w-40"><div class="flex flex-col gap-1">${statusInfo}${inventoryBadge}</div></td><td class="px-4 py-3 text-center"><button onclick="downloadOrderToGoogleForm(${o.id})" class="download-google-form-btn text-green-600 hover:text-green-800" title="Scarica ordine tramite Google Form"><i class="fas fa-download"></i></button></td><td class="px-4 py-3 text-center"><button onclick="openItemModal(${o.id})" class="edit-order-btn text-blue-600 hover:text-blue-800"><i class="fas fa-cog"></i></button></td><td class="px-4 py-3 text-center"><button onclick="deleteOrder(${o.id})" class="delete-order-btn text-red-500 hover:text-red-700"><i class="fas fa-trash-alt"></i></button></td>`; tbody.appendChild(tr);
            });
        }

        function populateIdSelects(sortedOrders) { const minSel = document.getElementById('matrixMinId'); const maxSel = document.getElementById('matrixMaxId');
        minSel.innerHTML = ''; maxSel.innerHTML = ''; if(sortedOrders.length === 0) return;
        sortedOrders.forEach(o => { const optMin = document.createElement('option'); optMin.value = o.displayId; optMin.text = o.displayId; const optMax = document.createElement('option'); optMax.value = o.displayId; optMax.text = o.displayId; minSel.appendChild(optMin); maxSel.appendChild(optMax); });
        }

        function renderMatrices(manualUpdate = false) {
            const minSel = document.getElementById('matrixMinId');
            const maxSel = document.getElementById('matrixMaxId');
            
            const NET_STATUSES = ['Nuovo']; // Solo ordini nuovi per calcolo ordine fornitore
            
            // GROSS: Tutti gli ordini nel range (esclusi annullati e trasferiti)
            let ordersGross = orders.filter(o => 
                o.status !== 'Ordine trasferito ad altro ID' && 
                o.status !== 'Ordine annullato'
            );
            
            // NET: Solo ordini "Nuovo" (esclusi annullati e trasferiti) - INCLUDE anche ordini scalati
            let ordersNet = orders.filter(o => 
                NET_STATUSES.includes(o.status) && 
                o.status !== 'Ordine trasferito ad altro ID' &&
                o.status !== 'Ordine annullato'
            );
            
            // Ordina usando la funzione globale
            ordersGross = sortOrdersByDisplayId(ordersGross, true);
            ordersNet = sortOrdersByDisplayId(ordersNet, true);
            let allSorted = sortOrdersByDisplayId(orders, true);
            
            if (!manualUpdate) { 
                populateIdSelects(allSorted);
                if (allSorted.length > 0) {
                     const firstNew = allSorted.find(o => o.status === 'Nuovo');
                     const lastOrder = allSorted[allSorted.length - 1];
                     if (firstNew) {
                         minSel.value = firstNew.displayId;
                         maxSel.value = lastOrder.displayId;
                     } else {
                         minSel.value = allSorted[0].displayId;
                         maxSel.value = lastOrder.displayId;
                     }
                }
            } 

            let filteredGross = ordersGross;
            let filteredNet = ordersNet;

            // Applica filtro ID se sono selezionati min e max
            if (minSel.value && maxSel.value) { 
                // Usa la funzione globale compareDisplayIds per il filtro
                filteredGross = ordersGross.filter(o => {
                    return compareDisplayIds(o.displayId, minSel.value) >= 0 && 
                           compareDisplayIds(o.displayId, maxSel.value) <= 0;
                });
                filteredNet = ordersNet.filter(o => {
                    return compareDisplayIds(o.displayId, minSel.value) >= 0 && 
                           compareDisplayIds(o.displayId, maxSel.value) <= 0;
                });
                
                // DEBUG: Log per verificare filtro ordine netto
                console.log(`üìä ORDINE NETTO - Range: ${minSel.value} ‚Üí ${maxSel.value}`);
                console.log(`   üì¶ Ordini GROSS nel range: ${filteredGross.length}`);
                console.log(`   ‚ú® Ordini NET nel range (Nuovo NON scalati): ${filteredNet.length}`);
                console.log(`   üü¢ Ordini scalati esclusi da NET:`, orders.filter(o => {
                    return o.status === 'Nuovo' && o.inventoryScaledAt && 
                           compareDisplayIds(o.displayId, minSel.value) >= 0 && 
                           compareDisplayIds(o.displayId, maxSel.value) <= 0;
                }).map(o => `${o.displayId} (scalato: ${o.inventoryScaledAt})`));
            }
            
            const rangeTxt = (minSel.value && maxSel.value) ? `${minSel.value} -> ${maxSel.value}` : 'Tutti';
            const nowTxt = new Date().toLocaleString('it-IT');
            const infoHtml = `<span class="supplier-info"><i class="fas fa-info-circle mr-1"></i>ID: ${rangeTxt} | ${nowTxt}</span>`;
            
            const titleNet = document.getElementById('title-net-clothing'); if (titleNet) titleNet.innerHTML = `<span><i class="fas fa-shopping-cart mr-2"></i> 3. Ordine Fornitore (Netto) ${infoHtml}</span>`;
            const titleSock = document.getElementById('title-net-socks'); 
            if (titleSock) {
                titleSock.innerHTML = `
                    <span>Calze da Ordinare (Netto) ${infoHtml}</span>
                    <button onclick="openTableFullscreen('netSocks')" class="bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded text-xs font-bold transition" title="Apri a schermo intero">
                        <i class="fas fa-expand mr-1"></i> Espandi
                    </button>
                `;
            }

            renderGenericMatrix('grossTable', 'grossHeader', 'grossBody', globalItems, filteredGross, 'GROSS');
            renderGenericMatrix('invClothingTable', 'invClothingHeader', 'invClothingBody', globalItems, filteredGross, 'INV'); 
            renderGenericMatrix('netTable', 'netHeader', 'netBody', globalItems, filteredNet, 'NET'); 
            
            renderSocksTable(filteredGross, 'INV'); 
            renderSocksTable(filteredNet, 'NET', true); 
            
            // NON chiamare pi√π updateDashboardCounts qui - la Dashboard ha i suoi filtri indipendenti
            renderChart();
        }

        function updateDashboardCounts() {
            // PARTE 1: Totali GENERALI (TUTTI gli ordini attivi, senza filtri)
            const allValidOrders = orders.filter(o => 
                o.status !== 'Ordine annullato' && 
                o.status !== 'Ordine trasferito ad altro ID'
            );
            
            let staffCount = 0; let playerCount = 0; let thermalCount = 0;
            allValidOrders.forEach(o => { 
                o.itemsList.forEach(item => { 
                    if(item.name.includes("Staff") || item.name.includes("RED") || item.name.includes("SAPPHIRE")) { 
                        staffCount++; 
                    } else if (item.name.includes("Termica") || item.name.includes("Termico")) { 
                        thermalCount++; 
                    } else { 
                        playerCount++; 
                    } 
                }); 
            });
            
            // Card superiori: SEMPRE totali generali
            document.getElementById('dash-total').innerText = allValidOrders.length; 
            document.getElementById('dash-total-all').innerText = orders.length;
            document.getElementById('dash-staff-items').innerText = staffCount; 
            document.getElementById('dash-thermal-items').innerText = thermalCount; 
            document.getElementById('dash-player-items').innerText = playerCount;
            
            // Totali finanziari GENERALI
            let totalGross = 0; 
            let totalDisc = 0;
            allValidOrders.forEach(o => { 
                const net = calculateOrderTotal(o); 
                const disc = o.discount || 0; 
                totalGross += (net + disc); 
                totalDisc += disc; 
            });
            const totalNet = totalGross - totalDisc;
            
            document.getElementById('dash-money-gross').innerText = totalGross + '‚Ç¨';
            document.getElementById('dash-money-discount').innerText = totalDisc + '‚Ç¨';
            document.getElementById('dash-money-net').innerText = totalNet + '‚Ç¨';
        }

        function formatHeaderName(name) {
            let s = name;
            
            // STEP 1: Rimuovi SOLO il prezzo tra parentesi (es: "(25‚Ç¨)" o "(15‚Ç¨)")
            s = s.replace(/\s*\(\d+‚Ç¨\)\s*/g, '');
            
            // STEP 2: Abbreviazioni MINIME solo per parole molto comuni e ridondanti
            s = s.replace(/Blu Marino/gi, 'Blu');
            s = s.replace(/Blu Marine/gi, 'Blu');
            s = s.replace(/Blue Marine/gi, 'Blu');
            
            // Lista modelli comuni da riconoscere per lo spezzamento
            const models = ['DOVO', 'BORGO', 'GASTON', 'GASSOLO', 'DALCITO', 'GASTIO', 'BAJO', 'WISTER', 'BURAN', 'HARDBASE', 'BACKPACK', 'ZUCOT', 'NECK', 'VURBAT', 'VANT', 'WULGAR', 'Player', 'FESOLO', 'FAVIO', 'FARCO', 'GREVOLO', 'BANITO'];
            
            // STEP 3: Trova il punto migliore per spezzare su 2 righe
            let found = false;
            
            // Opzione A: Spezza al modello se presente
            for (let m of models) { 
                if (s.includes(m) && !s.startsWith(m)) { 
                    const regex = new RegExp('\\s+' + m, 'i');
                    s = s.replace(regex, '<br>' + m);
                    found = true; 
                    break; 
                } 
            }
            
            // Opzione B: Se non c'√® modello, spezza in modo intelligente
            if (!found) {
                // B1: Dopo il tipo di capo (Felpa, Polo, ecc.)
                if (s.match(/^(Felpa|T-Shirt|Polo|Pantalone|Pantaloncino|Giaccone|Giacca|Maglia|K-Way|Zaino|Borsone|Guanti|Scaldacollo|Cappellino|Ciabattine|Calzettoni)\s/)) {
                    s = s.replace(/^(Felpa|T-Shirt|Polo|Pantalone|Pantaloncino|Giaccone|Giacca|Maglia|K-Way|Zaino|Borsone|Guanti|Scaldacollo|Cappellino|Ciabattine|Calzettoni)\s/, '$1<br>');
                    found = true;
                }
                // B2: Prima di aggettivi lunghi
                else if (s.includes(' Allenamento')) {
                    s = s.replace(' Allenamento', '<br>Allenamento');
                    found = true;
                }
                else if (s.includes(' Invernale')) {
                    s = s.replace(' Invernale', '<br>Invernale');
                    found = true;
                }
                // B3: Prima dei codici colore
                else if (s.includes(' col.') || s.includes(' COL.')) {
                    s = s.replace(/ (col\.|COL\.)/i, '<br>$1');
                    found = true;
                }
                // B4: Prima di "Blu" se √® nella seconda met√†
                else if (s.indexOf(' Blu') > s.length / 3) {
                    s = s.replace(' Blu', '<br>Blu');
                    found = true;
                }
                // B5: Per nomi lunghi (>25 char), spezza circa a met√†
                else if (s.length > 25) {
                    const midPoint = Math.floor(s.length / 2);
                    // Cerca lo spazio pi√π vicino al punto medio
                    let bestSpace = -1;
                    let minDistance = 999;
                    for (let i = 0; i < s.length; i++) {
                        if (s[i] === ' ') {
                            const distance = Math.abs(i - midPoint);
                            if (distance < minDistance) {
                                minDistance = distance;
                                bestSpace = i;
                            }
                        }
                    }
                    if (bestSpace > 0) {
                        s = s.substring(0, bestSpace) + '<br>' + s.substring(bestSpace + 1);
                        found = true;
                    }
                }
            }
            
            // STEP 4: Assicurati di avere MASSIMO 1 solo <br>
            const brCount = (s.match(/<br>/g) || []).length;
            if (brCount > 1) {
                const parts = s.split('<br>');
                s = parts[0] + '<br>' + parts.slice(1).join(' ');
            }
            
            return s;
        }

        function renderGenericMatrix(tid, hid, bid, columns, filteredOrders, mode) {
            const thead = document.getElementById(hid); let bgHead = mode === 'INV' ? 'bg-yellow-50' : (mode === 'GROSS' ? 'bg-blue-50' : 'bg-gray-100'); let hHTML = `<th class="px-0 py-0 ${bgHead} sticky-col border-r shadow w-16 text-center align-middle text-sm font-bold" style="vertical-align: middle;"><div style="writing-mode: horizontal-tb; transform: none; height: auto; display: flex; align-items: center; justify-content: center; padding: 4px;">TAGLIA</div></th>`; 
            columns.forEach(c => { if(isSockItem(c)) return; let bgClass = c.includes("Staff") ? "bg-red-50 text-red-900" : "bg-gray-50"; hHTML += `<th class="border-l align-bottom pb-2 ${bgClass}"><div class="vertical-header">${formatHeaderName(c)}</div></th>`; }); 
            thead.innerHTML = `<tr>${hHTML}</tr>`;
            const tbody = document.getElementById(bid); tbody.innerHTML = ''; 
            
            let sizes = new Set(); 
            // Taglie calzettoni da escludere dalla tabella abbigliamento
            const SOCK_SIZES = ["23/26", "27/30", "31/34", "35/38", "39/42", "43/46"];
            
            if (mode === 'INV') {
                 SIZE_ORDER.forEach(s => {
                     if (!SOCK_SIZES.includes(s)) sizes.add(s);
                 });
            } else {
                // Aggiungi solo le taglie abbigliamento (escluse calze)
                SIZE_ORDER.forEach(s => {
                    if (!SOCK_SIZES.includes(s)) sizes.add(s);
                });
                
                // Poi aggiungi le taglie effettivamente presenti negli ordini (escluse calze)
                filteredOrders.forEach(o => o.itemsList.forEach(i => { 
                    if(!isSockItem(i.name) && !SOCK_SIZES.includes(i.size)) sizes.add(i.size) 
                }));
                Object.keys(inventory).forEach(k => { 
                    const [item, size] = k.split('_'); 
                    if(columns.includes(item) && !isSockItem(item) && !SOCK_SIZES.includes(size)) sizes.add(size); 
                });
            }
            
            let sortedSizes = Array.from(sizes).filter(s=>s && s!=='UNICA');
            sortedSizes.sort((a, b) => {
                let idxA = SIZE_ORDER.indexOf(a.toUpperCase());
                let idxB = SIZE_ORDER.indexOf(b.toUpperCase());
                if (idxA === -1) idxA = 999; 
                if (idxB === -1) idxB = 999;
                return idxA - idxB;
            });
            if(sizes.has('UNICA')) sortedSizes.push('UNICA');

            const colTotals = {}; columns.forEach(c => colTotals[c] = 0);
            sortedSizes.forEach(size => { 
                const tr = document.createElement('tr'); 
                let bgCol = mode === 'INV' ? 'bg-yellow-50' : 'bg-white'; 
                const isSectionRow = size.includes('TAGLIA');
                const sizeClass = isSectionRow ? 'size-section-row' : '';
                let rHTML = `<td class="px-4 py-0 font-bold ${bgCol} sticky-col border-r shadow border-b ${sizeClass}">${size}</td>`;
                columns.forEach(col => { 
                    if(isSockItem(col)) return;
                    
                    // Conta TUTTI gli ordini filtrati (inclusi quelli con badge)
                    let countNeeded = 0; 
                    filteredOrders.forEach(o => { 
                        o.itemsList.forEach(i => { 
                            if(i.name===col && i.size===size) countNeeded++ 
                        }); 
                    }); 
                    
                    const stockKey = `${col}_${size}`; 
                    const stockVal = inventory[stockKey] !== undefined ? inventory[stockKey] : ''; 
                    const stockInt = parseInt(stockVal) || 0;
                    let valForTotal = 0;
                    
                    if (mode === 'GROSS') { 
                        rHTML += `<td class="text-center border-b border-l py-0 ${sizeClass} ${countNeeded>0?'bg-blue-50 font-bold':''}">${countNeeded || '-'}</td>`; 
                        valForTotal = countNeeded; 
                    } 
                    else if (mode === 'INV') { 
                        rHTML += `<td class="text-center border-b border-l bg-white py-0 ${sizeClass}"><input type="number" value="${stockVal}" onchange="updateInventory('${col}', '${size}', this.value)" class="inv-input" placeholder="-"></td>`;
                        valForTotal = stockInt; 
                    } 
                    else if (mode === 'NET') { 
                        // Conta quanti di questi articoli sono gi√† stati scalati dal magazzino
                        let alreadyScaledCount = 0;
                        filteredOrders.forEach(o => {
                            if (o.inventoryScaledAt && o.scaledItems) {
                                const scaledKey = `${col}_${size}`;
                                if (o.scaledItems[scaledKey]) {
                                    alreadyScaledCount += o.scaledItems[scaledKey];
                                }
                            }
                        });
                        
                        // NET = Richiesta totale - Articoli gi√† scalati
                        // Il magazzino NON viene sottratto qui, viene "consumato" quando clicchi Scala
                        const toBuy = Math.max(0, countNeeded - alreadyScaledCount);
                        
                        // DEBUG: Log dettagliato per ogni cella
                        if (countNeeded > 0 || alreadyScaledCount > 0) {
                            console.log(`üìä ${col} [${size}]: Richiesta=${countNeeded}, Scalati=${alreadyScaledCount}, NET=${toBuy}, Mag=${stockInt}`);
                        }
                        
                        const displayClass = toBuy > 0 ? 'buy-alert' : 'buy-ok'; 
                        const displayVal = toBuy > 0 ? toBuy : '-';
                        rHTML += `<td class="text-center border-b border-l bg-white py-0 ${sizeClass}"><span class="net-val ${displayClass}">${displayVal}</span></td>`; 
                        valForTotal = toBuy;
                    }
                    colTotals[col] += valForTotal;
                }); 
                tr.innerHTML = rHTML; tbody.appendChild(tr);
            });
            const trTotal = document.createElement('tr'); trTotal.className = 'total-row';
            let htmlTotal = `<td class="px-4 py-2 font-bold sticky-col border-r shadow">TOTALE</td>`;
            columns.forEach(col => { if(col.includes("Calzettoni")) return; htmlTotal += `<td class="text-center border-l p-2">${colTotals[col]}</td>`; }); trTotal.innerHTML = htmlTotal; tbody.appendChild(trTotal);
        }
        
        function renderSocksTable(filteredOrders, mode) { 
            const targetBody = mode === 'INV' ? 'invSocksBody' : 'netSocksBody'; 
            const tbody = document.getElementById(targetBody); 
            tbody.innerHTML = ''; 
            
            // Imposta gli header
            document.getElementById(mode === 'INV' ? 'headerSockBlue' : 'headerSockNetBlue').innerHTML = formatHeaderName(SOCKS_BLUE_DEFAULT);
            document.getElementById(mode === 'INV' ? 'headerSockRed' : 'headerSockNetRed').innerHTML = formatHeaderName(SOCKS_RED_DEFAULT);
            document.getElementById(mode === 'INV' ? 'headerSockSpolfBlue' : 'headerSockNetSpolfBlue').innerHTML = formatHeaderName(SOCKS_SPOLF_BLUE);
            document.getElementById(mode === 'INV' ? 'headerSockSpolfRed' : 'headerSockNetSpolfRed').innerHTML = formatHeaderName(SOCKS_SPOLF_RED);
            
            let sizes = new Set(); 
            filteredOrders.forEach(o => o.itemsList.forEach(i => { if(isSockItem(i.name)) sizes.add(i.size) }));
            Object.keys(inventory).forEach(k => { const [item, size] = k.split('_'); if(isSockItem(item)) sizes.add(size); });
            
            // Aggiungi tutte le 6 taglie standard per calze
            sizes.add("23/26");
            sizes.add("27/30");
            sizes.add("31/34");
            sizes.add("35/38");
            sizes.add("39/42");
            sizes.add("43/46");

            let sorted = Array.from(sizes).filter(s=>s);
            sorted.sort((a, b) => {
                let idxA = SIZE_ORDER.indexOf(a.toUpperCase());
                let idxB = SIZE_ORDER.indexOf(b.toUpperCase());
                if (idxA === -1) idxA = 999;
                if (idxB === -1) idxB = 999;
                return idxA - idxB;
            });
            
            let totalBlue = 0, totalRed = 0, totalSpolfBlue = 0, totalSpolfRed = 0;
            
            sorted.forEach(s => { 
                // Conta richieste per ogni tipo di calza
                let blueNeeded = 0, redNeeded = 0, spolfBlueNeeded = 0, spolfRedNeeded = 0;
                filteredOrders.forEach(o => { 
                    o.itemsList.forEach(i => { 
                        if(i.name === SOCKS_BLUE_DEFAULT && i.size===s) blueNeeded++; 
                        if(i.name === SOCKS_RED_DEFAULT && i.size===s) redNeeded++;
                        if(i.name === SOCKS_SPOLF_BLUE && i.size===s) spolfBlueNeeded++;
                        if(i.name === SOCKS_SPOLF_RED && i.size===s) spolfRedNeeded++;
                    }); 
                });
                
                // Chiavi inventario
                const blueKey = `${SOCKS_BLUE_DEFAULT}_${s}`;
                const redKey = `${SOCKS_RED_DEFAULT}_${s}`;
                const spolfBlueKey = `${SOCKS_SPOLF_BLUE}_${s}`;
                const spolfRedKey = `${SOCKS_SPOLF_RED}_${s}`;
                
                // Valori inventario
                const blueStockVal = inventory[blueKey] !== undefined ? inventory[blueKey] : '';
                const blueStockInt = parseInt(blueStockVal) || 0;
                const redStockVal = inventory[redKey] !== undefined ? inventory[redKey] : '';
                const redStockInt = parseInt(redStockVal) || 0;
                const spolfBlueStockVal = inventory[spolfBlueKey] !== undefined ? inventory[spolfBlueKey] : '';
                const spolfBlueStockInt = parseInt(spolfBlueStockVal) || 0;
                const spolfRedStockVal = inventory[spolfRedKey] !== undefined ? inventory[spolfRedKey] : '';
                const spolfRedStockInt = parseInt(spolfRedStockVal) || 0;
                
                // Conta calze gi√† scalate
                let blueScaled = 0, redScaled = 0, spolfBlueScaled = 0, spolfRedScaled = 0;
                filteredOrders.forEach(o => {
                    if (o.inventoryScaledAt && o.scaledItems) {
                        if (o.scaledItems[blueKey]) blueScaled += o.scaledItems[blueKey];
                        if (o.scaledItems[redKey]) redScaled += o.scaledItems[redKey];
                        if (o.scaledItems[spolfBlueKey]) spolfBlueScaled += o.scaledItems[spolfBlueKey];
                        if (o.scaledItems[spolfRedKey]) spolfRedScaled += o.scaledItems[spolfRedKey];
                    }
                });
                
                let valBlue = 0, valRed = 0, valSpolfBlue = 0, valSpolfRed = 0;
                const tr = document.createElement('tr'); 
                tr.className = "border-b"; 
                let html = `<td class="px-4 py-0 font-bold text-center ${mode==='INV'?'bg-yellow-50':'bg-gray-50'}">${s}</td>`;
                
                const renderCell = (needed, stockVal, stockInt, scaledCount, itemName) => { 
                    if(mode === 'INV') { 
                        return `<td class="text-center border-l bg-white py-0"><input type="number" value="${stockVal}" onchange="updateInventory('${itemName}', '${s}', this.value)" class="inv-input" placeholder="-"></td>`;
                    } else { 
                        const toBuy = Math.max(0, needed - scaledCount); 
                        const cls = toBuy > 0 ? 'buy-alert' : 'buy-ok'; 
                        const val = toBuy > 0 ? toBuy : '-';
                        return `<td class="text-center border-l bg-white py-0"><span class="net-val ${cls}">${val}</span></td>`; 
                    } 
                };
                
                html += renderCell(blueNeeded, blueStockVal, blueStockInt, blueScaled, SOCKS_BLUE_DEFAULT);
                html += renderCell(redNeeded, redStockVal, redStockInt, redScaled, SOCKS_RED_DEFAULT);
                html += renderCell(spolfBlueNeeded, spolfBlueStockVal, spolfBlueStockInt, spolfBlueScaled, SOCKS_SPOLF_BLUE);
                html += renderCell(spolfRedNeeded, spolfRedStockVal, spolfRedStockInt, spolfRedScaled, SOCKS_SPOLF_RED);
                
                if(mode === 'INV') {
                    totalBlue += blueStockInt;
                    totalRed += redStockInt;
                    totalSpolfBlue += spolfBlueStockInt;
                    totalSpolfRed += spolfRedStockInt;
                } else {
                    totalBlue += Math.max(0, blueNeeded - blueScaled);
                    totalRed += Math.max(0, redNeeded - redScaled);
                    totalSpolfBlue += Math.max(0, spolfBlueNeeded - spolfBlueScaled);
                    totalSpolfRed += Math.max(0, spolfRedNeeded - spolfRedScaled);
                }
                
                tr.innerHTML = html; 
                tbody.appendChild(tr);
            });
            
            const trTotal = document.createElement('tr'); 
            trTotal.className = 'total-row'; 
            trTotal.innerHTML = `<td class="px-4 py-2 font-bold sticky-col border-r shadow">TOTALE</td><td class="text-center border-l p-2">${totalBlue}</td><td class="text-center border-l p-2">${totalRed}</td><td class="text-center border-l p-2">${totalSpolfBlue}</td><td class="text-center border-l p-2">${totalSpolfRed}</td>`;
            tbody.appendChild(trTotal);
        }

        function renderChart() { 
            const validOrders = orders.filter(o => o.status !== 'Ordine annullato' && o.status !== 'Ordine trasferito ad altro ID');
            const ctx = document.getElementById('chartStatus').getContext('2d'); if(chartStatus) chartStatus.destroy(); chartStatus = new Chart(ctx, { type: 'doughnut', data: { labels: ['Nuovo', 'In Lav.', 'Pagato', 'Finito'], datasets: [{ data: [validOrders.filter(o=>o.status==='Nuovo').length, validOrders.filter(o=>o.status==='In Lavorazione').length, validOrders.filter(o=>o.status==='Pagato').length, validOrders.filter(o=>o.status==='Consegnato').length], backgroundColor: ['#fbbf24', '#3b82f6', '#15803d', '#374151'] }] }, options: { responsive: true, maintainAspectRatio: false } });
            
            // Calcola totali GENERALI per il grafico (tutti gli ordini attivi)
            let totalGross = 0; 
            let totalDisc = 0;
            validOrders.forEach(o => { 
                const net = calculateOrderTotal(o); 
                const disc = o.discount || 0; 
                totalGross += (net + disc); 
                totalDisc += disc; 
            });
            const totalNet = totalGross - totalDisc;
            
            // Popola filtri Dashboard se non ancora fatto
            populateDashboardIdFilters();
            
            // PARTE FILTRATA: Totali filtrati da range ID (FILTRI PROPRI DELLA DASHBOARD)
            const minIdSel = document.getElementById('dashboardMinId');
            const maxIdSel = document.getElementById('dashboardMaxId');
            
            if (minIdSel && maxIdSel && minIdSel.value && maxIdSel.value) {
                const filteredOrders = validOrders.filter(o => {
                    return compareDisplayIds(o.displayId, minIdSel.value) >= 0 && 
                           compareDisplayIds(o.displayId, maxIdSel.value) <= 0;
                });
                
                let filteredGross = 0;
                let filteredDisc = 0;
                filteredOrders.forEach(o => {
                    const net = calculateOrderTotal(o);
                    const disc = o.discount || 0;
                    filteredGross += (net + disc);
                    filteredDisc += disc;
                });
                const filteredNet = filteredGross - filteredDisc;
                
                document.getElementById('dash-filtered-range').innerText = `${minIdSel.value} ‚Üí ${maxIdSel.value}`;
                document.getElementById('dash-filtered-count').innerText = filteredOrders.length;
                document.getElementById('dash-filtered-gross').innerText = filteredGross + '‚Ç¨';
                document.getElementById('dash-filtered-net').innerText = filteredNet + '‚Ç¨';
                
                // Breakdown per tipo KIT
                const kitBreakdown = {};
                filteredOrders.forEach(o => {
                    const kitType = o.kitType || 'Non specificato';
                    if (!kitBreakdown[kitType]) {
                        kitBreakdown[kitType] = 0;
                    }
                    kitBreakdown[kitType]++;
                });
                
                // Ordina per quantit√† decrescente
                const sortedKits = Object.entries(kitBreakdown).sort((a, b) => b[1] - a[1]);
                
                let breakdownHtml = '';
                sortedKits.forEach(([kitName, count]) => {
                    const cleanName = kitName.split('(')[0].trim();
                    const isStaff = kitName.includes('Allenatore') || kitName.includes('Dirigente') || kitName.includes('Staff');
                    const isSingolo = kitName.includes('Singolo') || kitName.includes('Personalizzato');
                    
                    let bgColor = 'bg-blue-100';
                    let textColor = 'text-blue-900';
                    let icon = 'fa-tshirt';
                    
                    if (isStaff) {
                        bgColor = 'bg-red-100';
                        textColor = 'text-red-900';
                        icon = 'fa-user-tie';
                    } else if (isSingolo) {
                        bgColor = 'bg-orange-100';
                        textColor = 'text-orange-900';
                        icon = 'fa-shopping-bag';
                    } else if (kitName.includes('Portiere')) {
                        bgColor = 'bg-yellow-100';
                        textColor = 'text-yellow-900';
                        icon = 'fa-hand-paper';
                    }
                    
                    breakdownHtml += `
                        <div class="${bgColor} p-3 rounded border-l-4 border-${bgColor.replace('100', '500')}">
                            <div class="flex items-center justify-between">
                                <i class="fas ${icon} ${textColor} opacity-50"></i>
                                <span class="text-2xl font-bold ${textColor}">${count}</span>
                            </div>
                            <div class="text-xs ${textColor} mt-1 font-medium leading-tight">${cleanName}</div>
                        </div>
                    `;
                });
                
                document.getElementById('dash-filtered-breakdown').innerHTML = breakdownHtml || '<div class="text-gray-400 italic col-span-full text-center">Nessun ordine nel range</div>';
            } else {
                document.getElementById('dash-filtered-range').innerText = 'Nessun filtro';
                document.getElementById('dash-filtered-count').innerText = '0';
                document.getElementById('dash-filtered-gross').innerText = '0‚Ç¨';
                document.getElementById('dash-filtered-net').innerText = '0‚Ç¨';
                document.getElementById('dash-filtered-breakdown').innerHTML = '<div class="text-gray-400 italic col-span-full text-center">Seleziona un range ID per vedere il breakdown</div>';
            }
            
            const ctxRev = document.getElementById('chartRevenue').getContext('2d'); if(chartRevenue) chartRevenue.destroy();
            chartRevenue = new Chart(ctxRev, { type: 'bar', data: { labels: ['Totale Listino', 'Sconti', 'Totale Netto'], datasets: [{ label: 'Valore in ‚Ç¨', data: [totalGross, totalDisc, totalNet], backgroundColor: ['#4338ca', '#ef4444', '#15803d'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } });
            const itemCounts = {}; 
            validOrders.forEach(o => { 
                o.itemsList.forEach(item => { 
                    // Rimuovi SOLO il prezzo finale (es: "(25‚Ç¨)"), non tutte le parentesi
                    let cleanName = item.name.replace(/\s*\(\d+‚Ç¨\)\s*$/, '').trim();
                    if (!itemCounts[cleanName]) itemCounts[cleanName] = 0; 
                    itemCounts[cleanName]++; 
                }); 
            });
            const sortedItems = Object.entries(itemCounts).sort((a,b) => b[1] - a[1]); const labels = sortedItems.map(x => x[0]); const data = sortedItems.map(x => x[1]);
            const ctxItems = document.getElementById('chartItems').getContext('2d'); if(chartItems) chartItems.destroy(); chartItems = new Chart(ctxItems, { type: 'bar', data: { labels: labels, datasets: [{ label: 'Quantit√† Venduta', data: data, backgroundColor: '#3b82f6', borderRadius: 4 }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { beginAtZero: true } }, plugins: { legend: { display: false } } } });
            
            // Inizializza anche l'analisi per kit
            populateKitFilterOptions();
            renderKitAnalysis();
        }
        
        // Popola il select con i tipi di kit disponibili
        function populateKitFilterOptions() {
            const select = document.getElementById('dashboardKitFilter');
            if (!select) return;
            
            // Raccogli tutti i tipi di kit dagli ordini
            const kitTypes = new Set();
            orders.forEach(o => {
                if (o.kitType && o.status !== 'Ordine annullato' && o.status !== 'Ordine trasferito ad altro ID') {
                    kitTypes.add(o.kitType);
                }
            });
            
            // Ordina alfabeticamente
            const sortedKits = Array.from(kitTypes).sort();
            
            // Mantieni la selezione corrente
            const currentValue = select.value;
            
            // Ricostruisci le opzioni
            select.innerHTML = '<option value="all">üìä Tutti i Kit</option>';
            sortedKits.forEach(kit => {
                const cleanName = kit.split('(')[0].trim();
                const opt = document.createElement('option');
                opt.value = kit;
                opt.textContent = cleanName;
                select.appendChild(opt);
            });
            
            // Ripristina selezione se ancora valida
            if (currentValue && (currentValue === 'all' || sortedKits.includes(currentValue))) {
                select.value = currentValue;
            }
        }
        
        // Analisi dettagliata per tipo kit
        function renderKitAnalysis() {
            const filterValue = document.getElementById('dashboardKitFilter')?.value || 'all';
            
            // Filtri ID della Dashboard
            const minIdSel = document.getElementById('dashboardMinId');
            const maxIdSel = document.getElementById('dashboardMaxId');
            
            // Filtra ordini validi E nel range ID della Dashboard
            let filteredOrders = orders.filter(o => {
                if (o.status === 'Ordine annullato' || o.status === 'Ordine trasferito ad altro ID') {
                    return false;
                }
                // Applica filtro ID se presente
                if (minIdSel && maxIdSel && minIdSel.value && maxIdSel.value) {
                    if (compareDisplayIds(o.displayId, minIdSel.value) < 0 || 
                        compareDisplayIds(o.displayId, maxIdSel.value) > 0) {
                        return false;
                    }
                }
                return true;
            });
            
            // Applica filtro kit se non √® "all"
            if (filterValue !== 'all') {
                filteredOrders = filteredOrders.filter(o => o.kitType === filterValue);
            }
            
            // Calcola totali
            let totalGross = 0;
            let totalDiscount = 0;
            filteredOrders.forEach(o => {
                const net = calculateOrderTotal(o);
                const disc = o.discount || 0;
                totalGross += (net + disc);
                totalDiscount += disc;
            });
            const totalNet = totalGross - totalDiscount;
            
            // Aggiorna card riepilogo
            document.getElementById('dash-kit-count').innerText = filteredOrders.length;
            document.getElementById('dash-kit-gross').innerText = totalGross + '‚Ç¨';
            document.getElementById('dash-kit-discount').innerText = totalDiscount + '‚Ç¨';
            document.getElementById('dash-kit-net').innerText = totalNet + '‚Ç¨';
            
            // Breakdown per tipo kit (mostra kit nel range filtrato)
            const kitBreakdown = {};
            const kitTotals = {};
            
            // Usa gli ordini gi√† filtrati per range ID
            const ordersForBreakdown = orders.filter(o => {
                if (o.status === 'Ordine annullato' || o.status === 'Ordine trasferito ad altro ID') {
                    return false;
                }
                if (minIdSel && maxIdSel && minIdSel.value && maxIdSel.value) {
                    if (compareDisplayIds(o.displayId, minIdSel.value) < 0 || 
                        compareDisplayIds(o.displayId, maxIdSel.value) > 0) {
                        return false;
                    }
                }
                return true;
            });
            
            ordersForBreakdown.forEach(o => {
                const kitType = o.kitType || 'Non specificato';
                if (!kitBreakdown[kitType]) {
                    kitBreakdown[kitType] = 0;
                    kitTotals[kitType] = 0;
                }
                kitBreakdown[kitType]++;
                kitTotals[kitType] += calculateOrderTotal(o);
            });
            
            // Ordina per quantit√† decrescente
            const sortedKits = Object.entries(kitBreakdown).sort((a, b) => b[1] - a[1]);
            
            let breakdownHtml = '';
            sortedKits.forEach(([kitName, count]) => {
                const cleanName = kitName.split('(')[0].trim();
                const kitTotal = kitTotals[kitName];
                const isSelected = filterValue === kitName;
                const isStaff = kitName.includes('Allenatore') || kitName.includes('Dirigente') || kitName.includes('Staff');
                const isPortiere = kitName.includes('Portiere');
                const isMini = kitName.includes('Mini');
                
                let bgColor = isSelected ? 'bg-blue-200 border-blue-500' : 'bg-blue-50 border-blue-200';
                let textColor = 'text-blue-900';
                let icon = 'fa-tshirt';
                
                if (isStaff) {
                    bgColor = isSelected ? 'bg-red-200 border-red-500' : 'bg-red-50 border-red-200';
                    textColor = 'text-red-900';
                    icon = 'fa-user-tie';
                } else if (isPortiere) {
                    bgColor = isSelected ? 'bg-yellow-200 border-yellow-500' : 'bg-yellow-50 border-yellow-200';
                    textColor = 'text-yellow-900';
                    icon = 'fa-hand-paper';
                } else if (isMini) {
                    bgColor = isSelected ? 'bg-green-200 border-green-500' : 'bg-green-50 border-green-200';
                    textColor = 'text-green-900';
                    icon = 'fa-child';
                }
                
                breakdownHtml += `
                    <div class="${bgColor} p-3 rounded-lg border-2 cursor-pointer hover:shadow-md transition" 
                         onclick="document.getElementById('dashboardKitFilter').value='${kitName.replace(/'/g, "\\'")}'; renderKitAnalysis();">
                        <div class="flex items-center justify-between mb-1">
                            <i class="fas ${icon} ${textColor} opacity-60"></i>
                            <span class="text-2xl font-bold ${textColor}">${count}</span>
                        </div>
                        <div class="text-xs ${textColor} font-medium leading-tight">${cleanName}</div>
                        <div class="text-xs ${textColor} opacity-70 mt-1">${kitTotal}‚Ç¨</div>
                    </div>
                `;
            });
            
            document.getElementById('dash-kit-breakdown').innerHTML = breakdownHtml || 
                '<div class="text-gray-400 italic col-span-full text-center">Nessun kit trovato</div>';
            
            // === NUOVA SEZIONE: Distribuzione Taglie Kit ===
            const sizeOrder = ['4XS', '3XS', '2XS', 'XS', 'S', 'M', 'L', 'XL', '2XL', '3XL', '4XL', '4 ANNI', '6 ANNI', '8 ANNI', '10 ANNI', '12 ANNI', '14 ANNI', '16 ANNI'];
            const kitSizes = {};
            
            filteredOrders.forEach(o => {
                const size = o.mainSize || 'N/D';
                if (!kitSizes[size]) kitSizes[size] = 0;
                kitSizes[size]++;
            });
            
            // Ordina per ordine taglie standard
            const sortedSizes = Object.entries(kitSizes).sort((a, b) => {
                const idxA = sizeOrder.indexOf(a[0]);
                const idxB = sizeOrder.indexOf(b[0]);
                if (idxA === -1 && idxB === -1) return a[0].localeCompare(b[0]);
                if (idxA === -1) return 1;
                if (idxB === -1) return -1;
                return idxA - idxB;
            });
            
            let sizesHtml = '';
            sortedSizes.forEach(([size, count]) => {
                const isKids = size.includes('ANNI');
                const bgColor = isKids ? 'bg-green-100 border-green-400' : 'bg-purple-100 border-purple-400';
                const textColor = isKids ? 'text-green-800' : 'text-purple-800';
                
                sizesHtml += `
                    <div class="${bgColor} border-2 rounded-lg px-4 py-2 text-center min-w-[70px]">
                        <div class="text-2xl font-bold ${textColor}">${count}</div>
                        <div class="text-xs font-medium ${textColor}">${size}</div>
                    </div>
                `;
            });
            
            document.getElementById('dash-kit-sizes').innerHTML = sizesHtml || 
                '<div class="text-gray-400 italic">Nessuna taglia trovata</div>';
            
            // === NUOVA SEZIONE: Tabella Capi per Taglia ===
            const itemsBySize = {}; // { itemName: { S: 2, M: 3, L: 1, ... } }
            const allSizesSet = new Set();
            
            filteredOrders.forEach(o => {
                o.itemsList.forEach(item => {
                    const cleanName = item.name.replace(/\s*\(\d+‚Ç¨\)\s*$/, '').trim();
                    const size = item.size || 'N/D';
                    
                    allSizesSet.add(size);
                    
                    if (!itemsBySize[cleanName]) {
                        itemsBySize[cleanName] = {};
                    }
                    if (!itemsBySize[cleanName][size]) {
                        itemsBySize[cleanName][size] = 0;
                    }
                    itemsBySize[cleanName][size]++;
                });
            });
            
            // Ordina le taglie
            const allSizes = Array.from(allSizesSet).sort((a, b) => {
                const idxA = sizeOrder.indexOf(a);
                const idxB = sizeOrder.indexOf(b);
                if (idxA === -1 && idxB === -1) return a.localeCompare(b);
                if (idxA === -1) return 1;
                if (idxB === -1) return -1;
                return idxA - idxB;
            });
            
            // Costruisci header tabella
            const tableHeader = document.querySelector('#dash-items-by-size-table thead tr');
            if (tableHeader) {
                let headerHtml = '<th class="px-3 py-2 text-left font-bold text-gray-700 sticky left-0 bg-gray-100">Capo</th>';
                allSizes.forEach(size => {
                    const isKids = size.includes('ANNI');
                    const bgColor = isKids ? 'bg-green-50' : 'bg-purple-50';
                    headerHtml += `<th class="px-2 py-2 text-center font-bold text-gray-700 ${bgColor} min-w-[50px]">${size}</th>`;
                });
                headerHtml += '<th class="px-3 py-2 text-center font-bold text-gray-700 bg-blue-100">TOT</th>';
                tableHeader.innerHTML = headerHtml;
            }
            
            // Costruisci body tabella
            const tableBody = document.getElementById('dash-items-by-size-body');
            if (tableBody) {
                // Ordina per quantit√† totale decrescente
                const sortedItemsBySize = Object.entries(itemsBySize).sort((a, b) => {
                    const totalA = Object.values(a[1]).reduce((sum, v) => sum + v, 0);
                    const totalB = Object.values(b[1]).reduce((sum, v) => sum + v, 0);
                    return totalB - totalA;
                });
                
                let bodyHtml = '';
                sortedItemsBySize.forEach(([itemName, sizes]) => {
                    const total = Object.values(sizes).reduce((sum, v) => sum + v, 0);
                    
                    bodyHtml += `<tr class="border-b hover:bg-gray-50">`;
                    bodyHtml += `<td class="px-3 py-2 font-medium text-gray-800 sticky left-0 bg-white text-xs">${itemName}</td>`;
                    
                    allSizes.forEach(size => {
                        const count = sizes[size] || 0;
                        const cellClass = count > 0 ? 'font-bold text-blue-700' : 'text-gray-300';
                        bodyHtml += `<td class="px-2 py-2 text-center ${cellClass}">${count || '-'}</td>`;
                    });
                    
                    bodyHtml += `<td class="px-3 py-2 text-center font-bold text-white bg-blue-600">${total}</td>`;
                    bodyHtml += `</tr>`;
                });
                
                // Riga totali
                if (sortedItemsBySize.length > 0) {
                    bodyHtml += `<tr class="bg-gray-200 font-bold">`;
                    bodyHtml += `<td class="px-3 py-2 sticky left-0 bg-gray-200">TOTALE</td>`;
                    
                    let grandTotal = 0;
                    allSizes.forEach(size => {
                        let sizeTotal = 0;
                        Object.values(itemsBySize).forEach(sizes => {
                            sizeTotal += sizes[size] || 0;
                        });
                        grandTotal += sizeTotal;
                        bodyHtml += `<td class="px-2 py-2 text-center">${sizeTotal}</td>`;
                    });
                    
                    bodyHtml += `<td class="px-3 py-2 text-center text-white bg-blue-800">${grandTotal}</td>`;
                    bodyHtml += `</tr>`;
                }
                
                tableBody.innerHTML = bodyHtml || '<tr><td colspan="100" class="text-center text-gray-400 py-4">Nessun dato disponibile</td></tr>';
            }
            
            // Grafico capi per kit filtrato
            const itemCounts = {};
            filteredOrders.forEach(o => {
                o.itemsList.forEach(item => {
                    let cleanName = item.name.replace(/\s*\(\d+‚Ç¨\)\s*$/, '').trim();
                    if (!itemCounts[cleanName]) itemCounts[cleanName] = 0;
                    itemCounts[cleanName]++;
                });
            });
            
            const sortedItems = Object.entries(itemCounts).sort((a, b) => b[1] - a[1]);
            const labelsKit = sortedItems.map(x => x[0]);
            const dataKit = sortedItems.map(x => x[1]);
            
            const ctxKitItems = document.getElementById('chartKitItems');
            if (ctxKitItems) {
                if (chartKitItems) chartKitItems.destroy();
                chartKitItems = new Chart(ctxKitItems.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: labelsKit,
                        datasets: [{
                            label: 'Quantit√†',
                            data: dataKit,
                            backgroundColor: filterValue === 'all' ? '#3b82f6' : '#8b5cf6',
                            borderRadius: 4
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { x: { beginAtZero: true } },
                        plugins: { 
                            legend: { display: false },
                            title: {
                                display: true,
                                text: filterValue === 'all' ? 'Tutti i Kit' : filterValue.split('(')[0].trim(),
                                font: { size: 14, weight: 'bold' }
                            }
                        }
                    }
                });
            }
        }
        
        // Popola i filtri ID della Dashboard
        function populateDashboardIdFilters() {
            const minSelect = document.getElementById('dashboardMinId');
            const maxSelect = document.getElementById('dashboardMaxId');
            if (!minSelect || !maxSelect) return;
            if (orders.length === 0) return;
            
            // Se gi√† popolato e con lo stesso numero di ordini, non ripopolare
            const currentOptionsCount = minSelect.options.length;
            if (currentOptionsCount === orders.length && minSelect.value && maxSelect.value) {
                return; // Gi√† popolato correttamente
            }
            
            // Salva selezione corrente
            const currentMin = minSelect.value;
            const currentMax = maxSelect.value;
            
            // Ordina usando la funzione globale
            const sortedOrders = sortOrdersByDisplayId(orders, true);
            
            minSelect.innerHTML = '';
            maxSelect.innerHTML = '';
            
            sortedOrders.forEach(o => {
                const optMin = document.createElement('option');
                optMin.value = o.displayId;
                optMin.text = o.displayId;
                minSelect.appendChild(optMin);
                
                const optMax = document.createElement('option');
                optMax.value = o.displayId;
                optMax.text = o.displayId;
                maxSelect.appendChild(optMax);
            });
            
            // Ripristina selezione o imposta default
            if (currentMin && sortedOrders.some(o => o.displayId === currentMin)) {
                minSelect.value = currentMin;
            } else if (sortedOrders.length > 0) {
                minSelect.value = sortedOrders[0].displayId;
            }
            
            if (currentMax && sortedOrders.some(o => o.displayId === currentMax)) {
                maxSelect.value = currentMax;
            } else if (sortedOrders.length > 0) {
                maxSelect.value = sortedOrders[sortedOrders.length - 1].displayId;
            }
        }
        
        // Reset filtri Dashboard
        function resetDashboardFilters() {
            const sortedOrders = sortOrdersByDisplayId(orders, true);
            const minSelect = document.getElementById('dashboardMinId');
            const maxSelect = document.getElementById('dashboardMaxId');
            
            if (minSelect && sortedOrders.length > 0) {
                minSelect.value = sortedOrders[0].displayId;
            }
            if (maxSelect && sortedOrders.length > 0) {
                maxSelect.value = sortedOrders[sortedOrders.length - 1].displayId;
            }
            
            // Reset anche il filtro kit
            const kitFilter = document.getElementById('dashboardKitFilter');
            if (kitFilter) kitFilter.value = 'all';
            
            // I totali generali non cambiano, aggiorna solo la parte filtrata
            renderChart();
            renderKitAnalysis();
        }
        
        // Applica Quick ID filter anche alla Dashboard
        function applyQuickIdFilterToDashboard(num) {
            const filter = quickIdFilters[num];
            if (!filter || !filter.min || !filter.max) return;
            
            const minSelect = document.getElementById('dashboardMinId');
            const maxSelect = document.getElementById('dashboardMaxId');
            
            if (minSelect && maxSelect) {
                // Trova ID corrispondenti
                const sortedOrders = sortOrdersByDisplayId(orders, true);
                
                const findMatchingId = (inputValue) => {
                    if (inputValue.includes('_') || inputValue.includes('A_')) {
                        return inputValue;
                    }
                    const targetNum = parseInt(inputValue);
                    for (let o of sortedOrders) {
                        const parsed = parseDisplayId(o.displayId);
                        if (parsed.num === targetNum) {
                            return o.displayId;
                        }
                    }
                    return inputValue;
                };
                
                const matchedMin = findMatchingId(filter.min);
                const matchedMax = findMatchingId(filter.max);
                
                minSelect.value = matchedMin;
                maxSelect.value = matchedMax;
                
                renderChart();
                renderKitAnalysis();
            }
        }

        function initSelect() { 
            const sel = document.getElementById('addItemSelect');
            if (!sel) return; // Protezione
            sel.innerHTML = ''; 
            [...globalItems].filter(i => i && typeof i === 'string').forEach(i => { 
                const opt = document.createElement('option');
                opt.value = i; 
                // Estrai nome senza prezzo - trova l'ultima parentesi con ‚Ç¨ o ‚Ç¨)
                const priceMatch = i.match(/\s*\(\d+‚Ç¨\)\s*$/);
                opt.text = priceMatch ? i.substring(0, i.lastIndexOf(priceMatch[0])).trim() : i;
                sel.appendChild(opt); 
            }); 
            const sizeSel = document.getElementById('filterSize');
            if (sizeSel) {
                SIZE_ORDER.forEach(s => sizeSel.innerHTML += `<option value="${s}">${s}</option>`);
            }
            
            // Popola filtro articoli
            const itemSel = document.getElementById('filterItem');
            if (!itemSel) return; // Protezione
            const currentItemFilter = itemSel.value; // Preserva selezione corrente
            itemSel.innerHTML = '<option value="all">üîç Cerca Capo...</option>';
            [...globalItems].filter(item => item && typeof item === 'string').sort().forEach(item => {
                const opt = document.createElement('option');
                opt.value = item;
                // Estrai nome senza prezzo
                const priceMatch = item.match(/\s*\(\d+‚Ç¨\)\s*$/);
                opt.text = priceMatch ? item.substring(0, item.lastIndexOf(priceMatch[0])).trim() : item;
                itemSel.appendChild(opt);
            });
            if (currentItemFilter && currentItemFilter !== 'all') {
                itemSel.value = currentItemFilter; // Ripristina selezione
            }
        }
        
        function openItemModal(id) { 
            currentEditId = id;
            const o = orders.find(x => x.id === id); const tb = document.getElementById('modalItemsBody'); tb.innerHTML = '';
            document.getElementById('modalEmail').value = o.email || '';
            document.getElementById('modalPhone').value = o.phone || '';
            document.getElementById('modalTimestamp').value = o.timestamp || 'Non disponibile';
            if (o.statusUpdatedAt) {
            const formatted = new Date(o.statusUpdatedAt).toLocaleString('it-IT');
            document.getElementById('modalTimestamp').value += ` | Stato: ${formatted}`;
       }
            o.itemsList.forEach((item, idx) => { tb.innerHTML += `<tr class="border-b hover:bg-gray-50"><td class="p-2 text-xs" style="max-width: 300px; word-wrap: break-word; white-space: normal;">${item.name}</td><td class="p-2 text-center"><input type="text" value="${item.size}" onchange="updateItemSize(${idx}, this.value)" class="border rounded w-20 text-center font-bold text-sm bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-300 outline-none"></td><td class="p-2 text-center"><button onclick="delItem(${idx})" class="text-red-500 hover:text-red-700"><i class="fas fa-times"></i></button></td></tr>`; });
            document.getElementById('itemModal').classList.add('active'); 
        }
        function updateItemSize(idx, val) { const o = orders.find(x => x.id === currentEditId);
        if(o && o.itemsList[idx]) { o.itemsList[idx].size = val.toUpperCase().trim(); saveData(); renderMatrices(); } }
        function delItem(idx) { orders.find(x=>x.id===currentEditId).itemsList.splice(idx,1);
        openItemModal(currentEditId); }
        function addItemToOrder() { const val = document.getElementById('addItemSelect').value; const o = orders.find(x=>x.id===currentEditId);
        let s = o.mainSize; if(val.includes("Calzettoni") || val.includes("Calzettone")) s = o.sockSize; if(val.includes("Borsone") || val.includes("Zaino") || val.includes("Cappellino") || val.includes("Scaldacollo") || val.includes("Guanti")) s = 'UNICA';
        o.itemsList.push({name: val, size: s}); openItemModal(currentEditId); }
        function closeModal() { document.getElementById('itemModal').classList.remove('active'); updateUI(); }
        function updateUI() { 
            populateGestioneOrdiniIdSelects();
            populateDashboardIdFilters(); // Inizializza filtri Dashboard
            restoreFiltersState(); // Ripristina filtri salvati
            renderTable(); 
            updateDashboardCounts(); // Aggiorna conteggi Dashboard
            renderChart(); 
            saveData(); 
        }
        
        // Popola i select ID in Gestione Ordini
        function populateGestioneOrdiniIdSelects() {
            const filterMinId = document.getElementById('filterMinId');
            const filterMaxId = document.getElementById('filterMaxId');
            
            if (!filterMinId || !filterMaxId) return;
            
            // Salva selezioni correnti
            const currentMin = filterMinId.value;
            const currentMax = filterMaxId.value;
            
            // Ordina ordini per ID usando la funzione globale
            const sortedOrders = sortOrdersByDisplayId(orders, true);
            
            // Popola select
            filterMinId.innerHTML = '';
            filterMaxId.innerHTML = '';
            
            sortedOrders.forEach(o => {
                const optMin = document.createElement('option');
                optMin.value = o.displayId;
                optMin.text = o.displayId;
                filterMinId.appendChild(optMin);
                
                const optMax = document.createElement('option');
                optMax.value = o.displayId;
                optMax.text = o.displayId;
                filterMaxId.appendChild(optMax);
            });
            
            // Ripristina selezioni o imposta default
            if (currentMin && currentMax) {
                filterMinId.value = currentMin;
                filterMaxId.value = currentMax;
            } else if (sortedOrders.length > 0) {
                filterMinId.value = sortedOrders[0].displayId;
                filterMaxId.value = sortedOrders[sortedOrders.length - 1].displayId;
            }
        }
        
        // Gestione popup note
        let currentNoteOrderId = null;
        let currentNoteColor = 'default';
        
        function openNotesPopup(orderId) {
            currentNoteOrderId = orderId;
            const order = orders.find(o => o.id === orderId);
            
            if (order) {
                document.getElementById('noteTextarea').value = order.notes || '';
                currentNoteColor = order.noteColor || 'default';
                
                // Evidenzia il colore selezionato
                document.querySelectorAll('.note-color-btn').forEach(btn => {
                    btn.classList.remove('selected');
                    if (btn.dataset.color === currentNoteColor) {
                        btn.classList.add('selected');
                    }
                });
                
                document.getElementById('notesPopup').classList.add('active');
            }
        }
        
        function closeNotesPopup() {
            document.getElementById('notesPopup').classList.remove('active');
            currentNoteOrderId = null;
            currentNoteColor = 'default';
        }
        
        function selectNoteColor(color) {
            currentNoteColor = color;
            document.querySelectorAll('.note-color-btn').forEach(btn => {
                btn.classList.remove('selected');
                if (btn.dataset.color === color) {
                    btn.classList.add('selected');
                }
            });
        }
        
        function saveNoteFromPopup() {
            if (currentNoteOrderId) {
                const order = orders.find(o => o.id === currentNoteOrderId);
                if (order) {
                    order.notes = document.getElementById('noteTextarea').value;
                    order.noteColor = currentNoteColor;
                    saveData();
                    renderTable();
                    closeNotesPopup();
                }
            }
        }
        
        // Funzione per aprire tabelle a schermo intero in nuova finestra
        function openTableFullscreen(tableType) {
            const minSel = document.getElementById('matrixMinId');
            const maxSel = document.getElementById('matrixMaxId');
            const range = (minSel && maxSel && minSel.value && maxSel.value) 
                ? `${minSel.value} ‚Üí ${maxSel.value}` 
                : 'Tutti';
            
            let title, tableId, titleColor, borderColor;
            
            switch(tableType) {
                case 'gross':
                    title = '1. Riepilogo Richieste Totali (Lordo)';
                    tableId = 'grossTable';
                    titleColor = '#1e3a8a';
                    borderColor = '#3b82f6';
                    break;
                case 'inv':
                    title = '2. Magazzino (Giacenze)';
                    tableId = 'invClothingTable';
                    titleColor = '#92400e';
                    borderColor = '#fbbf24';
                    break;
                case 'net':
                    title = '3. Ordine Fornitore (Netto)';
                    tableId = 'netTable';
                    titleColor = '#991b1b';
                    borderColor = '#dc2626';
                    break;
                case 'invSocks':
                    title = 'Inventario Calze';
                    tableId = 'invSocksTable';
                    titleColor = '#92400e';
                    borderColor = '#fbbf24';
                    break;
                case 'netSocks':
                    title = 'Calze da Ordinare (Netto)';
                    tableId = 'netSocksTable';
                    titleColor = '#991b1b';
                    borderColor = '#dc2626';
                    break;
            }
            
            const table = document.getElementById(tableId);
            if (!table) {
                alert('Tabella non trovata!');
                return;
            }
            
            // Clona la tabella
            const clonedTable = table.cloneNode(true);
            
            // Crea HTML per la nuova finestra - FINESTRA MASSIMA
            const newWindow = window.open('', '_blank', 'width=1800,height=950');
            newWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>${title} - OrderFlow Pro</title>
                    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
                    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
                    <style>
                        * {
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                        }
                        body {
                            font-family: Arial, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                            padding: 1px;
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            margin: 0;
                            overflow: hidden;
                            height: 100vh;
                            width: 100vw;
                        }
                        .container {
                            background: white;
                            border-radius: 2px;
                            padding: 3px;
                            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                            width: calc(100vw - 2px);
                            height: calc(100vh - 2px);
                            display: flex;
                            flex-direction: column;
                            overflow: hidden;
                        }
                        .header {
                            border-bottom: 1px solid ${borderColor};
                            padding-bottom: 1px;
                            margin-bottom: 1px;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            flex-shrink: 0;
                            height: 30px;
                            max-height: 30px;
                        }
                        .header h1 {
                            color: ${titleColor};
                            font-size: 14px;
                            font-weight: bold;
                            margin: 0;
                            line-height: 1;
                        }
                        .header .info {
                            color: #666;
                            font-size: 10px;
                            font-weight: 500;
                            line-height: 1;
                        }
                        .table-wrapper {
                            overflow: auto;
                            flex-grow: 1;
                            width: 100%;
                            height: 100%;
                        }
                        table {
                            width: 100% !important;
                            min-width: 100% !important;
                            max-width: 100% !important;
                            border-collapse: collapse;
                            margin: 0;
                            table-layout: fixed !important;
                            height: 100%;
                        }
                        th {
                            background: #f3f4f6 !important;
                            padding: 0px !important;
                            text-align: center !important;
                            font-weight: bold !important;
                            border: 1px solid #d1d5db !important;
                            font-size: 8px !important;
                            width: auto !important;
                            overflow: hidden !important;
                            vertical-align: middle !important;
                        }
                        td {
                            padding: 0px !important;
                            text-align: center !important;
                            border: 1px solid #e5e7eb !important;
                            font-size: 17px !important;
                            font-weight: 600 !important;
                            width: auto !important;
                            overflow: hidden !important;
                            line-height: 0.9 !important;
                            height: auto !important;
                            max-height: none !important;
                        }
                        td.sticky-col {
                            padding: 0px !important;
                            height: auto !important;
                            max-height: none !important;
                            line-height: 0.9 !important;
                        }
                        .sticky-col {
                            background: #f9fafb !important;
                            font-weight: bold !important;
                            text-align: center !important;
                            position: sticky !important;
                            left: 0 !important;
                            z-index: 10 !important;
                            width: 55px !important;
                            min-width: 55px !important;
                            max-width: 55px !important;
                            box-shadow: 2px 0 5px rgba(0,0,0,0.1) !important;
                            padding: 0px !important;
                            font-size: 13px !important;
                            vertical-align: middle !important;
                            display: table-cell !important;
                            line-height: 0.9 !important;
                            height: auto !important;
                        }
                        tbody .sticky-col {
                            padding: 0px !important;
                            line-height: 0.9 !important;
                        }
                        .size-section-row {
                            padding: 0px !important;
                            line-height: 0.9 !important;
                            font-size: 13px !important;
                            height: auto !important;
                        }
                        tbody .size-section-row {
                            padding: 0px !important;
                            line-height: 0.9 !important;
                            height: auto !important;
                        }
                        .total-row {
                            background: #f3f4f6 !important;
                            font-weight: bold !important;
                            border-top: 2px solid #9ca3af !important;
                        }
                        .vertical-header {
                            writing-mode: vertical-rl !important;
                            transform: rotate(180deg) !important;
                            white-space: pre-wrap !important;
                            padding: 0px !important;
                            font-size: 13px !important;
                            line-height: 1.1 !important;
                            height: 110px !important;
                            display: flex !important;
                            align-items: center !important;
                            justify-content: center !important;
                            text-align: center !important;
                            font-weight: 700 !important;
                            max-height: 110px !important;
                            overflow: hidden !important;
                        }
                        .buy-alert {
                            background: #fee2e2 !important;
                            color: #991b1b !important;
                            padding: 2px 4px !important;
                            border-radius: 3px !important;
                            font-weight: bold !important;
                            font-size: 17px !important;
                        }
                        .buy-ok {
                            color: #9ca3af !important;
                        }
                        .size-section-row {
                            padding: 1px 0 !important;
                            line-height: 0.9 !important;
                            font-size: 11px !important;
                        }
                        .inv-input {
                            width: 50px !important;
                            text-align: center !important;
                            border: 1px solid #d1d5db !important;
                            border-radius: 3px !important;
                            padding: 2px !important;
                            font-size: 17px !important;
                            font-weight: 600 !important;
                        }
                        .no-print {
                            margin-top: 2px;
                            padding: 3px;
                            text-align: center;
                            flex-shrink: 0;
                            background: #f9fafb;
                            border-top: 1px solid #e5e7eb;
                        }
                        .no-print button {
                            background: #3b82f6;
                            color: white;
                            padding: 4px 12px;
                            border: none;
                            border-radius: 4px;
                            cursor: pointer;
                            font-weight: bold;
                            margin: 0 2px;
                            font-size: 10px;
                        }
                        .no-print button:hover {
                            background: #2563eb;
                        }
                        @media print {
                            * {
                                margin: 0 !important;
                                padding: 0 !important;
                            }
                            body {
                                background: white;
                                margin: 0;
                                padding: 0;
                            }
                            .no-print {
                                display: none;
                            }
                            .container {
                                box-shadow: none;
                                padding: 0mm !important;
                                overflow: visible;
                                border-radius: 0;
                                width: 100%;
                                height: 100%;
                            }
                            .table-wrapper {
                                overflow: visible;
                                width: 100%;
                                height: 100%;
                            }
                            @page {
                                size: A4 landscape;
                                margin: 1mm;
                            }
                            table {
                                font-size: 7px !important;
                                width: 100% !important;
                                max-width: 100% !important;
                                min-width: 100% !important;
                                table-layout: fixed !important;
                                border-collapse: collapse !important;
                                height: auto !important;
                            }
                            th {
                                padding: 1px 0.5px !important;
                                width: auto !important;
                                font-size: 6px !important;
                                word-wrap: break-word;
                                overflow: hidden;
                                line-height: 0.9;
                                border: 0.5px solid #d1d5db !important;
                                height: auto !important;
                            }
                            td {
                                padding: 0.5px 0.5px !important;
                                width: auto !important;
                                font-size: 7px !important;
                                word-wrap: break-word;
                                overflow: hidden;
                                line-height: 0.85;
                                border: 0.5px solid #e5e7eb !important;
                                font-weight: 600 !important;
                                height: auto !important;
                            }
                            .sticky-col {
                                position: relative !important;
                                box-shadow: none !important;
                                width: 22px !important;
                                min-width: 22px !important;
                                max-width: 22px !important;
                                padding: 0.5px 0.5px !important;
                                font-size: 6px !important;
                            }
                            .size-section-row {
                                padding: 0.5px 0.5px !important;
                                line-height: 0.85 !important;
                                font-size: 6px !important;
                                height: auto !important;
                            }
                            .vertical-header {
                                font-size: 5px !important;
                                padding: 1px 0 !important;
                                height: 60px !important;
                                line-height: 0.95 !important;
                                font-weight: 700 !important;
                            }
                            .header {
                                padding-bottom: 0.5mm !important;
                                margin-bottom: 0.5mm !important;
                                border-bottom-width: 0.5px !important;
                                height: 15px !important;
                                max-height: 15px !important;
                            }
                            .header h1 {
                                font-size: 7px !important;
                                line-height: 1 !important;
                            }
                            .header .info {
                                font-size: 5px !important;
                                line-height: 1 !important;
                            }
                            .header img {
                                display: none !important;
                            }
                            .container {
                                page-break-inside: avoid;
                            }
                            .buy-alert {
                                padding: 1px !important;
                                font-size: 6.5px !important;
                            }
                            .size-section-row {
                                padding: 0.5px 0 !important;
                                line-height: 0.8 !important;
                                font-size: 5px !important;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <div class="header">
                            <div>
                                <h1><i class="fas fa-table mr-2"></i>${title}</h1>
                                <div class="info">
                                    <i class="fas fa-calendar-alt mr-1"></i> ${new Date().toLocaleDateString('it-IT')} 
                                    <i class="fas fa-clock ml-3 mr-1"></i> ${new Date().toLocaleTimeString('it-IT')}
                                    <span class="ml-3"><i class="fas fa-filter mr-1"></i> Range: ${range}</span>
                                </div>
                            </div>
                            <img src="https://via.placeholder.com/100x50/667eea/ffffff?text=Logo" alt="Logo" style="height: 50px;">
                        </div>
                        <div class="table-wrapper">
                            ${clonedTable.outerHTML}
                        </div>
                        <div class="no-print">
                            <button onclick="window.print()"><i class="fas fa-print mr-2"></i>Stampa</button>
                            <button onclick="window.close()"><i class="fas fa-times mr-2"></i>Chiudi</button>
                        </div>
                    </div>
                </body>
                </html>
            `);
            newWindow.document.close();
        }
        
        // Funzione per scalare magazzino dagli ordini
        function applyInventoryToOrders() {
            const minIdSel = document.getElementById('matrixMinId');
            const maxIdSel = document.getElementById('matrixMaxId');
            
            if (!minIdSel || !maxIdSel || !minIdSel.value || !maxIdSel.value) {
                alert('‚ö†Ô∏è Seleziona prima un range ID da filtrare!');
                return;
            }
            
            const confirmMsg = `üîÑ SCALA MAGAZZINO\n\n` +
                `Questa operazione:\n` +
                `1. Scala il magazzino per gli ordini "Nuovo" nel range ${minIdSel.value} ‚Üí ${maxIdSel.value}\n` +
                `2. Aggiunge una nota automatica con timestamp agli ordini scalati\n` +
                `3. Mantiene lo stato "Nuovo" (lo cambierai manualmente quando inviato)\n\n` +
                `‚ö†Ô∏è ATTENZIONE: Il magazzino verr√† decrementato!\n\n` +
                `Continuare?`;
            
            if (!confirm(confirmMsg)) return;
            
            // Filtra solo ordini "Nuovo" NON ANCORA SCALATI nel range
            const NET_STATUSES = ['Nuovo'];
            const ordersToProcess = orders.filter(o => {
                return NET_STATUSES.includes(o.status) && 
                       o.status !== 'Ordine trasferito ad altro ID' &&
                       !o.inventoryScaledAt && // IMPORTANTE: Non scalare ordini gi√† scalati!
                       compareDisplayIds(o.displayId, minIdSel.value) >= 0 &&
                       compareDisplayIds(o.displayId, maxIdSel.value) <= 0;
            });
            
            if (ordersToProcess.length === 0) {
                alert('‚ùå Nessun ordine "Nuovo" non ancora scalato trovato nel range selezionato!\n\nGli ordini con badge üì¶ SCALATO sono gi√† stati processati.');
                return;
            }
            
            console.log(`üîÑ Ordini da scalare: ${ordersToProcess.length}`);
            console.log(`   IDs:`, ordersToProcess.map(o => o.displayId));
            console.log(`   Totale ordini Nuovo nel range:`, orders.filter(o => {
                return o.status === 'Nuovo' && 
                       compareDisplayIds(o.displayId, minIdSel.value) >= 0 &&
                       compareDisplayIds(o.displayId, maxIdSel.value) <= 0;
            }).length);
            console.log(`   Di cui gi√† scalati:`, orders.filter(o => {
                return o.status === 'Nuovo' && 
                       compareDisplayIds(o.displayId, minIdSel.value) >= 0 &&
                       compareDisplayIds(o.displayId, maxIdSel.value) <= 0 && 
                       o.inventoryScaledAt;
            }).length);
            
            let scaledOrders = 0;
            let totalItemsScaled = 0;
            const timestamp = new Date().toLocaleString('it-IT');
            const inventoryLog = {};
            
            // Per ogni ordine, scala il magazzino
            ordersToProcess.forEach(order => {
                let itemsScaledThisOrder = [];
                
                // Inizializza scaledItems se non esiste
                if (!order.scaledItems) {
                    order.scaledItems = {};
                }
                
                console.log(`\nüîÑ Scalamento ordine ${order.displayId}:`);
                
                order.itemsList.forEach(item => {
                    const key = `${item.name}_${item.size}`;
                    const stockVal = inventory[key];
                    const stockInt = parseInt(stockVal) || 0;
                    
                    console.log(`   üì¶ ${item.name} [${item.size}]: Magazzino prima=${stockInt}`);
                    
                    if (stockVal && stockInt > 0) {
                        // C'√® stock disponibile, scala
                        inventory[key] = stockInt - 1;
                        itemsScaledThisOrder.push(`${item.name.split('(')[0].trim()} [${item.size}]`);
                        totalItemsScaled++;
                        
                        // Traccia quanti articoli di questo tipo sono stati scalati per questo ordine
                        if (!order.scaledItems[key]) {
                            order.scaledItems[key] = 0;
                        }
                        order.scaledItems[key] += 1;
                        
                        console.log(`   ‚úÖ Scalato! Magazzino dopo=${stockInt - 1}, scaledItems[${key}]=${order.scaledItems[key]}`);
                        
                        // Log per riepilogo
                        if (!inventoryLog[key]) {
                            inventoryLog[key] = { name: item.name, size: item.size, count: 0 };
                        }
                        inventoryLog[key].count++;
                    } else {
                        console.log(`   ‚ö†Ô∏è Magazzino=0, non scalato`);
                    }
                });
                
                if (itemsScaledThisOrder.length > 0) {
                    // Aggiungi nota automatica
                    const noteText = `üì¶ Scalato da magazzino il ${timestamp}\n${itemsScaledThisOrder.join(', ')}`;
                    order.notes = order.notes ? `${order.notes}\n\n${noteText}` : noteText;
                    order.noteColor = 'green'; // Verde = Scalato
                    order.inventoryScaledAt = timestamp;
                    scaledOrders++;
                }
            });
            
            saveData();
            renderMatrices(true);
            renderTable();
            
            // Mostra riepilogo
            let summary = `‚úÖ MAGAZZINO SCALATO CON SUCCESSO!\n\n`;
            summary += `üìä Ordini processati: ${scaledOrders}\n`;
            summary += `üì¶ Articoli totali scalati: ${totalItemsScaled}\n\n`;
            summary += `üîç Dettaglio:\n`;
            
            Object.values(inventoryLog).forEach(item => {
                summary += `‚Ä¢ ${item.name.split('(')[0].trim()} [${item.size}]: -${item.count}\n`;
            });
            
            alert(summary);
        }
        
        function exportMatrix() { 
            const wb = XLSX.utils.book_new();
            const now = new Date().toLocaleString('it-IT');
            const minId = document.getElementById('matrixMinId').value; 
            const maxId = document.getElementById('matrixMaxId').value; 
            const rangeTxt = (minId && maxId) ? `Intervallo ID: ${minId} - ${maxId}` : 'Intervallo ID: Tutti';
            
            // DB completo (tutti gli ordini) - con info trasferimenti
            const rawData = orders.map(o => {
                const linkedFrom = orders.find(x => x.linkedId === o.displayId);
                return {
                    'Data Export': now, 
                    ID: o.displayId, 
                    Cliente: o.customer, 
                    Kit: o.kitType, 
                    Taglia: o.mainSize, 
                    Calze: o.sockSize, 
                    Totale: calculateOrderTotal(o), 
                    Sconto: o.discount, 
                    Stato: o.status, 
                    'Trasferito A': o.linkedId || '',
                    'Ricevuto Da': linkedFrom ? linkedFrom.displayId : '',
                    Note: o.notes
                };
            });
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(rawData), "DB_Ordini_Completo");
            
            // Filtra ordini nel range ID selezionato (TUTTI gli stati)
            let activeOrders = orders;
            if (minId && maxId) {
                activeOrders = orders.filter(o => {
                    return compareDisplayIds(o.displayId, minId) >= 0 && 
                           compareDisplayIds(o.displayId, maxId) <= 0;
                });
            }
            
            // Riassunto Griglia (tutti gli ordini nel range) - con info trasferimenti
            const gridRows = activeOrders.map(o => { 
                const linkedFrom = orders.find(x => x.linkedId === o.displayId);
                const row = {};
                row["ID Ordine"] = o.displayId; 
                row["Cliente"] = o.customer;
                row["Stato"] = o.status;
                row["Trasferito A"] = o.linkedId || '';
                row["Ricevuto Da"] = linkedFrom ? linkedFrom.displayId : '';
                row["Note"] = o.notes || ""; 
                globalItems.forEach(item => { 
                    const found = o.itemsList.find(i => i.name === item); 
                    row[item] = found ? found.size : ""; 
                }); 
                return row; 
            });
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(gridRows), "Riassunto_Griglia");
            
            // Dettaglio Fabbisogni (tutti gli ordini nel range)
            const detectiveData = []; globalItems.forEach(itemName => { let sizesSet = new Set(); activeOrders.forEach(o => { o.itemsList.forEach(i => { if (i.name === itemName) sizesSet.add(i.size); }); }); Array.from(sizesSet).sort().forEach(size => { let requestingIDs = []; let count = 0; activeOrders.forEach(o => { o.itemsList.forEach(i => { if (i.name === itemName && i.size === size) { requestingIDs.push(o.displayId); count++; } }); }); if (count > 0) { detectiveData.push({ 'Articolo': itemName, 'Taglia': size, 'Quantit√†': count, 'ID Ordini': requestingIDs.join(', ') }); } }); });
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(detectiveData), "Dettaglio_Fabbisogni");
            
            function addSheetWithInfo(tableId, sheetName) { const table = document.getElementById(tableId);
            const aoa = [["Riepilogo Ordine Fornitore"], ["Generato il: " + now], [rangeTxt], [""]]; const finalSheet = XLSX.utils.aoa_to_sheet(aoa);
            XLSX.utils.sheet_add_dom(finalSheet, table, {origin: "A5"}); XLSX.utils.book_append_sheet(wb, finalSheet, sheetName); }
            
            XLSX.utils.book_append_sheet(wb, XLSX.utils.table_to_sheet(document.getElementById('grossTable')), "Riepilogo_Lordo");
            
            // Crea manualmente la tabella Magazzino con i valori degli input
            const SOCK_SIZES = ["23/26", "27/30", "31/34", "35/38", "39/42", "43/46"];
            const inventorySizes = SIZE_ORDER.filter(s => !SOCK_SIZES.includes(s));
            inventorySizes.push('UNICA');
            
            const inventoryData = [];
            const itemsWithoutSocks = globalItems.filter(item => !item.includes("Calzettoni"));
            
            inventorySizes.forEach(size => {
                const row = { 'TAGLIA': size };
                let rowTotal = 0;
                itemsWithoutSocks.forEach(item => {
                    const key = `${item}_${size}`;
                    const value = inventory[key] !== undefined ? inventory[key] : '';
                    row[item] = value;
                    if (value !== '') rowTotal += parseInt(value) || 0;
                });
                inventoryData.push(row);
            });
            
            // Aggiungi riga TOTALE
            const totalRow = { 'TAGLIA': 'TOTALE' };
            itemsWithoutSocks.forEach(item => {
                let total = 0;
                inventorySizes.forEach(size => {
                    const key = `${item}_${size}`;
                    const value = inventory[key];
                    if (value !== undefined && value !== '') {
                        total += parseInt(value) || 0;
                    }
                });
                totalRow[item] = total;
            });
            inventoryData.push(totalRow);
            
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(inventoryData), "Magazzino");
            
            // Crea manualmente la tabella Calze Inventario
            const sockSizes = ["23/26", "27/30", "31/34", "35/38", "39/42", "43/46"];
            const socksInventoryData = [];
            
            sockSizes.forEach(size => {
                const blueKey = `${SOCKS_BLUE_DEFAULT}_${size}`;
                const redKey = `${SOCKS_RED_DEFAULT}_${size}`;
                const blueVal = inventory[blueKey] !== undefined ? inventory[blueKey] : '';
                const redVal = inventory[redKey] !== undefined ? inventory[redKey] : '';
                
                socksInventoryData.push({
                    'TAGLIA': size,
                    [SOCKS_BLUE_DEFAULT]: blueVal,
                    [SOCKS_RED_DEFAULT]: redVal
                });
            });
            
            // Aggiungi riga TOTALE calze
            let blueTot = 0, redTot = 0;
            sockSizes.forEach(size => {
                const blueKey = `${SOCKS_BLUE_DEFAULT}_${size}`;
                const redKey = `${SOCKS_RED_DEFAULT}_${size}`;
                if (inventory[blueKey]) blueTot += parseInt(inventory[blueKey]) || 0;
                if (inventory[redKey]) redTot += parseInt(inventory[redKey]) || 0;
            });
            socksInventoryData.push({
                'TAGLIA': 'TOTALE',
                [SOCKS_BLUE_DEFAULT]: blueTot,
                [SOCKS_RED_DEFAULT]: redTot
            });
            
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(socksInventoryData), "Inv_Calze");
            
            addSheetWithInfo('netTable', "Ordine_Netto"); 
            addSheetWithInfo('netSocksTable', "Netto_Calze");
            
            XLSX.writeFile(wb, "OrderFlow_Export_" + now.replace(/[: ]/g, '_') + ".xlsx");
        }

        function exportTabellaOrdiniToExcel() {
            const wb = XLSX.utils.book_new();
            const now = new Date().toLocaleString('it-IT');
            
            // Prendi i filtri applicati
            const minId = document.getElementById('tabellaOrdiniMinId')?.value;
            const maxId = document.getElementById('tabellaOrdiniMaxId')?.value;
            const filterCliente = document.getElementById('tabellaOrdiniFilterCliente')?.value.toLowerCase().trim() || '';
            const filterTaglia = document.getElementById('tabellaOrdiniFilterTaglia')?.value || '';
            
            const getNum = (id) => { const m = id.match(/(\d+)$/); return m ? parseInt(m[1]) : 0; };
            const minNum = getNum(minId);
            const maxNum = getNum(maxId);
            
            // Filtra ordini come nella tabella visualizzata
            let filteredOrders = orders.filter(o => {
                // Usa confronto completo per il filtro
                if (minId && compareDisplayIds(o.displayId, minId) < 0) return false;
                if (maxId && compareDisplayIds(o.displayId, maxId) > 0) return false;
                if (filterCliente && !o.customer.toLowerCase().includes(filterCliente)) return false;
                if (filterTaglia && o.mainSize !== filterTaglia) return false;
                return true;
            });
            
            // Ordina usando la funzione globale
            filteredOrders = sortOrdersByDisplayId(filteredOrders, true);
            
            // Raccogli tutti gli articoli presenti negli ordini filtrati
            const allItemsMap = new Map();
            filteredOrders.forEach(order => {
                order.itemsList.forEach(item => {
                    if (!item || !item.name || typeof item.name !== 'string') return;
                    const priceMatch = item.name.match(/\s*\(\d+‚Ç¨\)\s*$/);
                    const itemName = priceMatch ? item.name.substring(0, item.name.lastIndexOf(priceMatch[0])).trim() : item.name;
                    if (!allItemsMap.has(itemName)) {
                        allItemsMap.set(itemName, itemName);
                    }
                });
            });
            
            const allItems = Array.from(allItemsMap.values());
            
            // Crea i dati per Excel
            const excelData = [];
            
            filteredOrders.forEach(order => {
                const row = {
                    'ID Ordine': order.displayId,
                    'Cliente': order.customer,
                    'Taglia': order.mainSize,
                    'Taglia Calzettoni': order.sockSize || '-',
                    'Taglia Accessori': order.accessorySize || 'UNICA',
                    'Ordine Da Effettuare': order.kitType || '-',
                    'Note': order.notes || '-'
                };
                
                // Borsone/Zaino
                const borsoneZaino = order.itemsList.find(i => i.name.includes('Borsone')) ? 'Borsone' : 
                                    order.itemsList.find(i => i.name.includes('Zaino')) ? 'Zaino' : '-';
                row['Borsone/Zaino'] = borsoneZaino;
                
                // Aggiungi colonna per ogni articolo
                allItems.forEach(itemName => {
                    const found = order.itemsList.find(i => {
                        const priceMatch = i.name.match(/\s*\(\d+‚Ç¨\)\s*$/);
                        const cleanName = priceMatch ? i.name.substring(0, i.name.lastIndexOf(priceMatch[0])).trim() : i.name;
                        return cleanName === itemName;
                    });
                    row[itemName] = found ? found.size : '';
                });
                
                excelData.push(row);
            });
            
            // Aggiungi riga TOTALE
            const totalRow = {
                'ID Ordine': 'TOTALE',
                'Cliente': '',
                'Taglia': '',
                'Taglia Calzettoni': '',
                'Taglia Accessori': '',
                'Ordine Da Effettuare': '',
                'Note': '',
                'Borsone/Zaino': ''
            };
            
            allItems.forEach(itemName => {
                const total = filteredOrders.reduce((sum, order) => {
                    const found = order.itemsList.find(i => {
                        const priceMatch = i.name.match(/\s*\(\d+‚Ç¨\)\s*$/);
                        const cleanName = priceMatch ? i.name.substring(0, i.name.lastIndexOf(priceMatch[0])).trim() : i.name;
                        return cleanName === itemName;
                    });
                    return sum + (found ? 1 : 0);
                }, 0);
                totalRow[itemName] = total;
            });
            
            excelData.push(totalRow);
            
            // Crea foglio Excel
            const ws = XLSX.utils.json_to_sheet(excelData);
            XLSX.utils.book_append_sheet(wb, ws, "Tabella_Ordini");
            
            // Salva file
            const fileName = `Tabella_Ordini_${minId || 'Tutti'}_${maxId || 'Tutti'}_${now.replace(/[: ]/g, '_')}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            alert(`‚úÖ Excel esportato!\n\nüìä Ordini esportati: ${filteredOrders.length}\nüìÅ File: ${fileName}`);
        }

        function exportBackup() {
            const wb = XLSX.utils.book_new();
            
            // Foglio 1: Ordini
            const data = orders.map(o => {
                const row = {
                    "ID": o.displayId,
                    "Timestamp Ordine": o.timestamp || "",
                    "Cliente": o.customer,
                    "Anno/Ruolo": o.roleOrYear || "",
                    "Email": o.email || "",
                    "Telefono": o.phone || "",
                    "Kit": o.kitType,
                    "Taglia": o.mainSize,
                    "Calze": o.sockSize,
                    "Note": o.notes,
                    "Colore Nota": o.noteColor || "default",
                    "Scalato Magazzino": o.inventoryScaledAt || "",
                    "Stato": o.status, 
                    "Sconto": o.discount || 0,
                    "ID Trasferito A": o.linkedId || "",
                    "Dettaglio Articoli (Nome [Taglia])": o.itemsList.map(i => `${i.name} [${i.size}]`).join(' || ')
                };
                return row;
            });
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), "Backup_Ordini");
            
            // Foglio 2: Magazzino
            const inventoryData = [];
            Object.keys(inventory).forEach(key => {
                const [itemName, size] = key.split('_');
                const quantity = inventory[key];
                inventoryData.push({
                    "Articolo": itemName,
                    "Taglia": size,
                    "Quantit√†": quantity
                });
            });
            
            if (inventoryData.length > 0) {
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(inventoryData), "Backup_Magazzino");
            }
            
            XLSX.writeFile(wb, "OrderFlow_BACKUP_" + new Date().toISOString().slice(0,10) + ".xlsx");
        }

        // ===== INIZIALIZZAZIONE =====
        
        // Dichiarazione variabili globali
        let currentUser = null;
        
        // IMPORTANTE: Check login first, then load data - DOPO che il DOM √® pronto
        document.addEventListener('DOMContentLoaded', () => {
            // Inizializza utenti di default
            initializeDefaultUsers();
            
            // Setup event listeners per login
            const loginButton = document.getElementById('loginButton');
            const loginPassword = document.getElementById('loginPassword');
            
            if (loginButton) {
                loginButton.innerHTML = '<i class="fas fa-sign-in-alt mr-2"></i>Accedi';
                loginButton.addEventListener('click', performLogin);
            }
            
            if (loginPassword) {
                loginPassword.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') performLogin();
                });
            }
            
            // Auto-login se sessione attiva
            const savedUser = localStorage.getItem('orderFlowCurrentUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    const loginScreen = document.getElementById('loginScreen');
                    const appContainer = document.getElementById('appContainer');
                    
                    if (loginScreen) loginScreen.style.display = 'none';
                    if (appContainer) appContainer.style.display = 'block';
                    
                    // Load data then initialize UI
                    loadData().then(() => {
                        initSelect();
                        resetFiltersToDefault();
                        updateUI();
                        applyUserPermissions();
                        startClock();
                        startAutoRefresh(); // Avvia auto-refresh anche per auto-login
                    });
                } catch (error) {
                    console.error('Error loading user:', error);
                    localStorage.removeItem('orderFlowCurrentUser');
                    const loginScreen = document.getElementById('loginScreen');
                    if (loginScreen) loginScreen.style.display = 'flex';
                }
            } else {
                const loginScreen = document.getElementById('loginScreen');
                if (loginScreen) loginScreen.style.display = 'flex';
                startClock();
            }
        });
        
        // ===== SISTEMA GESTIONE UTENTI E PERMESSI =====
        
        // Definizione ruoli
        const USER_ROLES = {
            ADMIN: {
                id: 'admin',
                name: 'Amministratore',
                permissions: {
                    viewAll: true,
                    viewDashboard: true,
                    createOrders: true,
                    editOrders: true,
                    deleteOrders: true,
                    importGoogle: true,
                    importExcel: true,
                    exportBackup: true,
                    resetData: true,
                    manageUsers: true,
                    viewDistinta: true,
                    viewTabella: true,
                    useQuickIdFilters: true,
                    downloadGoogleForm: true
                }
            },
            VIEWER: {
                id: 'viewer',
                name: 'Visualizzazione (senza Dashboard)',
                permissions: {
                    viewAll: true,
                    viewDashboard: false,
                    createOrders: false,
                    editOrders: false,
                    deleteOrders: false,
                    importGoogle: false,
                    importExcel: false,
                    exportBackup: false,
                    resetData: false,
                    manageUsers: false,
                    viewDistinta: true,
                    viewTabella: true
                }
            },
            VIEWER_FULL: {
                id: 'viewer_full',
                name: 'Visualizzazione (con Dashboard)',
                permissions: {
                    viewAll: true,
                    viewDashboard: true,
                    createOrders: false,
                    editOrders: false,
                    deleteOrders: false,
                    importGoogle: false,
                    importExcel: false,
                    exportBackup: false,
                    resetData: false,
                    manageUsers: false,
                    viewDistinta: true,
                    viewTabella: true
                }
            },
            CONTRIBUTOR: {
                id: 'contributor',
                name: 'Contributore (solo Google Form)',
                permissions: {
                    viewAll: true,
                    viewDashboard: false,
                    createOrders: false,
                    editOrders: false,
                    deleteOrders: false,
                    importGoogle: false,
                    importExcel: false,
                    exportBackup: false,
                    resetData: false,
                    manageUsers: false,
                    viewDistinta: true,
                    viewTabella: true,
                    downloadGoogleForm: true,
                    editStatus: false
                }
            },
            CONTRIBUTOR_ADVANCED: {
                id: 'contributor_advanced',
                name: 'Contributore Avanzato (Google Form + Stato)',
                permissions: {
                    viewAll: true,
                    viewDashboard: false,
                    createOrders: false,
                    editOrders: false,
                    deleteOrders: false,
                    importGoogle: false,
                    importExcel: false,
                    exportBackup: false,
                    resetData: false,
                    manageUsers: false,
                    viewDistinta: true,
                    viewTabella: true,
                    downloadGoogleForm: true,
                    editStatus: true // Pu√≤ modificare SOLO lo stato
                }
            },
            TABLE_EDITOR: {
                id: 'table_editor',
                name: 'Editor Tabella (solo Tabella Ordini)',
                permissions: {
                    viewAll: false, // Non vede Gestione Ordini
                    viewDashboard: false,
                    createOrders: false,
                    editOrders: false,
                    deleteOrders: false,
                    importGoogle: false,
                    importExcel: false,
                    exportBackup: true, // Pu√≤ esportare Excel dalla tabella
                    resetData: false,
                    manageUsers: false,
                    viewDistinta: false, // Non vede Distinta
                    viewTabella: true, // SOLO Tabella
                    editTabella: true, // Permesso speciale per modificare celle tabella
                    useQuickIdFilters: true // Pu√≤ usare Quick ID filters
                }
            },
            TABELLA_FULL: {
                id: 'tabella_full',
                name: 'Tabella Completa',
                permissions: {
                    viewAll: false, // Non vede Gestione Ordini
                    viewDashboard: false,
                    createOrders: false,
                    editOrders: false,
                    deleteOrders: false,
                    importGoogle: false,
                    importExcel: false,
                    exportBackup: true, // Pu√≤ esportare Excel
                    resetData: false,
                    manageUsers: false,
                    viewDistinta: false, // Non vede Distinta
                    viewTabella: true, // Vede Tabella Ordini
                    editTabella: true, // Pu√≤ modificare celle
                    highlightCells: true, // Pu√≤ evidenziare celle
                    downloadGoogleForm: true, // Pu√≤ scaricare Google Form
                    useQuickIdFilters: true // Pu√≤ usare Quick ID filters
                }
            },
            TABELLA_READONLY: {
                id: 'tabella_readonly',
                name: 'Tabella Solo Lettura',
                permissions: {
                    viewAll: false, // Non vede Gestione Ordini
                    viewDashboard: false,
                    createOrders: false,
                    editOrders: false,
                    deleteOrders: false,
                    importGoogle: false,
                    importExcel: false,
                    exportBackup: true, // Pu√≤ esportare Excel
                    resetData: false,
                    manageUsers: false,
                    viewDistinta: false, // Non vede Distinta
                    viewTabella: true, // Vede Tabella Ordini
                    editTabella: true, // Pu√≤ modificare celle
                    highlightCells: true, // Pu√≤ evidenziare celle
                    downloadGoogleForm: false // NON pu√≤ scaricare Google Form
                }
            }
        };
        
        // Inizializza utente admin di default
        async function initializeDefaultUsers() {
            try {
                const response = await fetch('/api/users');
                
                // Verifica che la risposta sia OK prima di parsare JSON
                if (!response.ok) {
                    console.warn('‚ö†Ô∏è API users non disponibile, skip inizializzazione');
                    return;
                }
                
                const data = await response.json();
                const users = data.users || [];
                
                console.log('üîç Utenti esistenti:', users.length);
                
                if (users.length === 0) {
                    // Crea admin di default
                    const createResponse = await fetch('/api/users', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'create',
                            username: 'admin',
                            password: 'admin123',
                            role: 'admin',
                            name: 'Amministratore'
                        })
                    });
                    
                    if (createResponse.ok) {
                        console.log('‚úÖ Utente admin creato');
                    }
                } else {
                    console.log('‚ÑπÔ∏è Utenti gi√† presenti:', users.map(u => u.username));
                }
            } catch (error) {
                // Silenzioso: l'errore √® normale se l'API non √® ancora pronta
                console.warn('‚ö†Ô∏è Impossibile inizializzare utenti:', error.message);
            }
        }
        
        // Login
        async function performLogin() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            const loginButton = document.getElementById('loginButton');
            
            if (!username || !password) {
                alert('Inserisci username e password');
                return;
            }
            
            loginButton.disabled = true;
            loginButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Accesso...';
            
            try {
                const response = await fetch('/api/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'login', username, password })
                });
                
                const data = await response.json();
                
                if (data.success && data.user) {
                    currentUser = data.user;
                    localStorage.setItem('orderFlowCurrentUser', JSON.stringify(currentUser));
                    
                    const loginScreen = document.getElementById('loginScreen');
                    const appContainer = document.getElementById('appContainer');
                    
                    if (loginScreen) loginScreen.style.display = 'none';
                    if (appContainer) appContainer.style.display = 'block';
                    
                    await loadData();
                    updateUI();
                    applyUserPermissions();
                    startClock();
                    
                    // Avvia auto-refresh per sincronizzazione multi-utente
                    startAutoRefresh();
                } else {
                    alert('Credenziali non valide');
                }
            } catch (error) {
                console.error('Login error:', error);
                alert('Errore di connessione al server');
            } finally {
                loginButton.disabled = false;
                loginButton.innerHTML = '<i class="fas fa-sign-in-alt"></i> Accedi';
            }
        }// Reimposta tutti i filtri ai valori predefiniti (mostra tutti gli ordini)
function resetFiltersToDefault() {
    // Stato ‚Üí "Tutti"
    const filterStatus = document.getElementById('filterStatus');
    if (filterStatus) filterStatus.value = 'all';
    
    // Anno/Ruolo ‚Üí "Tutti"
    const filterRoleYear = document.getElementById('filterRoleYear');
    if (filterRoleYear) filterRoleYear.value = '';
    
    // ID minimo / massimo ‚Üí vuoti
    const filterMinId = document.getElementById('filterMinId');
    if (filterMinId) filterMinId.value = '';
    const filterMaxId = document.getElementById('filterMaxId');
    if (filterMaxId) filterMaxId.value = '';
    
    // Taglia, Kit, Articolo, Cliente ‚Üí vuoti
    const searchInput = document.getElementById('searchInput');
    if (searchInput) searchInput.value = '';
    
    const filterSize = document.getElementById('filterSize');
    if (filterSize) filterSize.value = 'all';
    
    const filterKitType = document.getElementById('filterKitType');
    if (filterKitType) filterKitType.value = 'all';
    
    const filterItem = document.getElementById('filterItem');
    if (filterItem) filterItem.value = 'all';
    
    console.log('‚úÖ Filtri reimpostati a "Tutti"');
}
        
        // Logout
        function logout() {
            if (confirm('Sei sicuro di voler uscire?')) {
                localStorage.removeItem('orderFlowCurrentUser');
                location.reload();
            }
        }
        
        // Applica permessi interfaccia
        function applyUserPermissions() {
            if (!currentUser) return;
            
            const role = USER_ROLES[currentUser.role.toUpperCase()] || USER_ROLES.VIEWER;
            const perms = role.permissions;
            
            // Mostra badge utente
            const badge = document.getElementById('userBadge');
            badge.textContent = `${currentUser.name} (${role.name})`;
            badge.classList.remove('hidden');
            
            // Gestione pulsanti header
            document.getElementById('btnUserManagement').classList.toggle('hidden', !perms.manageUsers);
            document.getElementById('btnReset').classList.toggle('hidden', !perms.resetData);
            document.getElementById('btnNuovo').classList.toggle('hidden', !perms.createOrders);
            document.getElementById('btnImportGoogle').classList.toggle('hidden', !perms.importGoogle);
            document.getElementById('btnExportBackup').classList.toggle('hidden', !perms.exportBackup);
            document.getElementById('importExcelContainer').classList.toggle('hidden', !perms.importExcel);
            
            // Pulsante LOG visibile solo per admin
            const btnViewLog = document.getElementById('btnViewLog');
            if (btnViewLog) {
                btnViewLog.classList.toggle('hidden', currentUser.role !== 'admin');
            }
            
            // Nascondi tab in base ai permessi
            const ordiniBtn = document.getElementById('nav-ordini');
            const matrixBtn = document.getElementById('nav-matrix');
            const tabellaBtn = document.getElementById('nav-tabella-ordini');
            
            if (!perms.viewAll) {
                ordiniBtn.classList.add('hidden');
                document.getElementById('tab-ordini').classList.add('hidden');
            }
            if (!perms.viewDistinta) {
                matrixBtn.classList.add('hidden');
                document.getElementById('tab-matrix').classList.add('hidden');
            }
            if (!perms.viewTabella) {
                tabellaBtn.classList.add('hidden');
                document.getElementById('tab-tabella-ordini').classList.add('hidden');
            }
            
            // Se √® TABLE_EDITOR, TABELLA_FULL o TABELLA_READONLY, vai direttamente alla Tabella
            if (currentUser.role === 'table_editor' || currentUser.role === 'tabella_full' || currentUser.role === 'tabella_readonly') {
                setTimeout(() => showTab('tabella-ordini'), 100);
            }
            
            // Nascondi Dashboard se non ha permesso
            const dashboardBtn = document.getElementById('nav-dashboard');
            const dashboardTab = document.getElementById('tab-dashboard');
            if (!perms.viewDashboard) {
                dashboardBtn.classList.add('hidden');
                if (dashboardTab) dashboardTab.classList.add('hidden');
                // Se √® attualmente sulla dashboard, torna a Gestione Ordini
                if (dashboardTab && dashboardTab.classList.contains('active')) {
                    showTab('ordini');
                }
            }
            
            // Mostra Catalogo SOLO per admin
            const catalogoBtn = document.getElementById('nav-catalogo');
            const catalogoTab = document.getElementById('tab-catalogo');
            if (currentUser.role === 'admin') {
                if (catalogoBtn) catalogoBtn.classList.remove('hidden');
            } else {
                if (catalogoBtn) catalogoBtn.classList.add('hidden');
                if (catalogoTab) catalogoTab.classList.add('hidden');
            }
            
            // Nascondi Quick ID filters se non ha permesso
            if (!perms.useQuickIdFilters) {
                const quickIdContainer = document.querySelector('[id="quickIdButtons"]')?.parentElement;
                if (quickIdContainer) {
                    quickIdContainer.style.display = 'none';
                }
            }
            
            // ASSICURA che i filtri siano sempre visibili per TUTTI
            const ensureFiltersVisible = () => {
                // Forza visibilit√† del container principale
                const filtersContainer = document.getElementById('filtersContainer');
                if (filtersContainer) {
                    filtersContainer.style.cssText += 'display: flex !important; visibility: visible !important; opacity: 1 !important; flex-wrap: wrap !important;';
                }
                
                // Forza anche il parent
                const filterSection = document.querySelector('.p-3.border-b.bg-gray-50');
                if (filterSection) {
                    filterSection.style.cssText += 'display: flex !important; visibility: visible !important;';
                }
                
                // Mostra tutti gli elementi di filtro
                const filterIds = ['searchInput', 'sortOrder', 'filterStatus', 'filterRoleYear', 
                                  'filterSize', 'filterKitType', 'filterItem', 'filterMinId', 'filterMaxId'];
                filterIds.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.style.cssText += 'display: inline-block !important; visibility: visible !important; pointer-events: auto !important;';
                        el.disabled = false;
                    }
                });
                
                console.log('‚úÖ Filtri forzati visibili');
            };
            
            // Esegui immediatamente e dopo timeout
            setTimeout(ensureFiltersVisible, 0);
            setTimeout(ensureFiltersVisible, 100);
            setTimeout(ensureFiltersVisible, 500);
            setTimeout(ensureFiltersVisible, 1000);
            setTimeout(ensureFiltersVisible, 2000);
            
            // Aggiungi CSS globale per forzare la visibilit√† dei filtri
            const filterStyle = document.createElement('style');
            filterStyle.id = 'filterVisibilityStyle';
            filterStyle.textContent = `
                /* Forza visibilit√† sezione filtri */
                .p-3.border-b.bg-gray-50 { 
                    display: flex !important; 
                    visibility: visible !important; 
                    opacity: 1 !important; 
                }
                #filtersContainer {
                    display: flex !important;
                    flex-wrap: wrap !important;
                    gap: 0.5rem !important;
                    visibility: visible !important;
                }
                #filtersContainer * {
                    visibility: visible !important;
                }
                /* Forza visibilit√† singoli filtri */
                #searchInput, #sortOrder, #filterStatus, #filterRoleYear, 
                #filterSize, #filterKitType, #filterItem, #filterMinId, #filterMaxId {
                    display: inline-block !important;
                    visibility: visible !important;
                    pointer-events: auto !important;
                    opacity: 1 !important;
                }
            `;
            document.head.appendChild(filterStyle);
            
            // Disabilita campi editabili per utenti senza permessi
            if (!perms.editOrders || !perms.deleteOrders || !perms.downloadGoogleForm) {
                const style = document.createElement('style');
                style.id = 'permissionStyle';
                let css = '';
                if (!perms.editOrders) {
                    // Nascondi solo i pulsanti di configurazione, NON il pulsante "X Capi"
                    css += `
                        button.edit-order-btn:not([onclick*="openItemModal"]) { display: none !important; }
                        td button.edit-order-btn[onclick*="openItemModal"] i.fa-edit { display: none !important; }
                    `;
                }
                if (!perms.deleteOrders) {
                    css += '.delete-order-btn { display: none !important; } ';
                }
                if (!perms.downloadGoogleForm) {
                    // Nascondi pulsanti download Google Form
                    css += '.download-google-form-btn { display: none !important; } ';
                }
                style.textContent = css;
                document.head.appendChild(style);
                
                // Disabilita input campi quando non ha permessi editOrders
                if (!perms.editOrders && !perms.editTabella) {
                    // Lista completa ID filtri da NON disabilitare
                    const filterIds = ['searchInput', 'sortOrder', 'filterStatus', 'filterRoleYear', 
                                      'filterSize', 'filterKitType', 'filterItem', 'filterMinId', 'filterMaxId',
                                      // Filtri Distinta & Magazzino
                                      'matrixMinId', 'matrixMaxId',
                                      // Filtri Tabella Ordini
                                      'tabellaOrdiniMinId', 'tabellaOrdiniMaxId', 'tabellaOrdiniFilterCliente', 'tabellaOrdiniFilterTaglia',
                                      // Filtri Dashboard
                                      'dashboardKitFilter', 'dashboardMinId', 'dashboardMaxId'];
                    
                    // Funzione per disabilitare inputs dopo il render
                    window.disableEditInputs = function() {
                        // Disabilita input taglie, sconto, ecc (MA NON I FILTRI!)
                        document.querySelectorAll('input.edit-order-btn, select.edit-order-btn').forEach(el => {
                            // NON disabilitare i filtri
                            if (filterIds.includes(el.id)) return;
                            
                            el.disabled = true;
                            el.style.backgroundColor = '#f3f4f6';
                            el.style.cursor = 'not-allowed';
                            el.style.color = '#6b7280';
                        });
                        
                        // Disabilita TUTTI gli input e select tranne i filtri
                        document.querySelectorAll('input, select').forEach(el => {
                            // NON disabilitare i filtri per ID
                            if (filterIds.includes(el.id)) return;
                            // NON disabilitare elementi gi√† gestiti o non nella tabella
                            if (el.type === 'button' || el.type === 'submit') return;
                            // NON disabilitare elementi nella sezione "Filtri & Ricerca" (Gestione)
                            if (el.closest('.p-3.border-b.bg-gray-50')) return;
                            // NON disabilitare elementi nelle aree filtri (header delle sezioni)
                            if (el.closest('.flex.items-center.gap-3')) return;
                            if (el.closest('.flex.justify-between.items-center.mb-4')) return;
                            if (el.closest('.no-print')) return;
                            // NON disabilitare select STATO se l'utente ha editStatus
                            if (perms.editStatus && el.classList.contains('status-select')) return;
                            // NON disabilitare Quick ID buttons
                            if (el.closest('#quickIdButtons') || el.closest('#quickIdButtonsMatrix') || el.closest('#quickIdButtonsTabella')) return;
                            
                            // Disabilita solo se √® nella tabella dati (non header/filtri)
                            const isInDataTable = el.closest('tbody') || el.closest('.overflow-x-auto table');
                            if (isInDataTable) {
                                el.disabled = true;
                                el.style.cursor = 'not-allowed';
                                el.style.opacity = '0.6';
                                if (el.tagName === 'INPUT') {
                                    el.style.backgroundColor = '#f3f4f6';
                                    el.style.color = '#6b7280';
                                }
                            }
                        });
                        
                        // Disabilita pulsante "X Capi" ma lascialo visibile
                        document.querySelectorAll('button[onclick*="openItemModal"]').forEach(btn => {
                            if (btn.classList.contains('edit-order-btn')) {
                                btn.disabled = true;
                                btn.style.cursor = 'not-allowed';
                                btn.style.opacity = '0.7';
                                btn.onclick = null; // Rimuovi evento click
                            }
                        });
                    };
                    
                    // Esegui ogni volta che la tabella viene renderizzata
                    const originalRenderTable = window.renderTable;
                    window.renderTable = function() {
                        if (originalRenderTable) originalRenderTable();
                        setTimeout(() => window.disableEditInputs && window.disableEditInputs(), 100);
                    };
                    
                    // Esegui anche dopo renderMatrices per disabilitare giacenze
                    const originalRenderMatrices = window.renderMatrices;
                    window.renderMatrices = function(manualUpdate) {
                        if (originalRenderMatrices) originalRenderMatrices(manualUpdate);
                        setTimeout(() => window.disableEditInputs && window.disableEditInputs(), 100);
                    };
                }
            }
        }
        
        // Gestione utenti (solo admin)
        async function openUserManagement() {
            if (!currentUser || currentUser.role !== 'admin') {
                alert('‚ö†Ô∏è Accesso negato. Solo gli amministratori possono gestire gli utenti.');
                return;
            }
            
            try {
                const response = await fetch('/api/users');
                const data = await response.json();
                const users = data.users || [];
            
            let html = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[9999]" onclick="event.target === this && closeUserManagement()">
                    <div class="bg-white rounded-lg shadow-xl p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                        <div class="flex justify-between items-center mb-4 pb-4 border-b">
                            <h2 class="text-2xl font-bold text-gray-900">
                                <i class="fas fa-users text-indigo-600 mr-2"></i>
                                Gestione Utenti
                            </h2>
                            <button onclick="closeUserManagement()" class="text-gray-400 hover:text-gray-600 text-2xl">‚úï</button>
                        </div>
                        
                        <div class="mb-4">
                            <button onclick="openAddUserForm()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-bold mr-2">
                                <i class="fas fa-user-plus mr-2"></i>Nuovo Utente
                            </button>
                            <button onclick="openActivityLog()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-bold">
                                <i class="fas fa-history mr-2"></i>Visualizza LOG (20 azioni)
                            </button>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase">Username</th>
                                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase">Nome</th>
                                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase">Ruolo</th>
                                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase">Creato il</th>
                                        <th class="px-4 py-3 text-center text-xs font-bold text-gray-500 uppercase">Azioni</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
            `;
            
            users.forEach(user => {
                const role = USER_ROLES[user.role.toUpperCase()] || USER_ROLES.VIEWER;
                const isCurrentUser = user.username === currentUser.username;
                
                html += `
                    <tr class="${isCurrentUser ? 'bg-blue-50' : ''}">
                        <td class="px-4 py-3 text-sm font-bold">${user.username}</td>
                        <td class="px-4 py-3 text-sm">${user.name}</td>
                        <td class="px-4 py-3 text-sm">
                            <span class="px-2 py-1 rounded text-xs font-bold ${
                                user.role === 'admin' ? 'bg-red-100 text-red-800' :
                                user.role === 'viewer_full' ? 'bg-green-100 text-green-800' :
                                user.role === 'contributor' ? 'bg-yellow-100 text-yellow-800' :
                                user.role === 'tabella_full' ? 'bg-cyan-100 text-cyan-800' :
                                user.role === 'tabella_readonly' ? 'bg-purple-100 text-purple-800' :
                                user.role === 'table_editor' ? 'bg-blue-100 text-blue-800' :
                                'bg-gray-100 text-gray-800'
                            }">
                                ${role.name}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-500">${new Date(user.createdAt).toLocaleDateString('it-IT')}</td>
                        <td class="px-4 py-3 text-center">
                            ${isCurrentUser ? `
                                <button onclick="changePassword('${user.username}')" class="text-blue-600 hover:text-blue-800 mx-1" title="Cambia password">
                                    <i class="fas fa-key"></i>
                                </button>
                            ` : `
                                <button onclick="changePassword('${user.username}')" class="text-blue-600 hover:text-blue-800 mx-1" title="Cambia password">
                                    <i class="fas fa-key"></i>
                                </button>
                                <button onclick="editUser('${user.username}')" class="text-orange-600 hover:text-orange-800 mx-1" title="Modifica ruolo">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteUser('${user.username}')" class="text-red-600 hover:text-red-800 mx-1" title="Elimina utente">
                                    <i class="fas fa-trash"></i>
                                </button>
                            `}
                        </td>
                    </tr>
                `;
            });
            
            html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', html);
            } catch (error) {
                console.error('Error loading users:', error);
                alert('Errore nel caricamento degli utenti');
            }
        }
        
        function closeUserManagement() {
            const modal = document.querySelector('.fixed.inset-0');
            if (modal) modal.remove();
        }
        
        function openAddUserForm() {
            const html = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[99999]">
                    <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4">
                        <h3 class="text-xl font-bold mb-4">Crea Nuovo Utente</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-bold mb-1">Username</label>
                                <input type="text" id="newUserUsername" class="w-full border rounded px-3 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-bold mb-1">Nome Completo</label>
                                <input type="text" id="newUserName" class="w-full border rounded px-3 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-bold mb-1">Password</label>
                                <input type="password" id="newUserPassword" class="w-full border rounded px-3 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-bold mb-1">Ruolo</label>
                                <select id="newUserRole" class="w-full border rounded px-3 py-2">
                                    <option value="viewer">Visualizzazione (senza Dashboard)</option>
                                    <option value="viewer_full">Visualizzazione (con Dashboard)</option>
                                    <option value="contributor">Contributore (Google Form)</option>
                                    <option value="contributor_advanced">Contributore Avanzato (Form + Stato)</option>
                                    <option value="table_editor">Editor Tabella (solo Tabella Ordini)</option>
                                    <option value="tabella_full">Tabella Completa</option>
                                    <option value="tabella_readonly">Tabella Solo Lettura</option>
                                    <option value="admin">Amministratore</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex gap-2 mt-6">
                            <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded font-bold">
                                Annulla
                            </button>
                            <button onclick="saveNewUser()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-bold">
                                <i class="fas fa-save mr-2"></i>Salva
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
        }
        
        async function saveNewUser() {
            const username = document.getElementById('newUserUsername').value.trim();
            const name = document.getElementById('newUserName').value.trim();
            const password = document.getElementById('newUserPassword').value;
            const role = document.getElementById('newUserRole').value;
            
            if (!username || !name || !password) {
                alert('‚ö†Ô∏è Compila tutti i campi');
                return;
            }
            
            try {
                const response = await fetch('/api/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'create',
                        username,
                        password,
                        role,
                        name
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    logActivity('CREATE_USER', `Creato nuovo utente: ${username} (${name}) - Ruolo: ${role}`);
                    
                    // Chiudi modals
                    document.querySelectorAll('.fixed.inset-0').forEach(m => m.remove());
                    
                    showQuickNotification('‚úÖ Utente creato con successo!', 'success');
                    openUserManagement();
                } else {
                    alert(`‚ö†Ô∏è ${data.error || 'Errore nella creazione utente'}`);
                }
            } catch (error) {
                console.error('Error creating user:', error);
                alert('Errore di connessione al server');
            }
        }
        
        async function deleteUser(username) {
            if (!confirm(`Sei sicuro di voler eliminare l'utente "${username}"?`)) return;
            
            // Non permettere eliminazione admin corrente
            if (currentUser && currentUser.username === username) {
                alert('‚ö†Ô∏è Non puoi eliminare il tuo stesso account mentre sei loggato!');
                return;
            }
            
            try {
                const response = await fetch('/api/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'delete',
                        username
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    logActivity('DELETE_USER', `Eliminato utente: ${username}`);
                    
                    closeUserManagement();
                    showQuickNotification('‚úÖ Utente eliminato', 'success');
                    openUserManagement();
                } else {
                    alert(`‚ö†Ô∏è ${data.error || 'Errore nell\'eliminazione utente'}`);
                }
            } catch (error) {
                console.error('Error deleting user:', error);
                alert('Errore di connessione al server');
            }
        }
        
        // Modifica ruolo utente
        async function editUser(username) {
            try {
                const response = await fetch('/api/users');
                const data = await response.json();
                const users = data.users || [];
                const user = users.find(u => u.username === username);
            
            if (!user) {
                alert('‚ö†Ô∏è Utente non trovato');
                return;
            }
            
            const html = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[99999]">
                    <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4">
                        <h3 class="text-xl font-bold mb-4">Modifica Utente: ${user.username}</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-bold mb-1">Nome Completo</label>
                                <input type="text" id="editUserName" value="${user.name}" class="w-full border rounded px-3 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-bold mb-1">Ruolo</label>
                                <select id="editUserRole" class="w-full border rounded px-3 py-2">
                                    <option value="viewer" ${user.role === 'viewer' ? 'selected' : ''}>Visualizzazione (senza Dashboard)</option>
                                    <option value="viewer_full" ${user.role === 'viewer_full' ? 'selected' : ''}>Visualizzazione (con Dashboard)</option>
                                    <option value="contributor" ${user.role === 'contributor' ? 'selected' : ''}>Contributore (Google Form)</option>
                                    <option value="contributor_advanced" ${user.role === 'contributor_advanced' ? 'selected' : ''}>Contributore Avanzato (Form + Stato)</option>
                                    <option value="table_editor" ${user.role === 'table_editor' ? 'selected' : ''}>Editor Tabella (solo Tabella Ordini)</option>
                                    <option value="tabella_full" ${user.role === 'tabella_full' ? 'selected' : ''}>Tabella Completa</option>
                                    <option value="tabella_readonly" ${user.role === 'tabella_readonly' ? 'selected' : ''}>Tabella Solo Lettura</option>
                                    <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Amministratore</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex gap-2 mt-6">
                            <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded font-bold">
                                Annulla
                            </button>
                            <button onclick="saveEditUser('${user.username}')" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-bold">
                                <i class="fas fa-save mr-2"></i>Salva
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
            } catch (error) {
                console.error('Error loading user:', error);
                alert('Errore nel caricamento utente');
            }
        }
        
        async function saveEditUser(username) {
            const newName = document.getElementById('editUserName').value.trim();
            const newRole = document.getElementById('editUserRole').value;
            
            if (!newName) {
                alert('‚ö†Ô∏è Il nome √® obbligatorio');
                return;
            }
            
            try {
                const response = await fetch('/api/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'edit',
                        username,
                        name: newName,
                        role: newRole
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    logActivity('EDIT_USER', `Modificato utente: ${username} - Nuovo ruolo: ${newRole}`);
                    
                    // Chiudi modals
                    document.querySelectorAll('.fixed.inset-0').forEach(m => m.remove());
                    
                    showQuickNotification('‚úÖ Utente modificato con successo!', 'success');
                    openUserManagement();
                } else {
                    alert(`‚ö†Ô∏è ${data.error || 'Errore nella modifica utente'}`);
                }
            } catch (error) {
                console.error('Error editing user:', error);
                alert('Errore di connessione al server');
            }
        }
        
        // Cambio password
        function changePassword(username) {
            const html = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[99999]">
                    <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4">
                        <h3 class="text-xl font-bold mb-4">
                            <i class="fas fa-key text-blue-600 mr-2"></i>
                            Cambia Password - ${username}
                        </h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-bold mb-1">Nuova Password</label>
                                <input type="password" id="newPassword1" class="w-full border rounded px-3 py-2" placeholder="Inserisci nuova password">
                            </div>
                            <div>
                                <label class="block text-sm font-bold mb-1">Conferma Password</label>
                                <input type="password" id="newPassword2" class="w-full border rounded px-3 py-2" placeholder="Conferma password">
                            </div>
                        </div>
                        <div class="flex gap-2 mt-6">
                            <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded font-bold">
                                Annulla
                            </button>
                            <button onclick="saveNewPassword('${username}')" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-bold">
                                <i class="fas fa-save mr-2"></i>Salva
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
        }
        
        async function saveNewPassword(username) {
            const pass1 = document.getElementById('newPassword1').value;
            const pass2 = document.getElementById('newPassword2').value;
            
            if (!pass1 || !pass2) {
                alert('‚ö†Ô∏è Compila entrambi i campi');
                return;
            }
            
            if (pass1 !== pass2) {
                alert('‚ö†Ô∏è Le password non coincidono');
                return;
            }
            
            if (pass1.length < 4) {
                alert('‚ö†Ô∏è La password deve essere di almeno 4 caratteri');
                return;
            }
            
            try {
                const response = await fetch('/api/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'update',
                        username,
                        newPassword: pass1
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    logActivity('CHANGE_PASSWORD', `Password modificata per utente: ${username}`);
                    
                    document.querySelectorAll('.fixed.inset-0').forEach(m => m.remove());
                    showQuickNotification('‚úÖ Password aggiornata con successo!', 'success');
                    openUserManagement();
                } else {
                    alert(`‚ö†Ô∏è ${data.error || 'Errore nell\'aggiornamento password'}`);
                }
            } catch (error) {
                console.error('Error updating password:', error);
                alert('Errore di connessione al server');
            }
        }
        
        // ===== SISTEMA CATALOGO =====
        
        // Dati catalogo
        let catalogData = {
            title: 'Catalogo Abbigliamento',
            logo: '',
            qrUrl: '',
            fullCatalogUrl: '',
            items: []
        };
        
        // Carica dati catalogo da Redis
        async function loadCatalogData() {
            try {
                const response = await fetch(`${API_BASE}/data/catalog`);
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.title) {
                        catalogData = data;
                        // Popola i campi
                        document.getElementById('catalogTitle').value = catalogData.title || '';
                        document.getElementById('catalogLogo').value = catalogData.logo || '';
                        document.getElementById('catalogQrUrl').value = catalogData.qrUrl || '';
                        document.getElementById('catalogFullUrl').value = catalogData.fullCatalogUrl || '';
                    }
                }
            } catch (error) {
                console.error('Error loading catalog:', error);
            }
        }
        
        // Salva configurazione catalogo
        async function saveCatalogConfig() {
            catalogData.title = document.getElementById('catalogTitle').value;
            catalogData.logo = document.getElementById('catalogLogo').value;
            catalogData.qrUrl = document.getElementById('catalogQrUrl').value;
            catalogData.fullCatalogUrl = document.getElementById('catalogFullUrl').value;
            
            try {
                const response = await fetch(`${API_BASE}/catalog`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(catalogData)
                });
                
                if (response.ok) {
                    showQuickNotification('Catalogo salvato!', 'success');
                } else {
                    throw new Error('Errore salvataggio');
                }
            } catch (error) {
                console.error('Error saving catalog:', error);
                alert('Errore durante il salvataggio del catalogo');
            }
        }
        
        // Renderizza gli articoli del catalogo
        function renderCatalogItems() {
            loadCatalogData();
            
            const container = document.getElementById('catalogItemsList');
            if (!container) return;
            
            if (!catalogData.items || catalogData.items.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-400 py-8 col-span-full">
                        <i class="fas fa-box-open text-4xl mb-2"></i>
                        <p>Nessun articolo nel catalogo. Clicca "Aggiungi Articolo" o "Importa da DB".</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            catalogData.items.forEach((item, index) => {
                const imagesHtml = item.images && item.images.length > 0 
                    ? item.images.map(img => `<img src="${img}" alt="${item.name}" onclick="openImageLightbox('${img}')">`).join('')
                    : `<div class="catalog-item-placeholder"><i class="fas fa-tshirt text-3xl mb-2"></i><br>${item.name}</div>`;
                
                html += `
                    <div class="catalog-item-card" data-index="${index}">
                        <div class="catalog-item-images">
                            ${imagesHtml}
                        </div>
                        <div class="p-3">
                            <input type="text" value="${item.name || ''}" placeholder="Nome articolo" 
                                class="w-full font-bold text-gray-800 border-b border-transparent hover:border-gray-300 focus:border-blue-500 outline-none mb-2"
                                onchange="updateCatalogItem(${index}, 'name', this.value)">
                            <textarea placeholder="Descrizione o link..." rows="2"
                                class="w-full text-xs text-gray-600 border rounded p-1 resize-none mb-2"
                                onchange="updateCatalogItem(${index}, 'description', this.value)">${item.description || ''}</textarea>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-1">
                                    <span class="text-xs text-gray-500">‚Ç¨</span>
                                    <input type="number" value="${item.price || 0}" 
                                        class="w-16 text-lg font-bold text-green-600 border-b border-transparent hover:border-gray-300 focus:border-blue-500 outline-none"
                                        onchange="updateCatalogItem(${index}, 'price', this.value)">
                                </div>
                                <div class="flex gap-1">
                                    <button onclick="editCatalogItemImages(${index})" class="text-blue-500 hover:text-blue-700 px-2 py-1" title="Gestisci immagini">
                                        <i class="fas fa-images"></i>
                                    </button>
                                    <button onclick="removeCatalogItem(${index})" class="text-red-500 hover:text-red-700 px-2 py-1" title="Rimuovi">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Aggiorna un campo di un articolo
        function updateCatalogItem(index, field, value) {
            if (catalogData.items[index]) {
                catalogData.items[index][field] = field === 'price' ? parseFloat(value) || 0 : value;
            }
        }
        
        // Aggiungi nuovo articolo
        function addCatalogItem() {
            catalogData.items.push({
                name: 'Nuovo Articolo',
                description: '',
                price: 0,
                images: []
            });
            renderCatalogItems();
        }
        
        // Rimuovi articolo
        function removeCatalogItem(index) {
            if (confirm('Sei sicuro di voler rimuovere questo articolo?')) {
                catalogData.items.splice(index, 1);
                renderCatalogItems();
            }
        }
        
        // Gestisci immagini articolo
        function editCatalogItemImages(index) {
            const item = catalogData.items[index];
            const currentImages = (item.images || []).join('\n');
            
            const newImages = prompt(
                'Inserisci gli URL delle immagini (uno per riga, max 3):\n\nEsempio:\nhttps://example.com/img1.jpg\nhttps://example.com/img2.jpg',
                currentImages
            );
            
            if (newImages !== null) {
                item.images = newImages.split('\n').filter(url => url.trim()).slice(0, 3);
                renderCatalogItems();
            }
        }
        
        // Importa articoli dal database
        function importItemsFromDB() {
            if (confirm('Vuoi importare tutti gli articoli dal database? Gli articoli esistenti verranno mantenuti.')) {
                globalItems.forEach(itemName => {
                    // Estrai nome e prezzo
                    const priceMatch = itemName.match(/\((\d+)‚Ç¨\)/);
                    const price = priceMatch ? parseInt(priceMatch[1]) : 0;
                    const name = itemName.replace(/\s*\(\d+‚Ç¨\)\s*$/, '').trim();
                    
                    // Verifica se esiste gi√†
                    const exists = catalogData.items.some(i => i.name === name);
                    if (!exists) {
                        catalogData.items.push({
                            name: name,
                            description: '',
                            price: price,
                            images: []
                        });
                    }
                });
                
                renderCatalogItems();
                showQuickNotification(`Importati ${globalItems.length} articoli dal DB`, 'success');
            }
        }
        
        // Apri anteprima catalogo pubblico
        async function openCatalogPreview() {
            await saveCatalogConfig(); // Salva prima
            window.open('/catalogo.html', '_blank'); // Poi apri anteprima
        }
        
        // Copia link catalogo
        function copyCatalogLink() {
            const publicUrl = window.location.origin + window.location.pathname.replace('index.html', '') + 'catalogo.html';
            navigator.clipboard.writeText(publicUrl).then(() => {
                showQuickNotification('Link copiato negli appunti!', 'success');
            }).catch(() => {
                prompt('Copia questo link:', publicUrl);
            });
        }
        
        // Lightbox per immagini
        function openImageLightbox(imageUrl) {
            const lightbox = document.createElement('div');
            lightbox.className = 'catalog-image-lightbox';
            lightbox.innerHTML = `<img src="${imageUrl}" alt="Immagine ingrandita">`;
            lightbox.onclick = () => lightbox.remove();
            document.body.appendChild(lightbox);
        }
        
        // Aggiorna preview QR
        function updateQrPreview() {
            // Placeholder per futura integrazione QR
        }
        
        // ===== SISTEMA LOG ATTIVIT√Ä =====
        
        // Registra un'azione nello storico CONDIVISO (su Redis)
        async function logActivity(action, details) {
        const ignoredActions = ['SAVE', 'AUTOSAVE', 'Salvataggio dati'];
        if (ignoredActions.includes(action)) return; // <--- se qui c'√® 'Salvataggio dati' NON verr√† mai loggato

        const user = typeof currentUser === 'string'
            ? currentUser
            : (currentUser && currentUser.username) || 'Amministratore';

         try {
            await fetch('/api/logs', {
            method: 'POST',
             headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                user,
                action,
                details,
            timestamp: new Date().toISOString()
            })
         });
        } catch (e) {
         console.warn('Errore caricamento log:', e);
         }
        }

        
        // Mostra lo storico CONDIVISO da Redis
        async function openActivityLog() {
        try {
            const res = await fetch('/api/logs');
            const data = await res.json();
            if (data.logs && data.logs.length > 0) {
        console.log('DEBUG LOGS[0]:', JSON.stringify(data.logs[0], null, 2));
        }

        // AGGIUNGI QUESTO
        console.log('DEBUG LOGS:', data.logs && data.logs[0]);

    if (data.success && data.logs) {
      const logs = data.logs.slice(0, 20); // ultime 20 azioni

      let html = '<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[9999]">';
      html += '<div class="bg-white rounded-lg shadow-xl p-6 max-w-6xl w-full mx-4 max-h-[90vh] overflow-y-auto">';
      html += '<div class="flex justify-between items-center mb-4 pb-4 border-b sticky top-0 bg-white">';
      html += '<h2 class="text-2xl font-bold text-gray-900">';
      html += '<i class="fas fa-history text-blue-600 mr-2"></i>';
      html += 'LOG Attivit√† (Ultime 20 Azioni)';
      html += '</h2>';
      html += "<button onclick=\"this.closest('.fixed').remove()\" class=\"text-gray-400 hover:text-gray-600 ml-2\">";
      html += '<i class="fas fa-times text-2xl"></i>';
      html += '</button>';
      html += '</div>';

      if (logs.length === 0) {
        html += '<p class="text-gray-500 text-center py-8">Nessuna attivit√† registrata</p>';
      } else {
        const actionColors = {
          'CREATE_ORDER': 'bg-green-100 text-green-800',
          'EDIT_ORDER': 'bg-blue-100 text-blue-800',
          'DELETE_ORDER': 'bg-red-100 text-red-800',
          'IMPORT_GOOGLE': 'bg-purple-100 text-purple-800',
          'EXPORT_BACKUP': 'bg-teal-100 text-teal-800',
          'CREATE_USER': 'bg-green-100 text-green-800',
          'DELETE_USER': 'bg-red-100 text-red-800',
          'CHANGE_PASSWORD': 'bg-yellow-100 text-yellow-800',
          'LOGIN': 'bg-blue-100 text-blue-800',
          'RESET_DATA': 'bg-red-100 text-red-800',
          'CHANGESTATUS': 'bg-indigo-100 text-indigo-800'
        };

        html += '<div class="overflow-x-auto">';
        html += '<table class="min-w-full divide-y divide-gray-200">';
        html += '<thead class="bg-gray-50">';
        html += '<tr>';
        html += '<th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase">Data/Ora</th>';
        html += '<th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase">Utente</th>';
        html += '<th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase">Azione</th>';
        html += '<th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase">Descrizione</th>';
        html += '</tr>';
        html += '</thead>';
        html += '<tbody class="bg-white divide-y divide-gray-200">';

        logs.forEach(log => {
        // Leggi il campo data: prova in quest'ordine
        const rawTs = log.timestamp || log.time || log.date || log.createdAt;

        let dateStr = '';
        let timeStr = '';

        if (rawTs) {
         const d = new Date(rawTs);
            if (!isNaN(d.getTime())) {
            dateStr = d.toLocaleDateString('it-IT');
            timeStr = d.toLocaleTimeString('it-IT');
            }
        }

        // Utente come stringa ‚Äúpulita‚Äù
        let userDisplay = '';
        if (typeof log.user === 'string') {
         userDisplay = log.user;
         } else if (log.user && typeof log.user === 'object') {
            userDisplay = log.user.name || log.user.username || 'Amministratore';
        } else {
            userDisplay = 'Amministratore';
        }

        const actionColor = actionColors[log.action] || 'bg-gray-100 text-gray-800';

         html += `
            <tr class="hover:bg-gray-50">
            <td class="px-4 py-3 text-sm text-gray-700">${dateStr} ${timeStr}</td>
            <td class="px-4 py-3 text-sm text-gray-700">${userDisplay}</td>
            <td class="px-4 py-3 text-sm ${actionColor} font-bold rounded">${log.action}</td>
            <td class="px-4 py-3 text-sm text-gray-700">${log.details || ''}</td>
            </tr>`;
        });

        html += '</tbody>';
        html += '</table>';
        html += '</div>';

        html += '<div class="mt-4 pt-4 border-t text-center">';
        html += '<button onclick="clearActivityLog()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded font-bold">';
        html += '<i class="fas fa-trash mr-2"></i>Cancella LOG';
        html += '</button>';
        html += '</div>';
      }

      html += '</div>'; // chiude contenitore bianco
      html += '</div>'; // chiude overlay

      document.body.insertAdjacentHTML('beforeend', html);
    }
  } catch (error) {
    console.error('Errore caricamento log:', error);
    alert('‚ùå Impossibile caricare lo storico delle attivit√†.');
  }
}

async function clearActivityLog() {
  if (!confirm('Sei sicuro di voler cancellare tutto il LOG delle attivit√†?')) return;

  try {
    // per ora usa l'azione 'clear' via POST, come da tuo server
    await fetch('/api/logs', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'clear' })
    });
    document.querySelectorAll('.fixed.inset-0').forEach(m => m.remove());
    showQuickNotification('‚úÖ LOG cancellato', 'success');
  } catch (error) {
    alert('‚ùå Errore durante la cancellazione del log.');
  }
}
        
        async function clearActivityLog() {
    if (!confirm('Sei sicuro di voler cancellare tutto il LOG delle attivit√†?')) return;
    
    try {
        await fetch('/api/logs', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'clear' })
        });
        document.querySelectorAll('.fixed.inset-0').forEach(m => m.remove());
        showQuickNotification('‚úÖ LOG cancellato', 'success');
    } catch (error) {
        alert('‚ùå Errore durante la cancellazione del log.');
    }
}
        
        // ===== FINE SISTEMA LOG =====
        
        // Verifica permessi prima di azioni
        function checkPermission(action) {
            if (!currentUser) return false;
            const role = USER_ROLES[currentUser.role.toUpperCase()] || USER_ROLES.VIEWER;
            return role.permissions[action] === true;
        }
        
        // ===== FINE SISTEMA UTENTI =====
        
        // ===== QUICK ID BUTTONS =====
        
        // Inizializza i Quick ID buttons in TUTTE le sezioni
        function initQuickIdButtons() {
            // Usa la variabile globale quickIdFilters (caricata da Redis)
            
            // IDs dei container in tutte le sezioni
            const containers = [
                'quickIdButtons',        // Gestione Ordini
                'quickIdButtonsMatrix',  // Distinta & Magazzino
                'quickIdButtonsTabella', // Tabella Ordini
                'quickIdButtonsDashboard' // Dashboard
            ];
            
            let html = '';
            for (let i = 1; i <= 15; i++) { // 15 pulsanti
                const filter = quickIdFilters[i];
                const hasConfig = filter && filter.min && filter.max;
                const bgColor = hasConfig ? 'bg-blue-600 hover:bg-blue-700' : 'bg-gray-300 hover:bg-gray-400 cursor-not-allowed';
                const title = hasConfig ? `${filter.min} ‚Üí ${filter.max}` : 'Non configurato';
                
                html += `<button 
                    onclick="applyQuickIdFilter(${i})" 
                    class="${bgColor} text-white px-2 py-1 rounded text-xs font-bold transition min-w-[30px]"
                    title="${title}"
                    ${!hasConfig ? 'disabled' : ''}>
                    ${i}
                </button>`;
            }
            
            // Popola tutti i container
            containers.forEach(id => {
                const container = document.getElementById(id);
                if (container) container.innerHTML = html;
            });
        }
        
        // Applica filtro Quick ID a TUTTE le sezioni
        function applyQuickIdFilter(num) {
            // Usa la variabile globale quickIdFilters (caricata da Redis)
            const filter = quickIdFilters[num];
            
            if (!filter || !filter.min || !filter.max) {
                alert(`‚ö†Ô∏è Il pulsante ${num} non √® configurato.\n\nClicca sul pulsante ‚öôÔ∏è per configurarlo.`);
                return;
            }
            
            // Funzione per trovare l'ID completo che corrisponde al numero
            const findMatchingId = (inputValue, selectElement) => {
                if (!selectElement || !selectElement.options) return inputValue;
                
                // Se √® gi√† un ID completo (es: 2025_068), usalo direttamente
                if (inputValue.includes('_') || inputValue.includes('A_')) {
                    return inputValue;
                }
                
                // Altrimenti √® solo un numero (es: 68), trova l'ID corrispondente
                const targetNum = parseInt(inputValue);
                for (let opt of selectElement.options) {
                    const optValue = opt.value;
                    const match = optValue.match(/(\d+)$/);
                    if (match && parseInt(match[1]) === targetNum) {
                        return optValue;
                    }
                }
                
                return inputValue; // Fallback
            };
            
            // 1. GESTIONE ORDINI
            const filterMinId = document.getElementById('filterMinId');
            const filterMaxId = document.getElementById('filterMaxId');
            if (filterMinId && filterMaxId) {
                const minId = findMatchingId(filter.min, filterMinId);
                const maxId = findMatchingId(filter.max, filterMaxId);
                filterMinId.value = minId;
                filterMaxId.value = maxId;
                renderTable();
            }
            
            // 2. DISTINTA & MAGAZZINO
            const matrixMinId = document.getElementById('matrixMinId');
            const matrixMaxId = document.getElementById('matrixMaxId');
            if (matrixMinId && matrixMaxId) {
                const minId = findMatchingId(filter.min, matrixMinId);
                const maxId = findMatchingId(filter.max, matrixMaxId);
                matrixMinId.value = minId;
                matrixMaxId.value = maxId;
                renderMatrices(true); // IMPORTANTE: true per non resettare i filtri!
            }
            
            // 3. TABELLA ORDINI
            const tabellaMinId = document.getElementById('tabellaOrdiniMinId');
            const tabellaMaxId = document.getElementById('tabellaOrdiniMaxId');
            if (tabellaMinId && tabellaMaxId) {
                // Popola i select se vuoti
                if (tabellaMinId.options.length === 0) {
                    populateTabellaOrdiniFilters();
                }
                const minId = findMatchingId(filter.min, tabellaMinId);
                const maxId = findMatchingId(filter.max, tabellaMaxId);
                tabellaMinId.value = minId;
                tabellaMaxId.value = maxId;
                renderTabellaOrdini();
            }
            
            // 4. DASHBOARD
            const dashboardMinId = document.getElementById('dashboardMinId');
            const dashboardMaxId = document.getElementById('dashboardMaxId');
            if (dashboardMinId && dashboardMaxId) {
                // Popola i select se vuoti
                if (dashboardMinId.options.length === 0) {
                    populateDashboardIdFilters();
                }
                const minId = findMatchingId(filter.min, dashboardMinId);
                const maxId = findMatchingId(filter.max, dashboardMaxId);
                dashboardMinId.value = minId;
                dashboardMaxId.value = maxId;
                // I totali generali non cambiano, aggiorna solo la parte filtrata
                renderChart();
                renderKitAnalysis();
            }
            
            console.log(`‚úÖ Filtro Quick ID ${num} applicato: ${filter.min} ‚Üí ${filter.max}`);
            showQuickNotification(`Filtro ${num}: ${filter.min} ‚Üí ${filter.max}`, 'success');
        }
        
        // Reset filtri ID in tutte le sezioni
        function resetAllIdFilters() {
            // 1. GESTIONE ORDINI - trova primo e ultimo ID
            const filterMinId = document.getElementById('filterMinId');
            const filterMaxId = document.getElementById('filterMaxId');
            if (filterMinId && filterMaxId && filterMinId.options.length > 0) {
                filterMinId.selectedIndex = 0;
                filterMaxId.selectedIndex = filterMaxId.options.length - 1;
                renderTable();
            }
            
            // 2. DISTINTA & MAGAZZINO
            const matrixMinId = document.getElementById('matrixMinId');
            const matrixMaxId = document.getElementById('matrixMaxId');
            if (matrixMinId && matrixMaxId && matrixMinId.options.length > 0) {
                matrixMinId.selectedIndex = 0;
                matrixMaxId.selectedIndex = matrixMaxId.options.length - 1;
                renderMatrices();
            }
            
            // 3. TABELLA ORDINI
            const tabellaMinId = document.getElementById('tabellaOrdiniMinId');
            const tabellaMaxId = document.getElementById('tabellaOrdiniMaxId');
            if (tabellaMinId && tabellaMaxId && tabellaMinId.options.length > 0) {
                tabellaMinId.selectedIndex = 0;
                tabellaMaxId.selectedIndex = tabellaMaxId.options.length - 1;
                renderTabellaOrdini();
            }
            
            showQuickNotification('Filtri ID resettati', 'info');
        }
        
        // Mostra notifica rapida
        function showQuickNotification(message, type = 'success') {
            const colors = {
                success: 'bg-green-600',
                info: 'bg-blue-600',
                warning: 'bg-orange-600',
                error: 'bg-red-600'
            };
            
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 ${colors[type]} text-white px-4 py-2 rounded shadow-lg z-50 transition-opacity`;
            notification.innerHTML = `<i class="fas fa-check mr-2"></i>${message}`;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 2000);
        }
        
        // Apri modal configurazione
        function openQuickIdConfig() {
            // Usa la variabile globale quickIdFilters (caricata da Redis)
            
            let html = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="closeQuickIdConfig()">
                    <div class="bg-white rounded-lg shadow-xl p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                        <div class="flex justify-between items-center mb-4 sticky top-0 bg-white pb-4 border-b">
                            <h2 class="text-xl font-bold text-gray-900">
                                <i class="fas fa-cog text-blue-600 mr-2"></i>
                                Configura Quick ID Filters (1-15)
                            </h2>
                            <button onclick="closeQuickIdConfig()" class="text-gray-400 hover:text-gray-600 text-2xl">
                                ‚úï
                            </button>
                        </div>
                        
                        <p class="text-sm text-gray-600 mb-4">
                            Configura fino a 15 intervalli ID per accesso rapido. Puoi usare solo numeri (es: 69) o ID completi (es: 2025_069).
                        </p>
                        
                        <div class="grid grid-cols-3 gap-4">
            `;
            
            for (let i = 1; i <= 15; i++) { // 15 pulsanti
                const filter = quickIdFilters[i] || {};
                html += `
                    <div class="border rounded p-3 bg-gray-50">
                        <div class="font-bold text-sm mb-2 text-gray-700">
                            <span class="bg-blue-600 text-white px-2 py-1 rounded">${i}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <input 
                                type="text" 
                                id="quickIdMin_${i}" 
                                value="${filter.min || ''}" 
                                placeholder="ID Min"
                                class="text-sm border rounded px-2 py-1 w-full">
                            <span class="text-gray-500">‚Üí</span>
                            <input 
                                type="text" 
                                id="quickIdMax_${i}" 
                                value="${filter.max || ''}" 
                                placeholder="ID Max"
                                class="text-sm border rounded px-2 py-1 w-full">
                        </div>
                    </div>
                `;
            }
            
            html += `
                        </div>
                        
                        <div class="flex justify-end gap-2 mt-6 sticky bottom-0 bg-white pt-4 border-t">
                            <button onclick="closeQuickIdConfig()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded font-bold">
                                Annulla
                            </button>
                            <button onclick="saveQuickIdConfig()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-bold">
                                <i class="fas fa-save mr-2"></i>Salva
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', html);
        }
        
        // Chiudi modal
        function closeQuickIdConfig() {
            const modal = document.querySelector('.fixed.inset-0');
            if (modal) modal.remove();
        }
        
        // Salva configurazione Quick ID su Redis
        async function saveQuickIdConfig() {
            const newFilters = {};
            
            for (let i = 1; i <= 15; i++) { // 15 pulsanti
                const min = document.getElementById(`quickIdMin_${i}`).value.trim();
                const max = document.getElementById(`quickIdMax_${i}`).value.trim();
                
                if (min && max) {
                    newFilters[i] = { min, max };
                }
            }
            
            // Aggiorna la variabile globale
            quickIdFilters = newFilters;
            
            // Salva su Redis tramite saveData()
            await saveData();
            
            closeQuickIdConfig();
            initQuickIdButtons();
            
            const configCount = Object.keys(quickIdFilters).length;
            alert(`‚úÖ Configurazione salvata su server!\n\nüìä ${configCount} pulsanti configurati su 15 disponibili.\n\nüë• Tutti gli utenti vedranno questa configurazione.`);
        }
        
        // Inizializza all'avvio
        initQuickIdButtons();
    </script>
    <!-- Copyright Footer - Fisso in basso -->
    <footer class="no-print" style="position: fixed; bottom: 0; left: 0; right: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #ffffff; padding: 6px 15px; font-size: 9px; z-index: 9999; text-align: center; box-shadow: 0 -2px 8px rgba(0,0,0,0.2);">
        ¬© 2025 Edy Franzoso. Codice sorgente e contenuti protetti ai sensi della Legge sul Diritto d'Autore (L. 633/1941). Riproduzione, distribuzione o modifica vietati senza autorizzazione scritta.
    </footer>
</body>
</html>